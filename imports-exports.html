<!DOCTYPE HTML>
<html lang="en">

	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
				<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
				<link href="https://fonts.googleapis.com/css?family=Doppio+One" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Imports and Exports</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/style2a.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script src='lib/nprogress.js'></script>
			<link rel='stylesheet' href='CSS/nprogress.css'/>
			<script src="lib/w3HTMLinclude.js"></script>

	</head>

	<body>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87476640-1', 'auto');
  ga('send', 'pageview');

</script>
	<div w3-include-html="nav.html"></div>
	<script>
	w3IncludeHTML();
	</script>

		<div class="jumbotron">
			<h1>Which facilities both import and export hazardous waste?</h1>
		</div>

		<div class="col-md-8">
			<div class="col-md-12" id = "map"></div>
			<div class="col-md-12" id='button-container'>
				Show by:
	  			<div class="btn-group" data-toggle="buttons" id="selector">
		            <label class="btn btn-primary active" onClick="setData('kg')"  value="kg" >
		            <input type="radio" checked> Kilograms
		          </label>
		          <label class="btn btn-primary" onClick="setData('l')" value="liters">
		            <input type="radio" > Liters
		          </label>
				</div>
			 </div>
		</div>
		<div class="col-md-4">
				<div class="col-md-12">
				<h5><i>Please note this page may take a while to load. We are working on the issue. </i>Some hazardous waste processing sites in the United States both import and export hazardous waste. Several of these are owned by <a href="imports.html">Clean Harbors</a>, a company known as a leader in the hazardous waste trade industry. As seen on the map, the Great Lakes region of the United States was an active area for both the import and export of hazardous waste in 2007 and 2009-2012.</h5>
				</div>
        		<div class="col-md-12" id="leftLegend"></div>
        </div>
        	<div class="container">
				<div class="col-md-4">
					<div class="col-md-12"><h5>The above map shows hazardous waste importing and exporting <i>sites</i> for 2007 through 2012. Below, you can see a <i>state</i> level view of <div class="definition" style="cursor:help">imports<span class="tooltiptext">Hazardous waste brought into the United States from Canada and/or Mexico in our dataset.</span></div> and <div class="definition" style="cursor:help">exports<span class="tooltiptext">Hazardous waste sent to Canada and/or Mexico from the United States in our dataset.</span></div> for 2012. Some states, such as Wisconsin, Illinois, and Minnesota imported and exported a similar amount while states like Michigan, Arkansas, and California predominantly imported or exported waste for that year. </h5><br>
					</div>
				</div>

				<div class="col-md-8" id="static">
					<div class="col-md-12">
					<img src="img/impexp2012.png" id="stateShipmentsMap" alt="2012 US Imports and exports by state" />
					<br><br><br><br><br>
					</div>
				</div>
			</div>



							<script>
							//global variables
							NProgress.start()
							var svg, zoomer, projection, width100, height100;
							var defaultColor = "#D1D3D4", exDefaultColor = "#4D4D4F"
							var defaultStroke = {"stroke": "#262626", "opacity": 1}
							var zoom = d3.behavior.zoom()
							    .scaleExtent([1, 8])
							    .on("zoom",zoomer);

							var u, b, exp, exp2, leg;
							var tooltip = d3.tip()
							  .attr('class', 'd3-tip')
							  .offset([-5, 0])
							  .html(function(d) {
							    return "<span style='color:white'>" + d.site[0].USExporterSiteName + "<br>imports: "+format(d.imports)+" "+phase.selected+"<br>exports: "+format(d.exports)+" "+phase.selected+"</span>";
							  })
							var flanneryScale;
							var phase = {"selected":""}
							var format = d3.format(",.0f")  ;
							var windowWidth = window.innerWidth
							var smallCircle
							var bigCircle
							var mapScalar
							var mapHeightRatio
							function scaler (){
								if (windowWidth < 500) {
									smallCircle = 4
									bigCircle = 16
									mapScalar = 1.6
									mapHeightRatio = 2
								} else if (windowWidth > 500 && windowWidth < 1500) {
									smallCircle =  9
									bigCircle =  36
									mapScalar = 2
									mapHeightRatio = 1.2
								} else if (windowWidth > 1500) {
									smallCircle =  12
									bigCircle =  48
									mapScalar = 2.1
									mapHeightRatio = 1.1
								}
							}
							scaler()

							//begin script when window loads
							initialize();

							//the first function called once the html is loaded
							function initialize(){

							  height100 =  window.innerHeight/1.25
							  $("#map").height(height100/mapHeightRatio )
							  width100 = $("#map").width()
							  svg = d3.select("#map").append("svg")
							    .attr("id", "mapSVG")
							    .attr("height", height100/mapHeightRatio )
							    .attr("width", width100)
							    .attr("position", "absolute")
							    //.style({"height": height100, "width": width100, "position": "absolute"})

							  //create map projection
							  projection = d3.geo.albers()
							  .center([-1,39])
							  .scale(height100/mapHeightRatio *mapScalar)
							  .translate([(width100)/2, (height100/mapHeightRatio )/2]);

							  setMap()
							  setData("kg");
							}
							function setMap(){
								var path = d3.geo.path()
							    .projection(projection);

							  u = svg.append("g")
							  b = svg.append("g")

							  queue()
							    .defer(d3.json, "data/na.json")
							    .defer(d3.json, "data/borders.json")
							    .await(callback);

							    function callback(error, na, borders){
							      //svg.call(zoom);

							      b.selectAll('path')
							        .data(topojson.feature(borders, borders.objects.borders).features)
							        .enter().append("path")
							          .attr("d", path)
							          .attr("class", "borders")


							      u.selectAll("path")
							        .data(topojson.feature(na, na.objects.na).features)
							        .enter().append("path")
							          .attr("d", path)
							          .attr("class", function (d){
							            return d.properties.gu_a3
							          })
							          .attr("id", function (d){
							            return d.properties.postal
							          })
							    };
							}

							function setData(type){
						      d3.selectAll("path, line, text").remove()
						      setMap()
							  phase.selected = type

							  svg.call(tooltip)



							  d3.csv("data/us-exporters-geocoding.csv", function(ExporterData) {
							    ExporterData.forEach(function(d){
							      d.namer = d.USExporterSiteName
							      d.id = d.id
							      d.latitude = +d.latitude
							      d.longitude = +d.longitude
							      d.export = +d.export
							      d.import = +d.import
							    });


							    //do math to filter
							    d3.csv("data/us-importers-data.csv", function(AllData){
							      AllData.forEach(function(d){
							        d.ReceivingFacilityEPAIDNumber = d.ReceivingFacilityEPAIDNumber
							        d.totalQuantityinShipment = +d.totalQuantityinShipment
							      })

							      d3.csv("data/us-exporters-data.csv", function(exData){
							      exData.forEach(function(d){
							        d.exporterID = d.exporterID
							        d.quantity = +d.quantity
							      })

							        AllData = AllData.filter(function(d){return d.units_final == phase.selected})
							        exData = exData.filter(function(d){return d.units_final == phase.selected})

							         //nest by receiving facility id
							        var exfacilitySum = d3.nest()
							          .key(function(d) { return d.exporterID; }) // EPA ID number
							          .rollup(function(leaves) { return {"total_waste": d3.sum(leaves, function(d) {return d.quantity;})} }) // sum by receiving facility code
							          .map(exData);
							        var facilitySum = d3.nest()
							          .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
							          .rollup(function(leaves) { return {"total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
							          .map(AllData);
							        var keys = d3.keys(facilitySum) //get array of the epaIDs
							        //for x in keys, check if in ExporterData. return ExporterData if
							        //load all export data
							        var data = []
							        for (p=0; p<keys.length; p++){


							          if (exfacilitySum[keys[p]]){
							          data.push({"site": ExporterData.filter(function(d){return d.id == keys[p]}), "exports": exfacilitySum[keys[p]].total_waste, "imports": facilitySum[keys[p]].total_waste})
							          }
							          //add also facilitySum[keys[p]].total_waste
							        }

							    //Imports side (right)
							    max = d3.max(data, function(d){return d.imports})
							    min = d3.min(data, function(d){return d.imports})
							    mean = d3.mean(data, function(d){return d.imports})
							    exmean = d3.mean(data, function(d){return d.exports})
							    exmax = d3.max(data, function(d){return d.exports})
							    exmin = d3.min(data, function(d){return d.exports})

							    var array=[max, mean, min, exmax, exmean, exmin]

							    data.sort(function (a,b){return b.imports - a.imports})

							    var flanMax = calcFlanneryRadius(max);
							    flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

							    var arc = d3.svg.arc()
							    .innerRadius(0)
							   	.startAngle(Math.PI)
							    .endAngle(2*Math.PI)
							    .outerRadius(function(d){console.log(d);return radiusFlannery(d.imports)})


							    exp = svg.append("g")
							    exp.selectAll("arcPath")
							      .data(data)
							      .enter().append("path")
							      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
							      .attr("class", "imp")
							      .attr("id", function(d){return d.id})
							      .style("fill", defaultColor)
							      .style(defaultStroke)
							      .attr("transform", function(d){return "translate(" + projection([d.site[0].longitude, d.site[0].latitude])[0] + "," + projection([d.site[0].longitude, d.site[0].latitude])[1] + ")"})
							     // .attr("x", function(d) {return projection([d.longitude, d.latitude])[0]; })
							      //.attr("y", function(d) { return projection([d.longitude, d.latitude])[1]; })
							      .on("mouseover", function(d){
							        tooltip.show(d);
							      })
							      .on("mouseout", function(d){
							        tooltip.hide(d);
							      })
							      .on('click', function(d){
							        redraw(d);
							      })
							      .attr("d", arc)

							    //Exports side (left)


							    data.sort(function (a,b){return b.exports - a.exports})

							    arc.startAngle(0)
							    .endAngle(Math.PI)
							    .outerRadius(function(d){return radiusFlannery(d.exports)})



							    exp2 = svg.append("g")
							    exp2.selectAll("arcPath2")
							      .data(data)
							      .enter().append("path")
							      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
							      .attr("id", function(d){return d.id})
							      .attr("class", "imp")
							      .style("fill", exDefaultColor)
							      .style(defaultStroke)
							      .attr("transform", function(d){return "translate(" + projection([d.site[0].longitude, d.site[0].latitude])[0] + "," + projection([d.site[0].longitude, d.site[0].latitude])[1] + ")"})
							      .on("mouseover", function(d){
							        tooltip.show(d);
							      })
							      .on("mouseout", function(d){
							        tooltip.hide(d);
							      })
							      .on('click', function(d){
							        redraw(d);
							      })
							      .attr("d", arc)




							width100 = $("#leftLegend").width()
							var scalar = window.innerWidth < 500 ? 3 : 1.5 //scale based on screen size
							var def = window.innerWidth < 500 ? 50 : 100
							$("#leftLegend").height(height100/scalar)

							d3.select("#leftLegend").append("div")
								.attr("class", "legDiv")
								.style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
							var leg = d3.select("#leftLegend").select(".legDiv").append("svg")
								.attr("id", "legSVG")
								.style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})

							var imparc = d3.svg.arc()
							    .innerRadius(0)
							    .outerRadius(function(d){return radiusFlannery(d)})
							    .startAngle(Math.PI)
							    .endAngle(2*Math.PI)
							var exarc = d3.svg.arc()
								.innerRadius(0)
								.startAngle(0)
							    .endAngle(Math.PI)
							    .outerRadius(function(d){return radiusFlannery(d)})
							 var move = radiusFlannery(max) > radiusFlannery(exmax) ? 20 + 3*radiusFlannery(max) : 20 + 2*radiusFlannery(exmax)
							 var thismax = radiusFlannery(max) > radiusFlannery(exmax) ? max : exmax

							leg.selectAll("arcPath")
							    .data(array)
							    .enter()
							    .append("path")
							    //.attr("class", function(d) {return data.parent.name})
							    .style("fill", function(d,i){
							    	var color=i>2 ? exDefaultColor : defaultColor
							    	return color
							    })
						        .style(defaultStroke)
							    .attr("d", function(d,i){
							    	if (i>2){return exarc(d)}else{return imparc(d)}
							    })
						    	.attr("transform", function(d){return "translate(" + 2*radiusFlannery(thismax) + "," + move + ")"})

						    function yScalar (d,i){
						      	return move - radiusFlannery(d)
							  }

						 	var legend = ["Max", "Mean", "Min","Max", "Mean", "Min"]
						 	leg.selectAll("text")
						    .data(array).enter().append('text')
						     .attr("x",  function(d, i){
						     	var side = i<=2 ? 0 : 2*radiusFlannery(thismax) + radiusFlannery(thismax) + 30
						        return side
						      })
						     .attr("y",function(d,i){
						       	return yScalar(d,i)
						       })
						     .text(function (d,i){return legend[i]+": "+format(d)+" "+phase.selected})
					         .attr("class", "legendText")

					       leg.selectAll("circletitle")
						      .data(["Amount of waste: ", "Imported", "Exported"])
						       .enter()
						       .append("text")
						       .text(function(d){return d})
						       .attr("text-anchor", "right")
						       .attr("x", function(d,i){
						       	var side = i<2 ? 0 : 2*radiusFlannery(thismax) + radiusFlannery(thismax) + 30
						       	return side
						       })
						       .attr("y", function(d,i){
						       	var def = 100 - radiusFlannery(thismax)-20
						       	var space = i !=0 ? def + 16 : def
						       	return space
						       })
						       .attr("class", "legendTitle")


						  leg.selectAll("circlelines")
						     	.data(array)
						     	.enter()
						     	.append("line")          // attach a line
							    .style("stroke", "white")  // colour the line
							    .attr("x1", 2*radiusFlannery(thismax))     // x position of the first end of the line
							    .attr("y1",  function(d,i){
							      	//y position should be function of largest radius
							      	return yScalar(d,i)
						      	})    // y position of the first end of the line
							    .attr("x2", function(d,i){
							    	var side = i<=2 ? radiusFlannery(max) : 2*radiusFlannery(thismax) + radiusFlannery(thismax) + 30
						       		return side
							    })     // x position of the second end of the line
							    .attr("y2", function(d,i){
							      	return yScalar(d,i)
						      	}) //y position of the second end of the line



							    })//end export data use
							  });//end work with data
							image()
							})
							/*  svg.append('g').selectAll("rect").data("Click me").enter().append("rect")
							    .attr({"fill": "blue", "width": 20, "height": 20, "x": width100/3, "y": height100/2})
							    .on('click', filter)*/
							};
							 //various helper functions here: calculating flannery's compensation, and svg z-indexing.
							//flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
							var calcFlanneryRadius = function(x, max) {
							  // Flannery Compensation formula as described here:
							  //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
							  // log x * 0.57
							  // anti log
							  var flannery = 0.57;
							  var log = Math.log(x);
							  var r = log * flannery;
							  r = Math.exp(r);
							  return (r);
							};

							var radiusFlannery = function(x) {
							  return flanneryScale(calcFlanneryRadius(x));
							};





						function image(){
							var origW = $("#stateShipmentsMap").width()
							var origH = $("#stateShipmentsMap").height()
							var colW = $("#static").width()
							var ratio = origW/origH
							ratio = isNaN(ratio) ? 1.3 : ratio
							var scalarW = window.innerWidth < 500 ? colW : origW //scale based on screen size
							scalarW = scalarW == 0 ? 721 : scalarW
							scalarH = scalarH == 0 ? scalarW : scalarH
							$("#stateShipmentsMap").width(scalarW)

							var scalarH = window.innerWidth < 500 ? scalarW/ratio : origH //scale based on screen size
							$("#stateShipmentsMap").height(scalarH)
							console.log(colW, origW, scalarW, origH, scalarH, ratio)
						}
						NProgress.done()
					</script>
<div class="container">
    		<div class="col-md-4">
              <h4>Continue to next story:</h4>
        				<div class="thumbnail portfolio-thumbnail center-block" id = "image">
        						<a href = "compliance.html"><img src="img/compliance.png"
        						alt="Imports and Exports"/>
        						 <p class="imgDescription-col4">Are waste processors in compliance?</p>
        						</a>
        				</div>
        		</div>
            <div class="col-md-4">
          		<h4>Back to Story selection:</h4>
          			<div class="thumbnail portfolio-thumbnail center-block" id = "image">
          					<a href = "stories.html"><img src="img/storiesLanding.png"
          					alt="Alberta Tar Sands"/>
          					 <p class="imgDescription-col4">Story selection</p>
          					</a>
          			</div>
          	</div>
          	<div class="col-md-4">
          		<h4>Further exploration:</h4>
          			<div class="thumbnail portfolio-thumbnail center-block" id = "image">
          					<a href = "hmm/index.html" target = "blank"><img src="img/hmmLanding.png"
          					alt="Alberta Tar Sands"/>
          					 <p class="imgDescription-col4">HazMatMapper</p>
          					</a>
          			</div>
  			</div>
          	</div>


<br><br>
<footer class="footer">
		<div w3-include-html="footer.html"></div>
</footer>
	</body>



</html>
