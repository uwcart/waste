<!DOCTYPE HTML>
<html lang="en">
<meta charset="utf-8">
<style>

.chord {
  fill-opacity: .67;
}

</style>
	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
			<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Clean Harbors Shipments</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<!-- <link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css"> -->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
			<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
			<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script type="text/javascript" src="lib/d3-save-svg.min.js"></script>
			<script src='lib/nprogress.js'></script>
			<link rel='stylesheet' href='CSS/nprogress.css'/>
			<script src="lib/w3HTMLinclude.js"></script>
			<!-- <script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script src='lib/nprogress.js'></script>
			<link rel='stylesheet' href='CSS/nprogress.css'/>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script src="lib/w3HTMLinclude.js"></script> -->

	</head>

	<body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87476640-1', 'auto');
  ga('send', 'pageview');

</script>
	<div w3-include-html="nav.html"></div>
	<script>
	w3IncludeHTML();
	</script>
	<div class="center">
		<div class="jumbotron">
				<div class="container">
						<h1>Who Imports Waste into the United States?</h1>
				</div>
		</div>
	</div>
	<div class="container">
		<div class="col-md-12" id = "bodyText"><h4>Tracking the Flows of Waste through Clean Harbors' Sites</h4>
			<div class="text">
			<h5>The transnational company, Clean Harbors, handled over 40% of all shipments of waste imported into the U.S. from 2007-2012. This company <a href="clean-harbors-network.html">moves waste</a> extensively between the United States and Canada. As seen on the map, Clean Harbors does not have a concentration of sites in one geographic area. Instead, they have sites located throughout the United States and Canada. Click on the importers to see where they receive shipments from. The data mapped here does not include transactions conducted by Safety-Kleen, a firm acquired by Clean Harbors in 2012. You can see Clean Harbors's trade network over time <a href="flowCHTime.html">here</a>.
			</h5>
			</div>
			<br><br>
		<div class="container map">
			<div class="col-md-8"></div>
			<div class="col-md-4"></div>
		</div>


		<br><br>
		<div class="container">
			<div class="col-md-12" id = "bodyText"><h4>Clean Harbors Waste Streams 2007-2012</h4>
				<div class="text">
				<h5>Clean Harbors moves a lot of waste between its facilities. This chart shows flows of hazardous waste from one location to another. Most flows are unidirectional, indicative of the fact that the reason Clean Harbors moves waste between facilities is because each specializes in a particular kind of treatment or disposal method. Clean Harbors accounted for <a href='clean-harbors-shipments.html'>40% of the hazardous waste imported to the United States between 2007 and 2012</a>. Specific amounts are shown on the chart.
				</h5>
				</div>
			<!-- <img src="img/CHlogo.jpg" id="CH" alt="Clean Harbors Logo courtesy Clean Harbors.com" /> -->
			</div>
			</div>
			</div>
		</div>

	<script>
						//global variables
						var chordSvg, zoomer, path, projection, width100, height100, globalMin, globalMax, arcGroup, exGlobalMin, exGlobalMax, siteKey, passwordExporter, password
						var defaultColor = "#D1D3D4", exDefaultColor = "#4D4D4F"
						var defaultStroke = {"stroke": "#262626", "opacity": 1}
						var u, b, imp, exp;
						  var tooltip1 = d3.tip()
						  .attr('class', 'd3-tip')
						  .offset([-5, 0])
						  .html(function(d) {
						    return "<span style='color:white'>" + siteKey[d] + "</span>";
						  })

						var flanneryScale;
						var format = d3.format(",.0f")  ;
						//scale stuff
						var smallCircle = window.innerWidth < 500 ? 4 : 8
						var bigCircle = window.innerWidth < 500 ? 16 : 32
						var mapScalar = window.innerWidth < 500 ? .9 : 1.4

						//begin script when window loads
						initialize();

						//the first function called once the html is loaded
						function initialize(){

						  height100 =  window.innerHeight/1.5
						  $(".col-md-8").height(height100)
						  width100 = $(".col-md-8").width()

						  chordSvg = d3.select(".col-md-8").append("svg")
						   .attr("id", "mapSVG")
						   .attr("height", height100)
					    .attr("width", width100)
					    .attr("position", "absolute")
					    //.style({"height": height100, "width": width100, "position": "absolute"})
						  //create map projection
						  projection = d3.geo.albers()
						  .center([-2,40])
						  .scale(height100*mapScalar)
						  .translate([(width100/2.25), (height100/2)]);


						  path = d3.geo.path()
						    .projection(projection);

						  u = chordSvg.append("g")
						  b = chordSvg.append("g")

						  queue()
						    .defer(d3.json, "data/na.json")
						    .defer(d3.json, "data/borders.json")
						    .await(callback);

						    function callback(error, na, borders){
						      b.selectAll('path')
						        .data(topojson.feature(borders, borders.objects.borders).features)
						        .enter().append("path")
						          .attr("d", path)
						          .attr("class", "borders")


						      u.selectAll("path")
						        .data(topojson.feature(na, na.objects.na).features)
						        .enter().append("path")
						          .attr("d", path)
						          .attr("class", function (d){
						            return d.properties.gu_a3
						          })
						          .attr("id", function (d){
						            return d.properties.postal
						          })
						    };
						  setData();
						}

						function setData(){
						  NProgress.start();
						  chordSvg.call(tooltip1)

						  d3.csv("data/dataTest.csv", function(data) {

						    var totalShipments = data.length

						    d3.csv("data/lookup.csv", function(info) {
							  	password = d3.nest()
								  .key(function(d) { return d["ReceivingFacilityEPAIDNumber"] }) // EPA ID number
								  //.rollup(function(leaves) { return {"total_waste": d3.count(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
								  .map(info);
								passwordExporter = d3.nest()
								  .key(function(d) { return d["exporter_key"] }) // EPA ID number
								  //.rollup(function(leaves) { return {"total_waste": d3.count(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
								  .map(info);


						    data = data.filter(function(row){
						      return row["exporter_key"].includes("E53A2583") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E42A0195") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E53A2583") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E43A6647") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E49A4033") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E49A6974") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E42A1378") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E43A0001") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E43A7517") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E45A2109") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E45A0884") && row["company"].includes("CLEAN HARBOR")
						    })

						    var CHShipments = [data.length, (data.length/totalShipments)*100]

						    var exporters = d3.nest() //rollup unique exportlatlongs
						    .key(function(d) {return d.exporter_key;})
						    .rollup(function(leaves) { return {"shipments": leaves.length}})
						    .map(data);

						    var importers = d3.nest() //rollup unique receivinglatlongs
						    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
						    .rollup(function(leaves) { return {"shipments": leaves.length}})
						    .map(data);

						    var nest = d3.nest()
						    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
						    .key(function(d) {return d.exporter_key;})
						    .rollup(function(leaves) { return {"shipments": leaves.length}})
						    .map(data);

						    siteKey={}
							data.forEach(function(d) {
							    siteKey[d.ReceivingFacilityEPAIDNumber] = password[d.ReceivingFacilityEPAIDNumber][0].importer_name+" - "+password[d.ReceivingFacilityEPAIDNumber][0].importer_city+", "+password[d.ReceivingFacilityEPAIDNumber][0].importer_state;
							    siteKey[d.exporter_key] = passwordExporter[d.exporter_key][0].exporter_name+" - "+passwordExporter[d.exporter_key][0].exporter_city+", "+passwordExporter[d.exporter_key][0].exporter_state;
							});




						  var map =d3.values(exporters).map(function(d){return d.shipments})
						  var max = d3.max(map),
						  min = d3.min(map)

						  var items = d3.keys(exporters).map(function(key) {
							    return [key, exporters[key].shipments];
							});
							// Sort the array based on the second element
							items.sort(function(first, second) {
							    return second[1] - first[1];
							});
						var exps = items.map(function(d){return d[0]})

						  exGlobalMax = max
						  exGlobalMin = min

						  var flanMax = calcFlanneryRadius(max);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);


						    exp = chordSvg.append("g")
						    exp.selectAll("circle")
						      .data(exps)
						      .enter().append("circle").attr("class", "circle")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d})
						      .style("fill", exDefaultColor)
						      .style(defaultStroke)
						      .attr("cx", function(d) {return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[0]; })
						      .attr("cy", function(d) { return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[1]; })
						      .on("mouseover", function(d){
						        tooltip1.show(d);
						      })
						      .on("mouseout", function(d){
						        tooltip1.hide(d);
						      })
						    exp.selectAll("circle")
						      .transition()
						      .duration(1000)
						      .attr("r", function(d){return radiusFlannery(exporters[d].shipments)})


						   var map =d3.values(importers).map(function(d){return d.shipments})
						  var max = d3.max(map),
						  min = d3.min(map)

						  var items = d3.keys(importers).map(function(key) {
							    return [key, importers[key].shipments];
							});
							// Sort the array based on the second element
							items.sort(function(first, second) {
							    return second[1] - first[1];
							});
						var imps = items.map(function(d){return d[0]})

						  globalMax = max, globalMin = min

						  var flanMax = calcFlanneryRadius(max);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

						    imp = chordSvg.append("g")
						     arcGroup = chordSvg.append('g');
						    imp.selectAll("circle")
						      .data(imps)
						      .enter().append("circle").attr("class", "circle circleOnMap")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d})
						      .style("fill", defaultColor)
						      .style(defaultStroke)
						      .attr("cx", function(d) {return projection([password[d][0].longitude, password[d][0].latitude])[0]; })
						      .attr("cy", function(d) { return projection([password[d][0].longitude, password[d][0].latitude])[1]; })
						      .on("mouseover", function(d){
						        tooltip1.show(d);
						        highlight(d);
						      })
						      .on("mouseout", function(d){
						        tooltip1.hide(d);
						        dehighlight(d);
						      })
						      .on("click", function(d){
						      	d3.selectAll(".arc").remove();
						        exportThis(d, exporters, nest)
						      })
						    imp.selectAll("circle")
						      .transition()
						      .duration(1000)
						      .attr("r", function(d){return radiusFlannery(importers[d].shipments)})



						  var flanMax = calcFlanneryRadius(globalMax);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

						  var stringwork2 = ["Importers","Exporters"]
						  var circleData = [[globalMax, defaultColor], [globalMin, defaultColor], [exGlobalMax, exDefaultColor], [exGlobalMin, exDefaultColor]]
						  //var circleSpot = [34, 53, 58, 34, 54, 57]

						  var legendKey = ["Max Imports", "Min Imports","Max Exports", "Min Exports"]

							width100 = $(".col-md-4").width()
							//height100=$(".map").height()
							var scalar = window.innerWidth < 500 ? 3 : 2 //scale based on screen size
							$(".col-md-4").height(height100/scalar)
							d3.select(".col-md-4").append("div")
								.attr("class", "legDiv")
								.style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
							var leg = d3.selectAll(".legDiv").append("svg")
								.attr("id", "legSVG")
								.style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})

							 leg.selectAll("circle")
						      .data(circleData)
						      .enter()
						      .append("circle")
						      .style(defaultStroke)
						      //.attr("class", function(d) {return data.parent.name})
						      .style("fill", function(d){return d[1]})
						      .attr("r", function(d){return radiusFlannery(d[0])})
						      .attr("cy", function(d,i){
						      	//y position should be function of largest radius
						      	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
						      	var max = i > 1? exGlobalMax : globalMax
						      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])
						      	var position = i == 0 ? def : otherCirclesPosition
						      	position = i > 1 ? position+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : position
						      	return position
						      })
						      .attr("cx", radiusFlannery(globalMax)+20)

						      function yScalar (d,i){
							 	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
							 	var max = i > 1 ? exGlobalMax : globalMax
						      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])*2
						      	otherCirclesPosition = i > 1 ? otherCirclesPosition+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : otherCirclesPosition
						      	return otherCirclesPosition
							  }

						     leg.selectAll("circletitle")
						      .data(["Number of shipments"])
						       .enter()
						       .append("text")
						       .text(function(d){return d})
						       .attr("text-anchor", "right")
						       .attr("x", 16)
						       .attr("y", 10) // + height100/1.5
						       .attr("class", "legendTitle")


						     leg.selectAll("circletext")
						      .data(circleData)
						       .enter()
						       .append("text")
						       .text(function(d, i){return legendKey[i]+": "+format(d[0])+" shipments"})
						       .attr("text-anchor", "right")
						       .attr("x", radiusFlannery(globalMax)*2+20)
						       .attr("y",function(d,i){
						       	return yScalar(d,i)
						       })
						       .attr("class", "legendText")


						     leg.selectAll("circlelines")
						     	.data(circleData)
						     	.enter()
						     	.append("line")          // attach a line
							    .style("stroke", "black")  // colour the line
							    .attr("x1", radiusFlannery(globalMax)+20)     // x position of the first end of the line
							    .attr("y1",  function(d,i){
							      	//y position should be function of largest radius
							      	return yScalar(d,i)
						      	})    // y position of the first end of the line
							    .attr("x2", radiusFlannery(globalMax)*2+20)     // x position of the second end of the line
							    .attr("y2", function(d,i){
							      	return yScalar(d,i)
						      	}) //y position of the second end of the line




						  leg.selectAll("flowline")
						    .data([globalMin, globalMax])
						    .enter()
						    .append("rect")
						    //.attr("class", function(d) {return data.parent.name})
						    .style("fill", function(d){return "#252525"})
						    .attr("width", 100)
						    .attr("height", function(d,i){if(i==0){return 2}else{return 15}})
						    .attr("y", function(d,i){if(i==0){return radiusFlannery(globalMax)*6} else{return radiusFlannery(globalMax)*6+20}})
						    .attr("x", 16)

						  leg.selectAll("texts")
						    .data([globalMin, globalMax])
						    .enter()
						    .append('text')
						    .attr("x", 16)
						    .attr("y", function(d,i){if(i==0){return radiusFlannery(globalMax)*6 -4} else{return radiusFlannery(globalMax)*6 +16}})
						    .text(function(d, i){if(i==0){return "Minimum # of shipments: "+ globalMin}else{return "Maximum: "+globalMax}})
						    .attr("class", "legendText")
						  });
						})
						NProgress.done()
						};

						function filter() {
						/*   svg.selectAll('circle')
						    .filter(function (d){return d.namer.indexOf("CLEAN HARBOR") == -1}) // >-1
						    .style("fill", "blue")
						    //.remove()
						*/
						}

						function highlight(data){
						  chordSvg.selectAll(".circle")
						    .transition().duration(500)
						    .style({"opacity": ".2"})
						  chordSvg.selectAll("#"+data)
						    .transition().duration(500)
						    .style({"opacity": "1"})
						}

						function dehighlight(data){
						  chordSvg.selectAll(".circle")
						    .transition().duration(500)
						    .style({"opacity": "1"})
						};

						function drawLinesOver(data, base){
						  //var max = d3.max(data, function(d) {return d.total_waste}),
						  //min = d3.min(data, function(d) {return d.total_waste})

						  lineStroke = d3.scale.sqrt()
						    .domain([globalMin, globalMax])
						    .range([2, 15])

						  //based on: http://bl.ocks.org/enoex/6201948

						  var path = d3.geo.path()
						    .projection(projection);

						// --- Helper functions (for tweening the path)
						        var lineTransition = function lineTransition(path) {
						            path.transition()
						                //NOTE: Change this number (in ms) to make lines draw faster or slower
						                .duration(1500)
						                .attrTween("stroke-dasharray", tweenDash)
						                .each("end", function(d,i) {
						                    ////Uncomment following line to re-transition
						                    //d3.select(this).call(transition);

						                    //We might want to do stuff when the line reaches the target,
						                    //  like start the pulsating or add a new point or tell the
						                    //  NSA to listen to this guy's phone calls
						                    //doStuffWhenLineFinishes(d,i);
						                });
						        };
						        var tweenDash = function tweenDash() {
						            //This function is used to animate the dash-array property, which is a
						            //  nice hack that gives us animation along some arbitrary path (in this
						            //  case, makes it look like a line is being drawn from point A to B)
						            var len = this.getTotalLength(),
						                interpolate = d3.interpolateString("0," + len, len + "," + len);

						            return function(t) { return interpolate(t); };
						        };

						base = {"lat": password[base][0].latitude, "long":password[base][0].longitude}
						var links = [];
						for(var i=0, len=data.length; i<len; i++){
						    // (note: loop until length - 1 since we're getting the next
						    //  item with i+1)
						        links.push({
						            type: "LineString",
						            coordinates: [
						                [ data[i].long, data[i].lat ],
						                [ base.long, base.lat ]
						            ],
						            shipments: data[i].shipments
						        });
						    }
						var pathArcs = arcGroup.selectAll("arc")
						            .data(links);

						        //enter
						        var xPosition

        //enter
        pathArcs.enter()
            .append("path").attr({
                'class': 'arc'
            })
            .style({
                fill: 'none',
            })

        //update
            .attr("d", function(d){
            	//http://bl.ocks.org/d3noob/
            	var t = 0
            	var s = 1
		        var dx = projection(d.coordinates[t])[0] - projection(d.coordinates[s])[0],
		            dy = projection(d.coordinates[t])[1] - projection(d.coordinates[s])[1],
		            dr = Math.sqrt(dx * dx + dy * dy);

		        //when click on exporters, coordinates0 is base. click on importers, coordinates 1 is base
		        //calculate sweep flag based on whether x of target is to the right or left of x of source
		        var left = projection(d.coordinates[t])[0] < projection(d.coordinates[s])[0] ? true : false
		        var sweep = left == true ? 1 : 0
		        //Check if previous xposition was close. if so, flip sweep.
/*		        var flip = Math.abs(xPosition - projection(d.coordinates[0])[0]) < 150 ? true : false
		        console.log(flip)
		        if (flip == true && sweep == 0){sweep =1}
		       	else if (flip == true && sweep ==1){sweep = 0}*/

		        xPosition = projection(d.coordinates[t])[0]
		        //sweep = 0
		        return "M" +
		            projection(d.coordinates[0])[0] + "," +
		           projection(d.coordinates[0])[1] + "A" +
		            dr + "," + dr + " 0 0," + sweep + " " +
		            projection(d.coordinates[1])[0] + "," +
		           projection(d.coordinates[1])[1]
            })
						            .style("stroke", "#252525")
						            .attr("class", "arc")
						            .style('stroke-width', function(d) {return lineStroke(d.shipments)})
						                //'stroke-dasharray': '5'
						            .call(lineTransition); //at end of function call positions?
						}
						//various helper functions here: calculating flannery's compensation, and svg z-indexing.
						//flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
						var calcFlanneryRadius = function(x, max) {
						  // Flannery Compensation formula as described here:
						  //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
						  // log x * 0.57
						  // anti log
						  var flannery = 0.57;
						  var log = Math.log(x);
						  var r = log * flannery;
						  r = Math.exp(r);
						  return (r);
						};

						var radiusFlannery = function(x) {
						  return flanneryScale(calcFlanneryRadius(x));
						};

						function exportThis(data, exporters, nest){
						  //console.log(data, latlongs, nest)
						  latlongdump = [];
						  var p = nest[data]
						  var keys = d3.keys(p)
						  for (var k=0; k<keys.length; k++){
						    latlongdump.push({"lat": passwordExporter[keys[k]][0].exporterLAT, "long": passwordExporter[keys[k]][0].exporterLONG, "shipments": nest[data][keys[k]].shipments})
						  }
						  //draw lines between exporters and this site
						  drawLinesOver(latlongdump, data);
						}
					</script>


						<div class="container">
							<div class="col-md-12">
								<script>

								var outerRadius = $(".col-md-12").width() / 4,
								    innerRadius = outerRadius - outerRadius/ 4;

								var phase = {"selected":"kg", "unselected": "l", "kg":{"tick1": 1000000, "tick2": 100}, "l": {"tick1": 10000, "tick2": 100}}
								var format = d3.format(",.0f")  ;

								var fill = d3.scale.category20c();

								var chord = d3.layout.chord()
								    .padding(.04)
								    .sortSubgroups(d3.descending)
								    .sortChords(d3.descending);

								var arc = d3.svg.arc()
								    .innerRadius(innerRadius)
								    .outerRadius(innerRadius + 20);

								 var scale1 = window.innerWidth < 500 ? 3.5 : 2.5
								 var scale2 = window.innerWidth < 500 ? 2 : 1.5
								var svg = d3.select(".col-md-12").append("svg")
								    .attr("width", outerRadius * 4)
								    .attr("height", outerRadius * scale1)
								  .append("g")
								    .attr("transform", "translate(" + outerRadius*1.5 + "," + outerRadius*scale2+ ")");

								var s;

								var tooltip = d3.tip()
								  .attr('class', 'd3-tip')
								  .offset([50, 0])
								  .html(function(d,i) {
								   	return "<span style='color:white'>" + s[d.source.index] + " to "+ s[d.target.index] + ": "+format(d.source.value)+" "+phase.selected
								   	+"<br>"+s[d.target.index]+" to "+s[d.source.index]+": "+format(d.target.value)+" "+phase.selected+"</span>";
								  })

								setdata()

								function setdata(){
									d3.csv("data/clean-harbors-network.csv", function(error, data) {
									  //construct matrix
									  //exporterbyimporter
									  data = data.filter(function(d){return d.units == phase.selected})
									var exporters = d3.nest()
										  .key(function(d) {return d.exporterCity;})
										  .key(function(d) {return d.impCity})
									  	   .rollup(function(leaves) { return {"total_waste": d3.sum(leaves, function(d) {return d.quant;})} })
									  	  .map(data);

									  s = d3.keys(exporters), t=[]
									  for (o=0; o<s.length; o++) {
									  		t[o] = []
									  	for (l=0; l<s.length; l++){
									  		if (exporters[s[o]][s[l]]) {
									  			t[o][l] = exporters[s[o]][s[l]].total_waste
									  		} else {
									  			t[o][l] = 0
									  		}
									  	}
									  }
									  //t[s[o]]=d3.values(exporters[s[o]]).length 	# of sites shipping to

									  var matrix = t

									chord.matrix(matrix);

									svg.call(tooltip)

									svg.append("g").selectAll("path")
									    .data(chord.groups)
									  .enter().append("path")
									    .style("fill", function(d) { return fill(d.index); })
									    .style("stroke", function(d) { return fill(d.index); })
									    .attr("d", arc)
									    .on("mouseover", fade(.1))
									    .on("mouseout", fade(1));

									    var scalar= window.innerWidth < 500 ? 50 : 100
									    var size =window.innerWidth < 500  ? "8px" : "12px"

									  svg.selectAll("text")
									    .data(chord.groups)
									  .enter().append("text")
									      .each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
									      .attr("dy", ".35em")
									      .attr("transform", function(d,i) {
									      	var rotateFactor = s[i]=="BURTON" ? 120 : 90
									        return "rotate(" + (d.angle * 180 / Math.PI - rotateFactor) + ")"
									            + "translate(" + (innerRadius + scalar) + ")"
									            + (d.angle > Math.PI ? "rotate(180)" : "");
									      })
									      .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
									      .text(function(d, i) { return s[i] })
									      .style("font-size", size)

										svg.append("g")
									    	.attr("class", "chord")
									  	.selectAll("path")
									    	.data(chord.chords)
									  	.enter().append("path")
									      //.style("stroke", function(d) { return d3.rgb(fill(d.source.index)).darker(); })
									      .style("fill", function(d) { return fill(d.source.index); })
									      .style("opacity", 1)
									      .attr("d", d3.svg.chord().radius(innerRadius))
									      .on("mouseover", function (d,i){tooltip.show(d, i)})
									      .on("mouseout", function (d,i){tooltip.hide(d, i)});

									  var ticks = svg.append("g").selectAll("g")
									    .data(chord.groups)
									  .enter().append("g").selectAll("g")
									    .data(groupTicks)
									  .enter().append("g")
									    .attr("transform", function(d) {
									      return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
									          + "translate(" + outerRadius/1.25 + ",0)";
									    });

									ticks.append("line")
									    .attr("x1", 1)
									    .attr("y1", 0)
									    .attr("x2", 2)
									    .attr("y2", 0)
									    .style("stroke", "#000");

									ticks.append("text")
									    .attr("x", 0)
									    .attr("dy", ".35em")
									    .attr("transform", function(d) { return d.angle > Math.PI ? "rotate(180)translate(-16)" : null; })
									    .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
									    .text(function(d) { return d.label; })
									    .style("font-size",size)

									// Returns an array of tick angles and labels, given a group.
									function groupTicks(d) {
									  var k = (d.endAngle - d.startAngle) / d.value;
									  return d3.range(0, d.value, phase[phase.selected].tick1).map(function(v, i) {
									    return {
									      angle: v * k + d.startAngle,
									      label: i % 10 ? null : v / phase[phase.selected].tick2 + " " + phase.selected
									    };
									  });
									}

									function fade(opacity) {
									  return function(g, i) {
									    svg.selectAll(".chord path")
									        .filter(function(d) { return d.source.index != i && d.target.index != i; })
									      .transition()
									        .style("opacity", opacity);
									  };
									}

									d3.select(".title").remove()
									d3.select(".col-md-12").append('div')
										.attr('class', 'title')
										.html('<span class="legendTitle">Show by measure: </span>'+"("+phase.selected+")"+" <span class ='phaser'>"+phase.unselected)

										.on('click', function(){
										  var temp = phase.selected
										  phase.selected = phase.unselected
										  phase.unselected = temp
										  svg.selectAll("path, text").remove()
										  setdata()
									     })

								});
								}

								//d3.select(self.frameElement).style("height", outerRadius * 1.5 + "px");

								</script>
							</div>
						</div>
						<script>
							var origW = $("#CH").width()
							var origH = $("#CH").height()
							var colW = $(".col-md-12").width()
							var ratio = origW/origH
							var scalarW = window.innerWidth < 500 ? colW : origW //scale based on screen size
							$("#CH").width(scalarW)


							var scalarH = window.innerWidth < 500 ? scalarW/ratio : origH //scale based on screen size
							$("#CH").height(scalarH)
							console.log(colW, origW, scalarW, origH, scalarH, ratio)
						</script>
						<br><br>

						<div class="container-fluid">
							<div class="col-md-6 map1"></div>
							<div class="col-md-6 map2"></div>
							<div class="col-md-6 map3"></div>
							<div class="col-md-6 map4"></div>
							<div class="col-md-6 map5"></div>
							<div class="col-md-4 leg">
								<!-- <p><input id="dl07"
							      name="downloadButton"
							      type="button"
							      value="Download 2007 Map SVG" />
							    <p>
							    <p><input id="dl09"
							      name="downloadButton"
							      type="button"
							      value="Download 2009 Map SVG" />
							    <p>
							    <p><input id="dl10"
							      name="downloadButton"
							      type="button"
							      value="Download 2010 Map SVG" />
							    <p>
							    <p><input id="dl11"
							      name="downloadButton"
							      type="button"
							      value="Download 2011 Map SVG" />
							    <p>
							    <p><input id="dl12"
							      name="downloadButton"
							      type="button"
							      value="Download 2012 Map SVG" />
							    <p>
							    <p><input id="dl2"
							      name="downloadButton"
							      type="button"
							      value="Download Legend SVG" /> -->
								<!-- <p>Line width:
								<div class="row" id="sliderW">
								  <div id="custom-handleW" class="ui-slider-handle"></div>
								</div> -->
								<p>
							</div>
						</div>
						<script>

											//global variables
											var svg2007, svg2009, svg2010, svg2011, svg2012, zoomer, path, projection, width100, height100, globalMin, globalMean, globalMax, arcGroup07, arcGroup09, arcGroup10, arcGroup11, arcGroup12, exGlobalMin, exGlobalMean, exGlobalMax, siteKey, passwordExporter, password, flowMax, flowMin, pathArcs, leg
											var defaultColor = "#dee0e0", exDefaultColor = "#5a5a5c"
											var defaultStroke = {"stroke": "#262626", "opacity": 1}
											var u, b, imp, exp;
											  var tooltip = d3.tip()
											  .attr('class', 'd3-tip')
											  .offset([-5, 0])
											  .html(function(d) {
											  	console.log(d)
											    return "<span style='color:white'>" + siteKey[d] + "</span>";
											  })

											var flanneryScale;
											var format = d3.format(",.0f")  ;
											//scale stuff
											var smallCircle = window.innerWidth < 500 ? 4 : 8
											var bigCircle = window.innerWidth < 500 ? 16 : 32
											var mapScalar = window.innerWidth < 500 ? .95 : 1.5

											//begin script when window loads
											initialize();

											//the first function called once the html is loaded
											function initialize(){

											  height100 =  window.innerHeight * 0.8
											  $(".map1").height(height100)
											   $(".map2").height(height100)
											    $(".map3").height(height100)
											     $(".map4").height(height100)
											      $(".map5").height(height100)
											  width100 = $(".map1").width()

											  svg2007 = d3.select(".map1").append("svg")
											   .attr("id", "mapSVG1")
											   .attr("height", height100)
										    .attr("width", width100)
										    .attr("position", "absolute")
										    //.style({"height": height100, "width": width100, "position": "absolute"})
											   svg2009 = d3.select(".map2").append("svg")
											   .attr("id", "mapSVG2")
											   .attr("height", height100)
										    .attr("width", width100)
										    .attr("position", "absolute")
										    //.style({"height": height100, "width": width100, "position": "absolute"})
											   svg2010 = d3.select(".map3").append("svg")
											   .attr("id", "mapSVG3")
											   .attr("height", height100)
										    .attr("width", width100)
										    .attr("position", "absolute")
										    //.style({"height": height100, "width": width100, "position": "absolute"})
											   svg2011 = d3.select(".map4").append("svg")
											   .attr("id", "mapSVG4")
											   .attr("height", height100)
										    .attr("width", width100)
										    .attr("position", "absolute")
										    //.style({"height": height100, "width": width100, "position": "absolute"})
											   svg2012 = d3.select(".map5").append("svg")
											   .attr("id", "mapSVG5")
											  .attr("height", height100)
										    .attr("width", width100)
										    .attr("position", "absolute")
										    //.style({"height": height100, "width": width100, "position": "absolute"})

											  //create map projection
											  projection = d3.geo.albers()
											  .center([0,36.5])
											  .scale(height100*mapScalar)
											  .translate([(width100/2), (height100/2)]);


											  path = d3.geo.path()
											    .projection(projection);

											  u07 = svg2007.append("g")
											  c07 = svg2007.append("g")
											  b07 = svg2007.append("g")

											  u09 = svg2009.append("g")
											  c09 = svg2009.append("g")
											  b09 = svg2009.append("g")

											  u10 = svg2010.append("g")
											  c10 = svg2010.append("g")
											  b10 = svg2010.append("g")

											  u11 = svg2011.append("g")
											  c11 = svg2011.append("g")
											  b11 = svg2011.append("g")

											  u12 = svg2012.append("g")
											  c12 = svg2012.append("g")
											  b12 = svg2012.append("g")

											  queue()
											    .defer(d3.json, "data/na.json")
											    .defer(d3.json, "data/ca.json")
											    .defer(d3.json, "data/allBorders.json")
											    .await(callback);

											    function callback(error, na, ca, borders){
											      b07.selectAll('path')
											        .data(topojson.feature(borders, borders.objects.borders).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", "borders")
											          b09.selectAll('path')
											        .data(topojson.feature(borders, borders.objects.borders).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", "borders")
											          b10.selectAll('path')
											        .data(topojson.feature(borders, borders.objects.borders).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", "borders")
											          b11.selectAll('path')
											        .data(topojson.feature(borders, borders.objects.borders).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", "borders")
											          b12.selectAll('path')
											        .data(topojson.feature(borders, borders.objects.borders).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", "borders")
											         // .style({'stroke-dasharray': "60", "stroke-width": "5", "stroke": "white"})

											      c07.selectAll("path")
											        .data(topojson.feature(ca, ca.objects.ca).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", "MEX")
											          c09.selectAll("path")
											        .data(topojson.feature(ca, ca.objects.ca).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", "MEX")
											          c10.selectAll("path")
											        .data(topojson.feature(ca, ca.objects.ca).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", "MEX")
											          c11.selectAll("path")
											        .data(topojson.feature(ca, ca.objects.ca).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", "MEX")
											          c12.selectAll("path")
											        .data(topojson.feature(ca, ca.objects.ca).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", "MEX")

											      u07.selectAll("path")
											        .data(topojson.feature(na, na.objects.na).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", function (d){
											            return d.properties.gu_a3
											          })
											          .attr("id", function (d){
											            return d.properties.postal
											          })
											          u09.selectAll("path")
											        .data(topojson.feature(na, na.objects.na).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", function (d){
											            return d.properties.gu_a3
											          })
											          .attr("id", function (d){
											            return d.properties.postal
											          })
											          u10.selectAll("path")
											        .data(topojson.feature(na, na.objects.na).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", function (d){
											            return d.properties.gu_a3
											          })
											          .attr("id", function (d){
											            return d.properties.postal
											          })
											          u11.selectAll("path")
											        .data(topojson.feature(na, na.objects.na).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", function (d){
											            return d.properties.gu_a3
											          })
											          .attr("id", function (d){
											            return d.properties.postal
											          })
											          u12.selectAll("path")
											        .data(topojson.feature(na, na.objects.na).features)
											        .enter().append("path")
											          .attr("d", path)
											          .attr("class", function (d){
											            return d.properties.gu_a3
											          })
											          .attr("id", function (d){
											            return d.properties.postal
											          })
											    };
											  setData();
											}

											function setData(){
											  svg2007.call(tooltip)
											  svg2009.call(tooltip)
											  svg2010.call(tooltip)
											  svg2011.call(tooltip)
											  svg2012.call(tooltip)

											  d3.csv("data/dataTest.csv", function(data) {

											   	data = data.filter(function(row){
											      return row["exporter_key"].includes("E53A2583") && row["company"].includes("CLEAN HARBOR")
											      || row["exporter_key"].includes("E42A0195") && row["company"].includes("CLEAN HARBOR")
											      || row["exporter_key"].includes("E53A2583") && row["company"].includes("CLEAN HARBOR")
											      || row["exporter_key"].includes("E43A6647") && row["company"].includes("CLEAN HARBOR")
											      || row["exporter_key"].includes("E49A4033") && row["company"].includes("CLEAN HARBOR")
											      || row["exporter_key"].includes("E49A6974") && row["company"].includes("CLEAN HARBOR")
											      || row["exporter_key"].includes("E42A1378") && row["company"].includes("CLEAN HARBOR")
											      || row["exporter_key"].includes("E43A0001") && row["company"].includes("CLEAN HARBOR")
											      || row["exporter_key"].includes("E43A7517") && row["company"].includes("CLEAN HARBOR")
											      || row["exporter_key"].includes("E45A2109") && row["company"].includes("CLEAN HARBOR")
											      || row["exporter_key"].includes("E45A0884") && row["company"].includes("CLEAN HARBOR")
											    })

											   	d3.csv("data/lookup.csv", function(info) {
												  	password = d3.nest()
													  .key(function(d) { return d["ReceivingFacilityEPAIDNumber"] }) // EPA ID number
													  //.rollup(function(leaves) { return {"total_waste": d3.count(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
													  .map(info);
													passwordExporter = d3.nest()
													  .key(function(d) { return d["exporter_key"] }) // EPA ID number
													  //.rollup(function(leaves) { return {"total_waste": d3.count(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
													  .map(info);
													  siteKey={}
												data.forEach(function(d) {
												    siteKey[d.ReceivingFacilityEPAIDNumber] = password[d.ReceivingFacilityEPAIDNumber][0].importer_name+" - "+password[d.ReceivingFacilityEPAIDNumber][0].importer_city+", "+password[d.ReceivingFacilityEPAIDNumber][0].importer_state;
												    siteKey[d.exporter_key] = passwordExporter[d.exporter_key][0].exporter_name+" - "+passwordExporter[d.exporter_key][0].exporter_city+", "+passwordExporter[d.exporter_key][0].exporter_state;
												});
											   	var allYears = d3.nest()
											    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
											    .key(function(d) {return d.exporter_key;})
											    .rollup(function(leaves) { return {"shipments": leaves.length}})
											    .map(data);
											    var year2007 = data.filter(function(d){return d.Year == "2007"})
											    var year2009 = data.filter(function(d){return d.Year == "2009"})
											    var year2010 = data.filter(function(d){return d.Year == "2010"})
											    var year2011 = data.filter(function(d){return d.Year == "2011"})
											    var year2012 = data.filter(function(d){return d.Year == "2012"})

											    var nest07  = d3.nest()
											    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
											    .key(function(d) {return d.exporter_key;})
											    .rollup(function(leaves) { return {"shipments": leaves.length}})
											    .map(year2007);
											    var nest09  = d3.nest()
											    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
											    .key(function(d) {return d.exporter_key;})
											    .rollup(function(leaves) { return {"shipments": leaves.length}})
											    .map(year2009);
											    var nest10  = d3.nest()
											    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
											    .key(function(d) {return d.exporter_key;})
											    .rollup(function(leaves) { return {"shipments": leaves.length}})
											    .map(year2010);
											    var nest11  = d3.nest()
											    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
											    .key(function(d) {return d.exporter_key;})
											    .rollup(function(leaves) { return {"shipments": leaves.length}})
											    .map(year2011);
											    var nest12  = d3.nest()
											    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
											    .key(function(d) {return d.exporter_key;})
											    .rollup(function(leaves) { return {"shipments": leaves.length}})
											    .map(year2012);
											   var exporters = d3.nest() //rollup unique exportlatlongs
											    .key(function(d) {return d.exporter_key;})
											    .key(function(d) {return d.Year})
											    .rollup(function(leaves) { return {"shipments": leaves.length}})
											    .map(data);

											    var importers = d3.nest() //rollup unique receivinglatlongs
											    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
											    .key(function(d) {return d.Year})
											    .rollup(function(leaves) { return {"shipments": leaves.length}})
											    .map(data);

											    //find largest single flow in nest
											   var bigNest = d3.nest()
											    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
											    .key(function(d) {return d.exporter_key;})
											    .key(function(d) {return d.Year})
											    .rollup(function(leaves) { return {"shipments": leaves.length}})
											    .map(data);

											    var dumper = []
											    var nester = d3.values(bigNest)
											    for (var x=0; x<nester.length; x++){
											    	var tempy =d3.values(nester[x])
											    	for (y=0; y<tempy.length; y++){
											    		var years =d3.values(tempy[y])
											    		for (z=0;z<years.length;z++){
											    			dumper.push(years[z].shipments)
											    		}

											    	}
											    }

											    flowMax = d3.max(dumper)
											    flowMin = d3.min(dumper)

											  var dumper = []
											    var nester = d3.values(importers)
											    for (var x=0; x<nester.length; x++){
											    	var tempy =d3.values(nester[x])
											    	for (y=0; y<tempy.length; y++){
											    		dumper.push(tempy[y].shipments)
											    	}
											    }
											   var max = d3.max(dumper),
											  min = d3.min(dumper), mean = d3.mean(dumper)
											 /* var items = d3.keys(exporters).map(function(key) {
												    return [key, exporters[key].shipments];
												});
												// Sort the array based on the second element
												items.sort(function(first, second) {
												    return second[1] - first[1];
												});
											  var exps = items.map(function(d){return d[0]})*/

											  globalMax = max
											  globalMin = min
											  globalMean =mean

											  var flanMax = calcFlanneryRadius(max);
											  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

											  	arcGroup07 = svg2007.append('g');
											    exp07 = svg2007.append("g")
											    imp07 = svg2007.append("g")
											    imps07 = d3.keys(nest07)
											    imp07.selectAll("circle")
											      .data(imps07)
											      .enter().append("circle").attr("class", "circle")
											      .attr("r", function(d){return radiusFlannery(importers[d][2007].shipments)})
											      .style("fill", defaultColor)
											      .style(defaultStroke)
											     .attr("cx", function(d) {return projection([password[d][0].longitude, password[d][0].latitude])[0]; })
											      .attr("cy", function(d) {exportThis(d, exporters, nest07, "07"); return projection([password[d][0].longitude, password[d][0].latitude])[1]; })
											      .on("mouseover", function(d){tooltip.show(d)})
											      .on('mouseout', function(d){tooltip.hide(d)})
											      //exportThis(d, exporters, nest);

											    arcGroup09 = svg2009.append('g');
											    exp09 = svg2009.append("g")
											    imp09 = svg2009.append("g")
											    imps09 = d3.keys(nest09)
											    imp09.selectAll("circle")
											      .data(imps09)
											      .enter().append("circle").attr("class", "circle")
											      .attr("r", function(d){return radiusFlannery(importers[d][2009].shipments)})
											      .style("fill", defaultColor)
											      .style(defaultStroke)
											     .attr("cx", function(d) {return projection([password[d][0].longitude, password[d][0].latitude])[0]; })
											      .attr("cy", function(d) {exportThis(d, exporters, nest09, "09");return projection([password[d][0].longitude, password[d][0].latitude])[1]; })
											      .on("mouseover", function(d){tooltip.show(d)})
											      .on('mouseout', function(d){tooltip.hide(d)})

											    arcGroup10 = svg2010.append('g');
											    exp10= svg2010.append("g")
											    imp10 = svg2010.append("g")
											    imps10= d3.keys(nest10)
											    imp10.selectAll("circle")
											      .data(imps10)
											      .enter().append("circle").attr("class", "circle")
											      .attr("r", function(d){return radiusFlannery(importers[d][2010].shipments)})
											      .style("fill", defaultColor)
											      .style(defaultStroke)
											     .attr("cx", function(d) {return projection([password[d][0].longitude, password[d][0].latitude])[0]; })
											      .attr("cy", function(d) {exportThis(d, exporters, nest10, "10");return projection([password[d][0].longitude, password[d][0].latitude])[1]; })
											      .on("mouseover", function(d){tooltip.show(d)})
											      .on('mouseout', function(d){tooltip.hide(d)})

											   arcGroup11 = svg2011.append('g');
											    exp11 = svg2011.append("g")
											    imp11 = svg2011.append("g")
											    imps11 = d3.keys(nest11)
											    imp11.selectAll("circle")
											      .data(imps11)
											      .enter().append("circle").attr("class", "circle")
											      .attr("r", function(d){return radiusFlannery(importers[d][2011].shipments)})
											      .style("fill", defaultColor)
											      .style(defaultStroke)
											     .attr("cx", function(d) {return projection([password[d][0].longitude, password[d][0].latitude])[0]; })
											      .attr("cy", function(d) {exportThis(d, exporters, nest11, "11");return projection([password[d][0].longitude, password[d][0].latitude])[1]; })
											      .on("mouseover", function(d){tooltip.show(d)})
											      .on('mouseout', function(d){tooltip.hide(d)})


											   arcGroup12 = svg2012.append('g');
											    exp12 = svg2012.append("g")
											    imp12 = svg2012.append("g")
											    imps12 = d3.keys(nest12)
											    imp12.selectAll("circle")
											      .data(imps12)
											      .enter().append("circle").attr("class", "circle")
											      .attr("r", function(d){return radiusFlannery(importers[d][2012].shipments)})
											      .style("fill", defaultColor)
											      .style(defaultStroke)
											     .attr("cx", function(d) {return projection([password[d][0].longitude, password[d][0].latitude])[0]; })
											      .attr("cy", function(d) {exportThis(d, exporters, nest12, "12");return projection([password[d][0].longitude, password[d][0].latitude])[1]; })
											      .on("mouseover", function(d){tooltip.show(d)})
											      .on('mouseout', function(d){tooltip.hide(d)})


											    //EXPORTERS
											   var dumper = []
											    var nester = d3.values(exporters)
											    for (var x=0; x<nester.length; x++){
											    	var tempy =d3.values(nester[x])
											    	for (y=0; y<tempy.length; y++){
											    		dumper.push(tempy[y].shipments)
											    	}
											    }
											   var max = d3.max(dumper),
											  min = d3.min(dumper), mean = d3.mean(dumper)

											  exGlobalMax = max
											  exGlobalMin = min
											  exGlobalMean=mean



											  exps07 = d3.values(nest07)
											  var dump=[]
											  exps07.forEach(function(d){
											  	var x = d3.keys(d)
											  	x.forEach(function(e){
											  		dump[e]=e
											  	})
											  })
											  exps07=d3.keys(dump)
											    exp07.selectAll("circle")
											      .data(exps07)
											      .enter().append("circle").attr("class", "circle")
											      .attr("r", function(d){return radiusFlannery(exporters[d][2007].shipments)})
											      .style("fill", exDefaultColor)
											      .style(defaultStroke)
											    .attr("cx", function(d) {return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[0]; })
											      .attr("cy", function(d) { return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[1]; })
											      .on("mouseover", function(d){tooltip.show(d)})
											      .on('mouseout', function(d){tooltip.hide(d)})

											  var year07 = svg2007.append("g")
											  year07.selectAll("text")
											  .data(["2007"]).enter().append("text").text(function(d){return d}).attr("font-size", "18")
											  .attr("x",2).attr("y", 18)

											  exps09 = d3.values(nest09)
											  var dump=[]
											  exps09.forEach(function(d){
											  	var x = d3.keys(d)
											  	x.forEach(function(e){
											  		dump[e]=e
											  	})
											  })
											  exps09=d3.keys(dump)
											    exp09.selectAll("circle")
											      .data(exps09)
											      .enter().append("circle").attr("class", "circle")
											      .attr("r", function(d){return radiusFlannery(exporters[d][2009].shipments)})
											      .style("fill", exDefaultColor)
											      .style(defaultStroke)
											    .attr("cx", function(d) {return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[0]; })
											      .attr("cy", function(d) { return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[1]; })
											      .on("mouseover", function(d){tooltip.show(d)})
											      .on('mouseout', function(d){tooltip.hide(d)})

											  var year09 = svg2009.append("g")
											  year09.selectAll("text")
											  .data(["2009"]).enter().append("text").text(function(d){return d}).attr("font-size", "18")
											  .attr("x",2).attr("y", 18)


											       exps10 = d3.values(nest10)
											  var dump=[]
											  exps10.forEach(function(d){
											  	var x = d3.keys(d)
											  	x.forEach(function(e){
											  		dump[e]=e
											  	})
											  })
											  exps10=d3.keys(dump)
											    exp10.selectAll("circle")
											      .data(exps10)
											      .enter().append("circle").attr("class", "circle")
											      .attr("r", function(d){return radiusFlannery(exporters[d][2010].shipments)})
											      .style("fill", exDefaultColor)
											      .style(defaultStroke)
											    .attr("cx", function(d) {return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[0]; })
											      .attr("cy", function(d) { return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[1]; })
											      .on("mouseover", function(d){tooltip.show(d)})
											      .on('mouseout', function(d){tooltip.hide(d)})

											    var year10 = svg2010.append("g")
											  year10.selectAll("text")
											  .data(["2010"]).enter().append("text").text(function(d){return d}).attr("font-size", "18")
											  .attr("x",2).attr("y", 18)

					 						exps11 = d3.values(nest11)
											  var dump=[]
											  exps11.forEach(function(d){
											  	var x = d3.keys(d)
											  	x.forEach(function(e){
											  		dump[e]=e
											  	})
											  })
											  exps11=d3.keys(dump)
											    exp11.selectAll("circle")
											      .data(exps11)
											      .enter().append("circle").attr("class", "circle")
											      .attr("r", function(d){return radiusFlannery(exporters[d][2011].shipments)})
											      .style("fill", exDefaultColor)
											      .style(defaultStroke)
											    .attr("cx", function(d) {return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[0]; })
											      .attr("cy", function(d) { return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[1]; })
											      .on("mouseover", function(d){tooltip.show(d)})
											      .on('mouseout', function(d){tooltip.hide(d)})

											 var year11 = svg2011.append("g")
											  year11.selectAll("text")
											  .data(["2011"]).enter().append("text").text(function(d){return d}).attr("font-size", "18")
											  .attr("x",2).attr("y", 18)

											       exps12 = d3.values(nest12)
											  var dump=[]
											  exps12.forEach(function(d){
											  	var x = d3.keys(d)
											  	x.forEach(function(e){
											  		dump[e]=e
											  	})
											  })
											  exps12=d3.keys(dump)
											    exp12.selectAll("circle")
											      .data(exps12)
											      .enter().append("circle").attr("class", "circle")
											      .attr("r", function(d){console.log(exporters[d][2012].shipments);return radiusFlannery(exporters[d][2012].shipments)})
											      .style("fill", exDefaultColor)
											      .style(defaultStroke)
											    .attr("cx", function(d) {return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[0]; })
											      .attr("cy", function(d) { return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[1]; })
											      .on("mouseover", function(d){tooltip.show(d)})
											      .on('mouseout', function(d){tooltip.hide(d)})

											      var year12 = svg2012.append("g")
											  year12.selectAll("text")
											  .data(["2012"]).enter().append("text").text(function(d){return d}).attr("font-size", "18")
											  .attr("x",2).attr("y", 18)

											     //LEGEND
											     var flanMax = calcFlanneryRadius(globalMax);
											  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

											  var stringwork2 = ["Importers","Exporters"]
											  var circleData = [[globalMax, defaultColor], [globalMean, defaultColor], [globalMin, defaultColor], [exGlobalMax, exDefaultColor], [exGlobalMean, exDefaultColor], [exGlobalMin, exDefaultColor]]
											  //var circleSpot = [34, 53, 58, 34, 54, 57]

											  var legendKey = ["Max Imports in a single year", "Mean", "Min","Max exports in a single year", "Mean", "Min"]

												width100 = $(".leg").width()
												//height100=$(".map").height()
												var scalar = window.innerWidth < 500 ? 3 : 2 //scale based on screen size
												$(".leg").height(height100/scalar)
												d3.select(".leg").append("div")
													.attr("class", "legDiv")
													.style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
												leg = d3.selectAll(".legDiv").append("svg")
													.attr("id", "legSVG")
													.style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})

												 leg.selectAll("circle")
											      .data(circleData)
											      .enter()
											      .append("circle")
											      .style(defaultStroke)
											      //.attr("class", function(d) {return data.parent.name})
											      .style("fill", function(d){return d[1]})
											      .attr("r", function(d){return radiusFlannery(d[0])})
											      .attr("cy", function(d,i){
											      	//y position should be function of largest radius
											      	var def = window.innerWidth < 500 ? 35 : 90 //scale based on screen size
											      	var max = i > 2? exGlobalMax : globalMax
											      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])
											      	var position = i == 0 ? def : otherCirclesPosition
											      	position = i > 2 ? position+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : position
											      	return position
											      })
											      .attr("cx", radiusFlannery(globalMax)+20)

											      function yScalar (d,i){
												 	var def = window.innerWidth < 500 ? 35 : 90 //scale based on screen size
												 	var max = i > 2 ? exGlobalMax : globalMax
											      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])*2
											      	otherCirclesPosition = i > 2 ? otherCirclesPosition+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : otherCirclesPosition
											      	return otherCirclesPosition
												  }

											     leg.selectAll("circletitle")
											      .data(["Number of shipments"])
											       .enter()
											       .append("text")
											       .text(function(d){return d})
											       .attr("text-anchor", "right")
											       .attr("x", 16)
											       .attr("y", 15) // + height100/1.5
											       .attr("class", "legendTitle")



											     //here, replace circleData with biggest individual shipment
											     leg.selectAll("circletext")
											      .data(circleData)
											       .enter()
											       .append("text")
											       .text(function(d, i){return legendKey[i]+": "+format(d[0])+" shipments"})
											       .attr("text-anchor", "right")
											       .attr("x", radiusFlannery(globalMax)*2+20)
											       .attr("y",function(d,i){
											       	return yScalar(d,i)
											       })
											       .attr("class", "legendText")


											     leg.selectAll("circlelines")
											     	.data(circleData)
											     	.enter()
											     	.append("line")          // attach a line
												    .style("stroke", "black")  // colour the line
												    .attr("x1", radiusFlannery(globalMax)+20)     // x position of the first end of the line
												    .attr("y1",  function(d,i){
												      	//y position should be function of largest radius
												      	return yScalar(d,i)
											      	})    // y position of the first end of the line
												    .attr("x2", radiusFlannery(globalMax)*2+20)     // x position of the second end of the line
												    .attr("y2", function(d,i){
												      	return yScalar(d,i)
											      	}) //y position of the second end of the line




												  leg.selectAll("flowline")
												    .data([flowMin, flowMax])
												    .enter()
												    .append("rect")
												    //.attr("class", function(d) {return data.parent.name})
												    .style("fill", function(d){return "#252525"})
												    .attr("width", 100)
												    .attr("height", function(d,i){if(i==0){return 2}else{return 14}})
												    .attr("y", function(d,i){if(i==0){return radiusFlannery(globalMax)*8} else{return radiusFlannery(globalMax)*8+20}})
												    .attr("x", 16)

												  leg.selectAll("texts")
												   .data([flowMin, flowMax])
												    .enter()
												    .append('text')
												    .attr("x", 16)
												    .attr("y", function(d,i){if(i==0){return radiusFlannery(globalMax)*8 -4} else{return radiusFlannery(globalMax)*8+16}})
												    .text(function(d, i){if(i==0){return "Minimum # of shipments: "+ flowMin}else{return "Maximum: "+flowMax}})
												    .attr("class", "legendText")

					/*
											  var map =d3.values(importers).map(function(d){return d.shipments})
											  var max = d3.max(map),
											  min = d3.min(map), mean = d3.mean(map)

											  var items = d3.keys(importers).map(function(key) {
												    return [key, importers[key].shipments];
												});
												// Sort the array based on the second element
												items.sort(function(first, second) {
												    return second[1] - first[1];
												});
											  var imps = items.map(function(d){return d[0]})

											  globalMax = max, globalMin = min, globalMean = mean

											  var flanMax = calcFlanneryRadius(max);
											  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);


											    imp.selectAll("circle")
											      .data(imps)
											      .enter().append("circle").attr("class", "circle circleOnMap")
											      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
											      .attr("id", function(d){return d})
											      .style("fill", defaultColor)
											      .style(defaultStroke)
											      .style("fill-opacity", function(d){
											      	if (d == "CAD008302903" || d == "ARD069748192" || d == "MID074259565" || d == "MID005338801" || d == "MID980991566"){return 1} else {return .2}
											      })
											      .style("stroke-opacity", function(d){
											      	if (d == "CAD008302903" || d == "ARD069748192" || d == "MID074259565" || d == "MID005338801" || d == "MID980991566"){return 1} else {return .2}
											      })
											       .attr("cx", function(d) {return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[0]; })
											      .attr("cy", function(d) { return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[1]; })

											      .on("click", function(d){
											      	d3.selectAll(".arc").remove();
											        //exportThis(d, exporters, nest)
											      })
											      .on("mouseover", function(d){console.log(d)})
											    imp.selectAll("circle")
											      .transition()
											      .duration(1000)
											      .attr("r", function(d){return radiusFlannery(importers[d].shipments)})



											  var flanMax = calcFlanneryRadius(globalMax);
											  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

											  var stringwork2 = ["Importers","Exporters"]
											  var circleData = [[globalMax, defaultColor], [globalMean, defaultColor], [globalMin, defaultColor], [exGlobalMax, exDefaultColor], [exGlobalMean, exDefaultColor], [exGlobalMin, exDefaultColor]]
											  //var circleSpot = [34, 53, 58, 34, 54, 57]

											  var legendKey = ["Max Imports", "Mean Imports", "Min Imports","Max Exports", "Mean Exports", "Min Exports"]

												width100 = $(".leg").width()
												//height100=$(".map").height()
												var scalar = window.innerWidth < 500 ? 3 : 2 //scale based on screen size
												$(".leg").height(height100/scalar)
												d3.select(".leg").append("div")
													.attr("class", "legDiv")
													.style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
												leg = d3.selectAll(".legDiv").append("svg")
													.attr("id", "legSVG")
													.style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})

												 leg.selectAll("circle")
											      .data(circleData)
											      .enter()
											      .append("circle")
											      .style(defaultStroke)
											      //.attr("class", function(d) {return data.parent.name})
											      .style("fill", function(d){return d[1]})
											      .attr("r", function(d){return radiusFlannery(d[0])})
											      .attr("cy", function(d,i){
											      	//y position should be function of largest radius
											      	var def = window.innerWidth < 500 ? 35 : 90 //scale based on screen size
											      	var max = i > 2? exGlobalMax : globalMax
											      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])
											      	var position = i == 0 ? def : otherCirclesPosition
											      	position = i > 2 ? position+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : position
											      	return position
											      })
											      .attr("cx", radiusFlannery(globalMax)+20)

											      function yScalar (d,i){
												 	var def = window.innerWidth < 500 ? 35 : 90 //scale based on screen size
												 	var max = i > 2 ? exGlobalMax : globalMax
											      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])*2
											      	otherCirclesPosition = i > 2 ? otherCirclesPosition+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : otherCirclesPosition
											      	return otherCirclesPosition
												  }

											     leg.selectAll("circletitle")
											      .data(["Number of shipments"])
											       .enter()
											       .append("text")
											       .text(function(d){return d})
											       .attr("text-anchor", "right")
											       .attr("x", 16)
											       .attr("y", 15) // + height100/1.5
											       .attr("class", "legendTitle")



											     //here, replace circleData with biggest individual shipment
											     leg.selectAll("circletext")
											      .data(circleData)
											       .enter()
											       .append("text")
											       .text(function(d, i){return legendKey[i]+": "+format(d[0])+" shipments"})
											       .attr("text-anchor", "right")
											       .attr("x", radiusFlannery(globalMax)*2+20)
											       .attr("y",function(d,i){
											       	return yScalar(d,i)
											       })
											       .attr("class", "legendText")


											     leg.selectAll("circlelines")
											     	.data(circleData)
											     	.enter()
											     	.append("line")          // attach a line
												    .style("stroke", "black")  // colour the line
												    .attr("x1", radiusFlannery(globalMax)+20)     // x position of the first end of the line
												    .attr("y1",  function(d,i){
												      	//y position should be function of largest radius
												      	return yScalar(d,i)
											      	})    // y position of the first end of the line
												    .attr("x2", radiusFlannery(globalMax)*2+20)     // x position of the second end of the line
												    .attr("y2", function(d,i){
												      	return yScalar(d,i)
											      	}) //y position of the second end of the line




												  leg.selectAll("flowline")
												    .data([0])//.data([flowMin, flowMax])
												    .enter()
												    .append("rect")
												    //.attr("class", function(d) {return data.parent.name})
												    .style("fill", function(d){return "#252525"})
												    .attr("width", 100)
												    .attr("height", function(d,i){return 3})				//if(i==0){return 2}else{return 14}})
												    .attr("y", function(d,i){if(i==0){return radiusFlannery(globalMax)*6} else{return radiusFlannery(globalMax)*6+20}})
												    .attr("x", 16)

												  leg.selectAll("texts")
												    .data([0])//.data([flowMin, flowMax])
												    .enter()
												    .append('text')
												    .attr("x", 16)
												    .attr("y", function(d,i){if(i==0){return radiusFlannery(globalMax)*6 -4} else{return radiusFlannery(globalMax)*6 +16}})
												    .text("Shipments between sites")
												    //.text(function(d, i){if(i==0){return "Minimum # of shipments: "+ flowMin}else{return "Maximum: "+flowMax}})
												    .attr("class", "legendText")*/
											  });
											})

											};


											function drawLinesOver(data, base, year){
											  //see all possible scales here: https://github.com/d3/d3-3.x-api-reference/blob/master/Quantitative-Scales.md

											  lineStroke = d3.scale.sqrt()  //.linear()	//pow().exponent(3)
											    .domain([flowMin, flowMax])
											    .range([2, 14])

											  //based on: http://bl.ocks.org/enoex/6201948

											  var path = d3.geo.path()
											    .projection(projection);

											// --- Helper functions (for tweening the path)
											        var lineTransition = function lineTransition(path) {
											            path.transition()
											                //NOTE: Change this number (in ms) to make lines draw faster or slower
											                .duration(1500)
											                .attrTween("stroke-dasharray", tweenDash)
											                .each("end", function(d,i) {
											                    ////Uncomment following line to re-transition
											                    //d3.select(this).call(transition);

											                    //We might want to do stuff when the line reaches the target,
											                    //  like start the pulsating or add a new point or tell the
											                    //  NSA to listen to this guy's phone calls
											                    //doStuffWhenLineFinishes(d,i);
											                });
											        };
											        var tweenDash = function tweenDash() {
											            //This function is used to animate the dash-array property, which is a
											            //  nice hack that gives us animation along some arbitrary path (in this
											            //  case, makes it look like a line is being drawn from point A to B)
											            var len = this.getTotalLength(),
											                interpolate = d3.interpolateString("0," + len, len + "," + len);

											            return function(t) { return interpolate(t); };
											        };
											var baseID = base
											base = {"lat": password[base][0].latitude, "long":password[base][0].longitude}
											var links = [];

											for(var i=0, len=data.length; i<len; i++){
											    // (note: loop until length - 1 since we're getting the next
											    //  item with i+1)

											        links.push({
											            type: "LineString",
											            coordinates: [
											                [ data[i].long, data[i].lat ],
											                [ base.long, base.lat ]
											            ],
											            shipments: data[i].shipments,
											            exporterID: data[i].id,
											            exporterName: data[i].name
											        });
											    }
											    var yearkey={"07": arcGroup07, "09": arcGroup09, "10": arcGroup10, "11": arcGroup11, "12": arcGroup12}
											pathArcs = yearkey[year].selectAll("arc")
											            .data(links);

									        //enter
									        var xPosition

									        //enter
									        pathArcs.enter()
									            .append("path").attr({
									                'class': 'arc'
									            })
									            .style({
									                fill: 'none',
									            })

									        //update
									            .attr("d", function(d){
									            	//http://bl.ocks.org/d3noob/

									            	var t = 0
									            	var s = 1
											        var dx = projection(d.coordinates[t])[0] - projection(d.coordinates[s])[0],
											            dy = projection(d.coordinates[t])[1] - projection(d.coordinates[s])[1],
											            dr = Math.sqrt(dx * dx + dy * dy);

											        //when click on exporters, coordinates0 is base. click on importers, coordinates 1 is base
											        //calculate sweep flag based on whether x of target is to the right or left of x of source
											        var left = projection(d.coordinates[t])[0] < projection(d.coordinates[s])[0] ? true : false
											        var sweep = left == true ? 1 : 0
											        //Check if previous xposition was close. if so, flip sweep.
											        var flip = Math.abs(xPosition - projection(d.coordinates[0])[0]) < 150 ? true : false
											        if (flip == true && sweep == 0){sweep =1}
											       	else if (flip == true && sweep ==1){sweep = 0}
											        if (d.shipments == 292 || d.shipments == 317 || d.shipments == 55) {console.log(flip, sweep); flip=true; sweep=1}
											    	//if (baseID == "TXD055141378" && d.shipments == 47) {console.log(flip, sweep)}
											        xPosition = projection(d.coordinates[t])[0]
											        //sweep = 0
											        return "M" +
											            projection(d.coordinates[0])[0] + "," +
											           projection(d.coordinates[0])[1] + "A" +
											            dr + "," + dr + " 0 0," + sweep + " " +
											            projection(d.coordinates[1])[0] + "," +
											           projection(d.coordinates[1])[1]
									            })
									            .style("stroke", "black") //#929292
									            .attr("class", "arc")
									            .style('stroke-width', function(d) {return lineStroke(d.shipments)})
									            /*.style("stroke-opacity", function(d){
									            	if (baseID == "CAD008302903" || baseID == "ARD069748192" || baseID == "MID074259565" || baseID == "MID005338801" || baseID == "MID980991566" || d.exporterID == "E56A2957" || d.exporterID == "E56A2533" || d.exporterID == "E51A7093" || d.exporterID == "E51A0774" || d.exporterID == "E50A2187" || d.exporterID == "E52A7723" || d.exporterID == "E53A2583" || d.exporterID == "E53A9394"|| d.exporterID == "E53A2295"){return 1} else {return .1}
									            })*/
									                //'stroke-dasharray': '5'
									            .call(lineTransition) //at end of function call positions?
									            .on("mouseover", function(d){console.log(d)})
												}

											//various helper functions here: calculating flannery's compensation, and svg z-indexing.

											d3.select('#dl07').on('click', function() {
										      var config = {
										        filename: 'flowSVG07',
										      }
										      d3_save_svg.save(d3.select('#mapSVG1').node(), config);
										    });
										    						d3.select('#dl09').on('click', function() {
										      var config = {
										        filename: 'flowSVG09',
										      }
										      d3_save_svg.save(d3.select('#mapSVG2').node(), config);
										    });
										    												d3.select('#dl10').on('click', function() {
										      var config = {
										        filename: 'flowSVG10',
										      }
										      d3_save_svg.save(d3.select('#mapSVG3').node(), config);
										    });
										    																		d3.select('#dl11').on('click', function() {
										      var config = {
										        filename: 'flowSVG11',
										      }
										      d3_save_svg.save(d3.select('#mapSVG4').node(), config);
										    });
										    																								d3.select('#dl12').on('click', function() {
										      var config = {
										        filename: 'flowSVG12',
										      }
										      d3_save_svg.save(d3.select('#mapSVG5').node(), config);
										    });
										    d3.select('#dl2').on('click', function() {
										      var config2 = {
										        filename: 'legSVG',
										      }
										      d3_save_svg.save(d3.select('#legSVG').node(), config2);
										    });

											//flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
											var calcFlanneryRadius = function(x, max) {
											  // Flannery Compensation formula as described here:
											  //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
											  // log x * 0.57
											  // anti log
											  var flannery = 0.57;
											  var log = Math.log(x);
											  var r = log * flannery;
											  r = Math.exp(r);
											  return (r);
											};

											var radiusFlannery = function(x) {
											  return flanneryScale(calcFlanneryRadius(x));
											};

											function exportThis(data, exporters, nest, year){
											  latlongdump = [];
											  var p = nest[data]
											  var keys = d3.keys(p)
											  for (var k=0; k<keys.length; k++){
											    latlongdump.push({"lat": passwordExporter[keys[k]][0].exporterLAT, "long": passwordExporter[keys[k]][0].exporterLONG, "shipments": nest[data][keys[k]].shipments, "id": passwordExporter[keys[k]][0].exporter_key, "name": passwordExporter[keys[k]][0].exporter_name})
											  }
											  //draw lines between exporters and this site

											  drawLinesOver(latlongdump, data, year);
											}
											var handle = $( "#custom-handle" );
										    $( "#slider" ).slider({
										   		min: 0,
										      max: 100,
										      value: 100,
										      create: function() {
										        handle.text( $( this ).slider( "value" ) );
										      },
										      slide: function( event, ui ) {
										        handle.text( ui.value );
										        console.log(pathArcs)
										       // svg.selectAll(".arc").style("stroke-opacity", ui.value/100)
										        //change other things here
										      }
										    });
										    /*var handleW = $( "#custom-handleW" );
										    $( "#sliderW" ).slider({
										   		min: 1,
										      max: 12,
										      value: 6,
										      create: function() {
										        handleW.text( $( this ).slider( "value" ) );
										      },
										      slide: function( event, ui ) {
										        handleW.text( ui.value );
										        svg.selectAll(".arc").style("stroke-width", ui.value)
										        //change other things here
										      }
										    });*/

										</script>

										<div class="container">
											<div class="col-md-12" id = "bodyText"><h4><br><br>Clean Harbors: One Company, Many Sites</h4>
												<h5> The series of maps above shows the growth of the <a href="http://geography.wisc.edu/hazardouswaste/clean-harbors-network.html">Clean Harbors import network</a> from 2007 and 2009-2012 as shipments that go from one Clean Harbors facility to another. While hazardous waste is traded between countries, it often stays <a href="http://geography.wisc.edu/hazardouswaste/clean-harbors-shipments.html">within the same company</a>, so the infrastructures for processing and transporting waste are interconnected. This complicates questions of environmental justice, which is more frequently understood as a subnational or international problem.
												</h5>
											</div>
										</div><br>

					<footer class="footer">
						<!-- <div class="container"> -->
							<div class="logos">
							<a href = "http://geography.wisc.edu" target="blank"><img src="img/uwgeog-01.png" alt="UW Geography Logo" hspace="10"></a>
							<a href = "https://www.nsf.gov/" target="blank"><img src="img/nsf-01-01.png" alt="NSF Logo" hspace="10"></a>
							<a href = "http://www.geography.wisc.edu/cartography/" target="blank"><img src="img/uwcart-01-01.png" alt="uwcart Logo" hspace="10"></a>
							</div>
						<!-- </div> -->
					</footer>
	</body>


</html>
