<!DOCTYPE html>
<meta charset="utf-8">
<style>

.chord {
  fill-opacity: .67;
}

</style>
<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
      	<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Clean Harbors Network</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script src="lib/w3HTMLinclude.js"></script>

	</head>

	<body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87476640-1', 'auto');
  ga('send', 'pageview');

</script>
	<div w3-include-html="nav.html"></div>
	<script>
	w3IncludeHTML();
	</script>

	<div class="center">
		<div class="jumbotron">
				<div class="container">
						<h1>Where Does Clean Harbors Waste Go?</h1>
				</div>
		</div>
	</div>

		<div class="container">
			<div class="col-md-12">
				<script>

				var outerRadius = $(".col-md-12").width() / 3,
				    innerRadius = outerRadius - outerRadius/3;

				var phase = {"selected":"kg", "unselected": "l", "kg":{"tick1": 1000000, "tick2": 100}, "l": {"tick1": 10000, "tick2": 100}}
				var format = d3.format(",.0f")  ;

				var fill = d3.scale.category20c();

				var chord = d3.layout.chord()
				    .padding(.04)
				    .sortSubgroups(d3.descending)
				    .sortChords(d3.descending);

				var arc = d3.svg.arc()
				    .innerRadius(innerRadius)
				    .outerRadius(innerRadius + 20);

				 var scale1 = window.innerWidth < 500 ? 3.5 : 2.5
				 var scale2 = window.innerWidth < 500 ? 2 : 1.5
				var svg = d3.select(".col-md-12").append("svg")
				    .attr("width", outerRadius * 4)
				    .attr("height", outerRadius * scale1)
				  .append("g")
				    .attr("transform", "translate(" + outerRadius*1.5 + "," + outerRadius*scale2+ ")");

				var s;

				var tooltip = d3.tip()
				  .attr('class', 'd3-tip')
				  .offset([50, 0])
				  .html(function(d,i) {
				   	return "<span style='color:white'>" + s[d.source.index] + " to "+ s[d.target.index] + ": "+format(d.source.value)+" "+phase.selected
				   	+"<br>"+s[d.target.index]+" to "+s[d.source.index]+": "+format(d.target.value)+" "+phase.selected+"</span>";
				  })

				setdata()

				function setdata(){
					d3.csv("data/clean-harbors-network.csv", function(error, data) {
					  //construct matrix
					  //exporterbyimporter
					  data = data.filter(function(d){return d.units == phase.selected})
					var exporters = d3.nest()
						  .key(function(d) {return d.exporterCity;})
						  .key(function(d) {return d.impCity})
					  	   .rollup(function(leaves) { return {"total_waste": d3.sum(leaves, function(d) {return d.quant;})} })
					  	  .map(data);

					  s = d3.keys(exporters), t=[]
					  for (o=0; o<s.length; o++) {
					  		t[o] = []
					  	for (l=0; l<s.length; l++){
					  		if (exporters[s[o]][s[l]]) {
					  			t[o][l] = exporters[s[o]][s[l]].total_waste
					  		} else {
					  			t[o][l] = 0
					  		}
					  	}
					  }
					  //t[s[o]]=d3.values(exporters[s[o]]).length 	# of sites shipping to

					  var matrix = t

					chord.matrix(matrix);

					svg.call(tooltip)

					svg.append("g").selectAll("path")
					    .data(chord.groups)
					  .enter().append("path")
					    .style("fill", function(d) { return fill(d.index); })
					    .style("stroke", function(d) { return fill(d.index); })
					    .attr("d", arc)
					    .on("mouseover", fade(.1))
					    .on("mouseout", fade(1));

					    var scalar= window.innerWidth < 500 ? 50 : 100
					    var size =window.innerWidth < 500  ? "8px" : "12px"

					  svg.selectAll("text")
					    .data(chord.groups)
					  .enter().append("text")
					      .each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
					      .attr("dy", ".35em")
					      .attr("transform", function(d,i) {
					      	var rotateFactor = s[i]=="BURTON" ? 120 : 90
					        return "rotate(" + (d.angle * 180 / Math.PI - rotateFactor) + ")"
					            + "translate(" + (innerRadius + scalar) + ")"
					            + (d.angle > Math.PI ? "rotate(180)" : "");
					      })
					      .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
					      .text(function(d, i) { return s[i] })
					      .style("font-size", size)

						svg.append("g")
					    	.attr("class", "chord")
					  	.selectAll("path")
					    	.data(chord.chords)
					  	.enter().append("path")
					      //.style("stroke", function(d) { return d3.rgb(fill(d.source.index)).darker(); })
					      .style("fill", function(d) { return fill(d.source.index); })
					      .style("opacity", 1)
					      .attr("d", d3.svg.chord().radius(innerRadius))
					      .on("mouseover", function (d,i){tooltip.show(d, i)})
					      .on("mouseout", function (d,i){tooltip.hide(d, i)});

					  var ticks = svg.append("g").selectAll("g")
					    .data(chord.groups)
					  .enter().append("g").selectAll("g")
					    .data(groupTicks)
					  .enter().append("g")
					    .attr("transform", function(d) {
					      return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
					          + "translate(" + outerRadius/1.25 + ",0)";
					    });

					ticks.append("line")
					    .attr("x1", 1)
					    .attr("y1", 0)
					    .attr("x2", 2)
					    .attr("y2", 0)
					    .style("stroke", "#000");

					ticks.append("text")
					    .attr("x", 0)
					    .attr("dy", ".35em")
					    .attr("transform", function(d) { return d.angle > Math.PI ? "rotate(180)translate(-16)" : null; })
					    .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
					    .text(function(d) { return d.label; })
					    .style("font-size",size)

					// Returns an array of tick angles and labels, given a group.
					function groupTicks(d) {
					  var k = (d.endAngle - d.startAngle) / d.value;
					  return d3.range(0, d.value, phase[phase.selected].tick1).map(function(v, i) {
					    return {
					      angle: v * k + d.startAngle,
					      label: i % 10 ? null : v / phase[phase.selected].tick2 + " " + phase.selected
					    };
					  });
					}

					function fade(opacity) {
					  return function(g, i) {
					    svg.selectAll(".chord path")
					        .filter(function(d) { return d.source.index != i && d.target.index != i; })
					      .transition()
					        .style("opacity", opacity);
					  };
					}

					d3.select(".title").remove()
					d3.select(".col-md-12").append('div')
						.attr('class', 'title')
						.html('<span class="legendTitle">Show by measure: </span>'+"("+phase.selected+")"+" <span class ='phaser'>"+phase.unselected)

						.on('click', function(){
						  var temp = phase.selected
						  phase.selected = phase.unselected
						  phase.unselected = temp
						  svg.selectAll("path, text").remove()
						  setdata()
					     })

				});
				}

				//d3.select(self.frameElement).style("height", outerRadius * 1.5 + "px");

				</script>
			</div>
		</div>
		<div class="container">
			<div class="col-md-12" id = "bodyText"><h4>Clean Harbors Waste Streams 2007-2012</h4>
        <div class="text">
				<h5>Clean Harbors moves a lot of waste between its facilities. This chart shows flows of hazardous waste from one location to another. Most flows are unidirectional, indicative of the fact that the reason Clean Harbors moves waste between facilities is because each specializes in a particular kind of treatment or disposal method. Clean Harbors accounted for <a href='clean-harbors-shipments.html'>40% of the hazardous waste imported to the United States between 2007 and 2012</a>. Specific amounts are shown on the chart.
				</h5>
        </div>
			<br>
      <img src="img/CHlogo.jpg" id="CH" alt="Clean Harbors Logo courtesy Clean Harbors.com" />
      <br><br>
			</div>

		</div>
	<script>
		var origW = $("#CH").width()
		var origH = $("#CH").height()
		var colW = $(".col-md-12").width()
		var ratio = origW/origH
		var scalarW = window.innerWidth < 500 ? colW : origW //scale based on screen size
		$("#CH").width(scalarW)


		var scalarH = window.innerWidth < 500 ? scalarW/ratio : origH //scale based on screen size
		$("#CH").height(scalarH)
		console.log(colW, origW, scalarW, origH, scalarH, ratio)
	</script>
  <footer class="footer">
    <!-- <div class="container"> -->
      <div class="logos">
      <img src="img/uwgeog-01.png" alt="UW Geography Logo" hspace="10">
      <img src="img/nsf-01-01.png" alt="NSF Logo" hspace="10">
      <img src="img/uwcart-01-01.png" alt="uwcart Logo" hspace="10">
      </div>
    <!-- </div> -->
  </footer>

	</body>


</html>
