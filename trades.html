<!DOCTYPE html>
<meta charset="utf-8">
<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
      	<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Doppio+One" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Which companies trade hazardous waste?</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style2a.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script src="lib/w3HTMLinclude.js"></script>

	</head>

	<body>

  <style>
	.nodetext {
	  fill: white;
	  stroke-width: 1.5px;
	}
	circle:hover{
		cursor: pointer;
	}
	line.link {
		stroke:grey;
	  stroke-opacity: .6;
	}
	line:hover{
		cursor: pointer;
	}
	#trades{
		cursor: move;
		border: 1px solid white;
	}
  </style>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87476640-1', 'auto');
  ga('send', 'pageview');

</script>	
	<div w3-include-html="nav.html"></div>
	<script>
	w3IncludeHTML();
	</script>

		<div class="jumbotron">
			<h1>Which companies trade hazardous waste?</h1>
		</div>

		<div class="col-md-8">
				<div class="col-md-12" id="trades-image"></div><br> <br>
		</div>
		<div class="col-md-4" >
			<div class="col-md-12" id = "bodyText"></div>
			      <!-- <h4>Network Analysis of Hazardous Waste Shipments, 2007-2012</h4> -->
			      <h5>This force-directed graph shows the companies involved in the hazardous waste trade found in our dataset as shipments from 2007 and 2009-2012. Companies that trade with one another are clustered together, with unrelated companies located farther from the respective cluster. There are large clusters around Clean Harbors, Veolia, U.S. Ecology, and World Resources Company. These companies were identified as key companies in the hazardous waste trade, with <a href="imports.html">Clean Harbors</a> being the most involved.
		      	 </h5>
		    	 <br> 
	    	<div class="col-md-12" id = "leftLegend"></div>
   		</div>

				<script>
					var scale;
					var graph;
					var vis;
					var format = d3.format(",.0f")  ;
					var tooltip = d3.tip()
					  .attr('class', 'd3-tip')
					  .offset([0, 0])
					  .html(function(d, indicator, total) {
					  	
					  	if (indicator == "link"){
					  		return "<span style='color:white'>" + d.source.name + " sent "+ d.value + " shipments to "+ d.target.name +"</span>";
					  	} else{
					  		return "<span style='color:white'>" + d.name + " handled "+ total + " shipments</span>";
					  		
					  	}
					    
					  })
					var windowWidth = window.innerWidth
					var smallCircle 
					var bigCircle 
					var mapScalar 
					var mapHeightRatio
					function scaler (){
						if (windowWidth < 500) {
							smallCircle = 4 
							bigCircle = 16 
							mapScalar = 1.6 
							mapHeightRatio = 2
						} else if (windowWidth > 500 && windowWidth < 1500) {
							smallCircle =  9
							bigCircle =  36
							mapScalar = 2.1
							mapHeightRatio = 1.3
						} else if (windowWidth > 1500) {
							smallCircle =  12
							bigCircle =  48
							mapScalar = 2.1
							mapHeightRatio = 1.1
						}
					}
					scaler()

					var h = window.innerHeight/1.25,
						w = $("#trades-image").width(),
					    fill = d3.scale.category20();
					$("#trades-image").height(h/mapHeightRatio )

					vis = d3.select("#trades-image")
					  .append("svg:svg")
					    .attr("width", w)
					    .attr("id","trades")
					    .attr("height", h/mapHeightRatio)
					    .attr("pointer-events", "all")
					  .append('svg:g')
					    .call(d3.behavior.zoom().on("zoom", redraw))
					  .append('svg:g');

					  vis.append('svg:rect')
					    .attr('width', w)
					    .attr('height', h/mapHeightRatio)
					    .attr('fill', 'none');

					vis.call(tooltip)

					function redraw() {
												vis.attr("transform",
						      "translate(" + d3.event.translate + ")"
						      + " scale(" + d3.event.scale + ")");
						
					}
					
					var file="data/trades11-12.json";


					d3.json(file, function(json) {

					  var force = d3.layout.force()
					  	  .gravity(.05)
					  	  .friction(0)
					      .charge(-300)
					      .linkDistance(250)
					      .nodes(json.nodes)
					      .links(json.links)
					      .size([w, h])
					      .start();

					  var link = vis.selectAll("line.link")
					      .data(json.links)
					    .enter().append("svg:line")
					      .attr("class", "link")
					      .style("stroke-width", 1)
					      .attr("x1", function(d) { return d.source.x; })
					      .attr("y1", function(d) { return d.source.y; })
					      .attr("x2", function(d) { return d.target.x; })
					      .attr("y2", function(d) { return d.target.y; })
					      .on("mouseover", function(d){tooltip.show(d, "link")})
					      .on('mouseout', function(d){tooltip.hide(d, "link")})

					   var key = {}, dump=[], counter = 0

					   d3.csv("data/2011-2012 trades.csv", function(allData){


				    	json.nodes.forEach(function(d){
				    		var nom = d.name
				    		counter = 0
				    		allData.forEach(function(shipment){
							  	if (nom == shipment.exporter || nom == shipment.importer){
							  		counter += 1
							  	}
				  			})
				  			dump.push(counter)
				  			key[nom] = counter
					    })
					 	var sum = allData.length
					  var max = d3.max(dump)
					  var min = d3.min(dump)
					  var median = d3.median(dump)
					  var mean = d3.mean(dump)
					  var scale = d3.scale.sqrt().range([1,30]).domain([min, max])

					  var node = vis.selectAll("g.node")
					      .data(json.nodes)
					    .enter().append("svg:g")
					      .attr("class", "node")
					  	node.append("svg:circle")
					      .attr("r", function(d) {
					      	var nom = d.name
					      	var total = key[nom]
					      	return scale(total)
					      	//Math.sqrt(d.weight)
					      })
					      .style("fill", function(d) {return fill(d.group); })
					      .style({"stroke": "white", "stroke-width": ".5px"})
					      .on("mouseover", function(d){
					      	var nom = d.name
					      	var total = key[nom]
					      	tooltip.show(d, "node", total)
					      })
					      .on('mouseout', function(d){tooltip.hide(d, "node")})
					      .call(force.drag)

					  

					  /* var tri = vis.selectAll("line.tri")
					      .data(json.links)
					    .enter().append("svg:rect")
					      .attr("class", "tri")
					      .style("fill", "black")
					      .attr("x", function(d) { return d.target.x; })
					      .attr("y", function(d) { return d.target.y; })
					      .attr("width", 3)
					      .attr("height", 3)*/

					  force.on("tick", function() {
					    link.attr("x1", function(d) { return d.source.x; })
					        .attr("y1", function(d) { return d.source.y; })
					        .attr("x2", function(d) { return d.target.x; })
					        .attr("y2", function(d) { return d.target.y; });

					    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

					   // tri.attr("x", function(d) { return d.target.x; })
					   // tri.attr("y", function(d) { return d.target.y; });
					  graph = json;
					  });
					  node.append("svg:text")
					    .attr("class", "nodetext")
					    .attr("dx", 0)
						.attr("dy", 0)
						.style("font-size", function(d){
							var size = Math.sqrt(key[d.name])*2
							if (size > 50){return size*2+"%"} else {return 0}
						 	}) //(75/d.weight)
						.text(function(d) { return prettify(d.name); })


							var shipsArray = [max, mean, min]
							width100 = $("#leftLegend").width()
							var scalar = window.innerWidth < 500 ? 2 : 2 //scale based on screen size
							var def = window.innerWidth < 500 ? 40 : 70
							$("#leftLegend").height(h/scalar)

							d3.select("#leftLegend").append("div")
								.attr("class", "legDiv")
								.style({"width": width100, "height": (h/scalar)+"px", "position": "absolute"})
							var leg = d3.select("#leftLegend").select(".legDiv").append("svg")
								.attr("id", "legSVG")
								.style({"width": width100, "height": (h/scalar)+"px","position": "absolute"})
							 leg.selectAll("circle")
						      .data(shipsArray)
						      .enter()
						      .append("circle")
						     // .style(defaultStroke)
						      //.attr("class", function(d) {return data.parent.name})
						      .style("fill", 'none')
						      .attr("r", function(d){return scale(d)})
						      .attr("cy", function(d,i){
						      	//y position should be function of largest radius
						      	var otherCirclesPosition = def + scale(max) - scale(d)
						      	var position = i == 0 ? def : otherCirclesPosition
						      	return position
						      })
						      .attr("cx", scale(max)+16)
						      function yScalar (d,i){
						      	var otherCirclesPosition = def + scale(max) - scale(d)*2
						      	return otherCirclesPosition
							 }
						     leg.selectAll("circletitle")
						      .data(["Number of shipments"])
						       .enter()
						       .append("text")
						       .text(function(d){return d})
						       .attr("text-anchor", "right")
						       .attr("x", 16)
						       .attr("y", 12)
						       .attr("class", "legendTitle")
						     var legTitles = ["Max", "Mean", "Min"]
						     leg.selectAll("circletext")
						      .data(shipsArray)
						       .enter()
						       .append("text")
						       .text(function(d, i){return legTitles[i]+": "+format(d)+" shipments"})
						       .attr("text-anchor", "right")
						       .attr("x", scale(max)*2+20)
						       .attr("y",function(d,i){return yScalar(d,i)})
						       .attr("class", "legendText")
						     leg.selectAll("circlelines")
						     	.data(shipsArray)
						     	.enter()
						     	.append("line")          // attach a line
							    .style("stroke", "white")  // colour the line
							    .attr("x1", scale(max)+16)     // x position of the first end of the line
							    .attr("y1",  function(d,i){
							      	//y position should be function of largest radius
							      	return yScalar(d,i)
						      	})    // y position of the first end of the line
							    .attr("x2", scale(max) * 2 +20)     // x position of the second end of the line
							    .attr("y2", function(d,i){
							      	return yScalar(d,i)
						      	}) //y position of the second end of the line


					
					});
					});
					function prettify (d){
					  d  = d.length > 50 ? d.slice(0,47)+"..." : d
					  return d
					}
							
				</script>
			</div>
		</div>
    
    <div class="container">
        <div class="col-md-4">
          <h4>Continue to next story:</h4>
						<div class="thumbnail portfolio-thumbnail center-block" id="image">
								<a href = "imports.html"><img src="img/clean-harbors-networks-01.png"
								alt="Clean Harbors Networks"/>
								 <p class="imgDescription-col4">Who imports waste into the U.S.?</p>
								</a>
						</div>
				</div>
        <div class="col-md-4">
      		<h4>Back to Story selection:</h4>
      			<div class="thumbnail portfolio-thumbnail center-block" id = "image">
      					<a href = "stories.html"><img src="img/storiesLanding.png"
      					alt="Alberta Tar Sands"/>
      					 <p class="imgDescription-col4">Story selection</p>
      					</a>
      			</div>
      	</div>
      	<div class="col-md-4">
      		<h4>Further exploration:</h4>
      			<div class="thumbnail portfolio-thumbnail center-block" id = "image">
      					<a href = "hmm/index.html" target = "blank"><img src="img/hmmLanding.png"
      					alt="Alberta Tar Sands"/>
      					 <p class="imgDescription-col4">HazMatMapper</p>
      					</a>
      			</div>
      			</div>
      	</div>
  	</div>
  </div><br><br>
  <footer class="footer">
      <div w3-include-html="footer.html"></div>
  </footer>

	</body>


</html>
