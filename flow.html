<!DOCTYPE HTML>
<html lang="en">

	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
			<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>All Shipments</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css">
			  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  			<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  			 <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script type="text/javascript" src="lib/d3-save-svg.min.js"></script>
			<script src='lib/nprogress.js'></script>
			<link rel='stylesheet' href='CSS/nprogress.css'/>
			<script src="lib/w3HTMLinclude.js"></script>
  <style>
  #custom-handle {
    width: 3em;
    height: 1.6em;
    top: 50%;
    margin-top: -.8em;
    text-align: center;
    line-height: 1.6em;
  }
  .CAN, .MEX, .USA {
  fill: #b2b4b6;
  stroke:#f6f6f6;
  stroke-width: .25px;
}
  </style>
	</head>

	<body>

		<div class="container-fluid">
			<div class="col-md-8 map"></div>
			<div class="col-md-4 leg">
				<p><input id="dl"
			      name="downloadButton"
			      type="button"
			      value="Download Map SVG" />
			    <p>
			    <p><input id="dl2"
			      name="downloadButton"
			      type="button"
			      value="Download Legend SVG" />
			    <p>Fill opacity:
      			<div class="row" id="slider">
				  <div id="custom-handle" class="ui-slider-handle"></div>
				</div>
				<!-- <p>Line width:
				<div class="row" id="sliderW">
				  <div id="custom-handleW" class="ui-slider-handle"></div>
				</div> -->
				<p>		
			</div>
		</div>
		
	<script>
	
						//global variables
						var svg, zoomer, path, projection, width100, height100, globalMin, globalMax, arcGroup, exGlobalMin, exGlobalMax, siteKey, passwordExporter, password, flowMax, flowMin, pathArcs, leg
						var defaultColor = "#dee0e0", exDefaultColor = "#5a5a5c"
						var defaultStroke = {"stroke": "#262626", "opacity": 1}
						var u, b, imp, exp;
						  var tooltip = d3.tip()
						  .attr('class', 'd3-tip')
						  .offset([-5, 0])
						  .html(function(d) {
						    return "<span style='color:white'>" + siteKey[d] + "</span>";
						  })

						var flanneryScale;
						var format = d3.format(",.0f")  ;
						//scale stuff
						var smallCircle = window.innerWidth < 500 ? 4 : 16
						var bigCircle = window.innerWidth < 500 ? 16 : 64
						var mapScalar = window.innerWidth < 500 ? .9 : 1.3

						//begin script when window loads
						initialize();

						//the first function called once the html is loaded
						function initialize(){

						  height100 =  window.innerHeight*4
						  $(".map").height(height100)
						  width100 = $(".map").width()*4

						  svg = d3.select(".map").append("svg")
						   .attr("id", "mapSVG")
						   .style({"height": height100, "width": width100, "position": "absolute"})

						  //create map projection
						  projection = d3.geo.albers()
						  .center([4,38])
						  .scale(height100*mapScalar)
						  .translate([(width100/2), (height100/2)]);


						  path = d3.geo.path()
						    .projection(projection);

						  u = svg.append("g")
						  b = svg.append("g")

						  queue()
						    .defer(d3.json, "data/na.json")
						    .defer(d3.json, "data/borders.json")
						    .await(callback);

						    function callback(error, na, borders){
						      b.selectAll('path')
						        .data(topojson.feature(borders, borders.objects.borders).features)
						        .enter().append("path")
						          .attr("d", path)
						          .attr("class", "borders")
						         // .style({'stroke-dasharray': "60", "stroke-width": "5", "stroke": "white"})


						      u.selectAll("path")
						        .data(topojson.feature(na, na.objects.na).features)
						        .enter().append("path")
						          .attr("d", path)
						          .attr("class", function (d){
						            return d.properties.gu_a3
						          })
						          .attr("id", function (d){
						            return d.properties.postal
						          })
						    };
						  setData();
						}

						function setData(){
						  NProgress.start();
						  svg.call(tooltip)

						  d3.csv("data/dataTest.csv", function(data) {
						   
						    var totalShipments = data.length

						    d3.csv("data/lookup.csv", function(info) { 
							  	password = d3.nest()
								  .key(function(d) { return d["ReceivingFacilityEPAIDNumber"] }) // EPA ID number
								  //.rollup(function(leaves) { return {"total_waste": d3.count(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
								  .map(info);
								passwordExporter = d3.nest()
								  .key(function(d) { return d["exporter_key"] }) // EPA ID number
								  //.rollup(function(leaves) { return {"total_waste": d3.count(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
								  .map(info);
							

						    /*data = data.filter(function(row){
						      return row["exporter_key"].includes("E53A2583") && row["company"].includes("CLEAN HARBOR") 
						      || row["exporter_key"].includes("E42A0195") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E53A2583") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E43A6647") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E49A4033") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E49A6974") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E42A1378") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E43A0001") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E43A7517") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E45A2109") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E45A0884") && row["company"].includes("CLEAN HARBOR")
						    })*/

						    var CHShipments = [data.length, (data.length/totalShipments)*100]

						    var exporters = d3.nest() //rollup unique exportlatlongs
						    .key(function(d) {return d.exporter_key;})
						    .rollup(function(leaves) { return {"shipments": leaves.length}})
						    .map(data);
						   
						    var importers = d3.nest() //rollup unique receivinglatlongs
						    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
						    .rollup(function(leaves) { return {"shipments": leaves.length}})
						    .map(data);
						 
						    var nest = d3.nest()
						    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
						    .key(function(d) {return d.exporter_key;})
						    .rollup(function(leaves) { return {"shipments": leaves.length}})
						    .map(data);
						   
						    //find largest value in nest
						    var dumper = []
						    var nester = d3.values(nest)
						    for (var x=0; x<nester.length; x++){
						    	var tempy =d3.values(nester[x]) 
						    	for (y=0; y<tempy.length; y++){
						    		dumper.push(tempy[y].shipments)
						    	}
						    }
						    flowMax = d3.max(dumper)
						    flowMin = d3.min(dumper)
						    console.log(flowMin, flowMax)

						    siteKey={}
							data.forEach(function(d) {
							    siteKey[d.ReceivingFacilityEPAIDNumber] = password[d.ReceivingFacilityEPAIDNumber][0].importer_name+" - "+password[d.ReceivingFacilityEPAIDNumber][0].importer_city+", "+password[d.ReceivingFacilityEPAIDNumber][0].importer_state;
							    siteKey[d.exporter_key] = passwordExporter[d.exporter_key][0].exporter_name+" - "+passwordExporter[d.exporter_key][0].exporter_city+", "+passwordExporter[d.exporter_key][0].exporter_state;
							});
							

							

						  var map =d3.values(exporters).map(function(d){return d.shipments})
						  var max = d3.max(map),
						  min = d3.min(map)

						  var items = d3.keys(exporters).map(function(key) {
							    return [key, exporters[key].shipments];
							});
							// Sort the array based on the second element
							items.sort(function(first, second) {
							    return second[1] - first[1];
							});
						  var exps = items.map(function(d){return d[0]})

						  exGlobalMax = max
						  exGlobalMin = min

						  var flanMax = calcFlanneryRadius(max);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);
						  	
						  	arcGroup = svg.append('g');
						    exp = svg.append("g")
						    imp = svg.append("g")
						     
						    
						    exp.selectAll("circle")
						      .data(exps)
						      .enter().append("circle").attr("class", "circle")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d})
						      .style("fill", exDefaultColor)
						      .style(defaultStroke)
						      .attr("cx", function(d) {return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[0]; })
						      .attr("cy", function(d) { return projection([passwordExporter[d][0].exporterLONG, passwordExporter[d][0].exporterLAT])[1]; })
						      
						    exp.selectAll("circle")
						      .transition()
						      .duration(1000)
						      .attr("r", function(d){return radiusFlannery(exporters[d].shipments)})


						  var map =d3.values(importers).map(function(d){return d.shipments})
						  var max = d3.max(map),
						  min = d3.min(map)

						  var items = d3.keys(importers).map(function(key) {
							    return [key, importers[key].shipments];
							});
							// Sort the array based on the second element
							items.sort(function(first, second) {
							    return second[1] - first[1];
							});
						  var imps = items.map(function(d){return d[0]})

						  globalMax = max, globalMin = min

						  var flanMax = calcFlanneryRadius(max);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);


						    imp.selectAll("circle")
						      .data(imps)
						      .enter().append("circle").attr("class", "circle circleOnMap")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d})
						      .style("fill", defaultColor)
						      .style(defaultStroke)
						      .attr("cx", function(d) {return projection([password[d][0].longitude, password[d][0].latitude])[0]; })
						      .attr("cy", function(d) {exportThis(d, exporters, nest); return projection([password[d][0].longitude, password[d][0].latitude])[1]; })
						      .on("click", function(d){
						      	d3.selectAll(".arc").remove();
						        //exportThis(d, exporters, nest)
						      })
						      .on("mouseover", function(d){console.log(d)})
						    imp.selectAll("circle")
						      .transition()
						      .duration(1000)
						      .attr("r", function(d){return radiusFlannery(importers[d].shipments)})



						  var flanMax = calcFlanneryRadius(globalMax);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

						  var stringwork2 = ["Importers","Exporters"]
						  var circleData = [[globalMax, defaultColor], [globalMin, defaultColor], [exGlobalMax, exDefaultColor], [exGlobalMin, exDefaultColor]]
						  //var circleSpot = [34, 53, 58, 34, 54, 57]

						  var legendKey = ["Max Imports", "Min Imports","Max Exports", "Min Exports"]

							width100 = $(".leg").width()
							//height100=$(".map").height()
							var scalar = window.innerWidth < 500 ? 3 : 2 //scale based on screen size
							$(".leg").height(height100/scalar)
							d3.select(".leg").append("div")
								.attr("class", "legDiv")
								.style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
							leg = d3.selectAll(".legDiv").append("svg")
								.attr("id", "legSVG")
								.style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})

							 leg.selectAll("circle")
						      .data(circleData)
						      .enter()
						      .append("circle")
						      .style(defaultStroke)
						      //.attr("class", function(d) {return data.parent.name})
						      .style("fill", function(d){return d[1]})
						      .attr("r", function(d){return radiusFlannery(d[0])})
						      .attr("cy", function(d,i){
						      	//y position should be function of largest radius
						      	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
						      	var max = i > 1? exGlobalMax : globalMax
						      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])
						      	var position = i == 0 ? def : otherCirclesPosition
						      	position = i > 1 ? position+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : position
						      	return position
						      })
						      .attr("cx", radiusFlannery(globalMax)+20)

						      function yScalar (d,i){
							 	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
							 	var max = i > 1 ? exGlobalMax : globalMax
						      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])*2
						      	otherCirclesPosition = i > 1 ? otherCirclesPosition+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : otherCirclesPosition
						      	return otherCirclesPosition
							  }

						     leg.selectAll("circletitle")
						      .data(["Number of shipments"])
						       .enter()
						       .append("text")
						       .text(function(d){return d})
						       .attr("text-anchor", "right")
						       .attr("x", 16)
						       .attr("y", 10) // + height100/1.5
						       .attr("class", "legendTitle")



						     //here, replace circleData with biggest individual shipment
						     leg.selectAll("circletext")
						      .data(circleData)
						       .enter()
						       .append("text")
						       .text(function(d, i){return legendKey[i]+": "+format(d[0])+" shipments"})
						       .attr("text-anchor", "right")
						       .attr("x", radiusFlannery(globalMax)*2+20)
						       .attr("y",function(d,i){
						       	return yScalar(d,i)
						       })
						       .attr("class", "legendText")


						     leg.selectAll("circlelines")
						     	.data(circleData)
						     	.enter()
						     	.append("line")          // attach a line
							    .style("stroke", "black")  // colour the line
							    .attr("x1", radiusFlannery(globalMax)+20)     // x position of the first end of the line
							    .attr("y1",  function(d,i){
							      	//y position should be function of largest radius
							      	return yScalar(d,i)
						      	})    // y position of the first end of the line
							    .attr("x2", radiusFlannery(globalMax)*2+20)     // x position of the second end of the line
							    .attr("y2", function(d,i){
							      	return yScalar(d,i)
						      	}) //y position of the second end of the line




							  leg.selectAll("flowline")
							    .data([flowMin, flowMax])
							    .enter()
							    .append("rect")
							    //.attr("class", function(d) {return data.parent.name})
							    .style("fill", function(d){return "#252525"})
							    .attr("width", 100)
							    .attr("height", function(d,i){if(i==0){return 2}else{return 14}})
							    .attr("y", function(d,i){if(i==0){return radiusFlannery(globalMax)*6} else{return radiusFlannery(globalMax)*6+20}})
							    .attr("x", 16)

							  leg.selectAll("texts")
							    .data([flowMin, flowMax])
							    .enter()
							    .append('text')
							    .attr("x", 16)
							    .attr("y", function(d,i){if(i==0){return radiusFlannery(globalMax)*6 -4} else{return radiusFlannery(globalMax)*6 +16}})
							    .text(function(d, i){if(i==0){return "Minimum # of shipments: "+ flowMin}else{return "Maximum: "+flowMax}})
							    .attr("class", "legendText")
						  });
						})

						NProgress.done()
						};


						function drawLinesOver(data, base){
						  //see all possible scales here: https://github.com/d3/d3-3.x-api-reference/blob/master/Quantitative-Scales.md

						  lineStroke = d3.scale.pow()  //.linear()	//pow().exponent(3)
						    .domain([globalMin, globalMax])
						    .range([2, 14])

						  //based on: http://bl.ocks.org/enoex/6201948

						  var path = d3.geo.path()
						    .projection(projection);

						// --- Helper functions (for tweening the path)
						        var lineTransition = function lineTransition(path) {
						            path.transition()
						                //NOTE: Change this number (in ms) to make lines draw faster or slower
						                .duration(1500)
						                .attrTween("stroke-dasharray", tweenDash)
						                .each("end", function(d,i) {
						                    ////Uncomment following line to re-transition
						                    //d3.select(this).call(transition);

						                    //We might want to do stuff when the line reaches the target,
						                    //  like start the pulsating or add a new point or tell the
						                    //  NSA to listen to this guy's phone calls
						                    //doStuffWhenLineFinishes(d,i);
						                });
						        };
						        var tweenDash = function tweenDash() {
						            //This function is used to animate the dash-array property, which is a
						            //  nice hack that gives us animation along some arbitrary path (in this
						            //  case, makes it look like a line is being drawn from point A to B)
						            var len = this.getTotalLength(),
						                interpolate = d3.interpolateString("0," + len, len + "," + len);

						            return function(t) { return interpolate(t); };
						        };
						var baseID = base
						base = {"lat": password[base][0].latitude, "long":password[base][0].longitude}       
						var links = [];

						for(var i=0, len=data.length; i<len; i++){
						    // (note: loop until length - 1 since we're getting the next
						    //  item with i+1)

						        links.push({
						            type: "LineString",
						            coordinates: [
						                [ data[i].long, data[i].lat ],
						                [ base.long, base.lat ]
						            ],
						            shipments: data[i].shipments
						        });
						    }
						pathArcs = arcGroup.selectAll("arc")
						            .data(links);

				        //enter
				        var xPosition

				        //enter
				        pathArcs.enter()
				            .append("path").attr({
				                'class': 'arc'
				            })
				            .style({
				                fill: 'none',
				            })

				        //update
				            .attr("d", function(d){
				            	//http://bl.ocks.org/d3noob/

				            	var t = 0
				            	var s = 1
						        var dx = projection(d.coordinates[t])[0] - projection(d.coordinates[s])[0],
						            dy = projection(d.coordinates[t])[1] - projection(d.coordinates[s])[1],
						            dr = Math.sqrt(dx * dx + dy * dy);

						        //when click on exporters, coordinates0 is base. click on importers, coordinates 1 is base
						        //calculate sweep flag based on whether x of target is to the right or left of x of source
						        var left = projection(d.coordinates[t])[0] < projection(d.coordinates[s])[0] ? true : false
						        var sweep = left == true ? 1 : 0
						        //Check if previous xposition was close. if so, flip sweep. 
						        var flip = Math.abs(xPosition - projection(d.coordinates[0])[0]) < 150 ? true : false
						        if (flip == true && sweep == 0){sweep =1}
						       	else if (flip == true && sweep ==1){sweep = 0}
						        if (d.shipments == 292 || d.shipments == 317 || d.shipments == 55) {console.log(flip, sweep); flip=true; sweep=1}
						    	if (baseID == "TXD055141378" && d.shipments == 47) {console.log(flip, sweep)}
						        xPosition = projection(d.coordinates[t])[0]
						        //sweep = 0
						        return "M" + 
						            projection(d.coordinates[0])[0] + "," + 
						           projection(d.coordinates[0])[1] + "A" + 
						            dr + "," + dr + " 0 0," + sweep + " " +
						            projection(d.coordinates[1])[0] + "," + 
						           projection(d.coordinates[1])[1]
				            })
				            .style("stroke", "#929292")
				            .attr("class", "arc")
				            .style('stroke-width', function(d) {return lineStroke(d.shipments)})
				            .style("stroke-opacity", 1)
				                //'stroke-dasharray': '5'
				            .call(lineTransition) //at end of function call positions?
				            .on("mouseover", function(d){console.log(d)})
							}

						//various helper functions here: calculating flannery's compensation, and svg z-indexing.

						d3.select('#dl').on('click', function() {
					      var config = {
					        filename: 'flowSVG',
					      }
					      d3_save_svg.save(d3.select('svg').node(), config);
					    });
					    d3.select('#dl2').on('click', function() {
					      var config2 = {
					        filename: 'legSVG',
					      }
					      d3_save_svg.save(d3.select('#legSVG').node(), config2);
					    });

						//flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
						var calcFlanneryRadius = function(x, max) {
						  // Flannery Compensation formula as described here:
						  //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
						  // log x * 0.57
						  // anti log
						  var flannery = 0.57;
						  var log = Math.log(x);
						  var r = log * flannery;
						  r = Math.exp(r);
						  return (r);
						};

						var radiusFlannery = function(x) {
						  return flanneryScale(calcFlanneryRadius(x));
						};

						function exportThis(data, exporters, nest){
						  if (data == "TXD982290140" || data == "TXD055141378"){console.log(nest[data])}
						  latlongdump = [];
						  var p = nest[data]
						  var keys = d3.keys(p)
						  for (var k=0; k<keys.length; k++){
						    latlongdump.push({"lat": passwordExporter[keys[k]][0].exporterLAT, "long": passwordExporter[keys[k]][0].exporterLONG, "shipments": nest[data][keys[k]].shipments})
						  }
						  //draw lines between exporters and this site
						 
						  drawLinesOver(latlongdump, data);
						}
						var handle = $( "#custom-handle" );
					    $( "#slider" ).slider({
					   		min: 0,
					      max: 100,
					      value: 100,
					      create: function() {
					        handle.text( $( this ).slider( "value" ) );
					      },
					      slide: function( event, ui ) {
					        handle.text( ui.value );
					        console.log(pathArcs)
					        svg.selectAll(".arc").style("stroke-opacity", ui.value/100)
					        //change other things here
					      }
					    });
					    /*var handleW = $( "#custom-handleW" );
					    $( "#sliderW" ).slider({
					   		min: 1,
					      max: 12,
					      value: 6,
					      create: function() {
					        handleW.text( $( this ).slider( "value" ) );
					      },
					      slide: function( event, ui ) {
					        handleW.text( ui.value );
					        svg.selectAll(".arc").style("stroke-width", ui.value)
					        //change other things here
					      }
					    });*/

					</script>

	</body>


</html>
