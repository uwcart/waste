<!DOCTYPE HTML>
<html lang="en">

	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
				<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Dangerous Shipments</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
      <script src='lib/nprogress.js'></script>
      <link rel='stylesheet' href='CSS/nprogress.css'/>
      <script src="lib/w3HTMLinclude.js"></script>

  </head>

  <body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87476640-1', 'auto');
  ga('send', 'pageview');

</script>
  <div w3-include-html="nav.html"></div>
  <script>
  w3IncludeHTML();
  </script>

	<div class="center">
		<div class="jumbotron">
				<div class="container">
						<h1>What Portion of the Hazardous Waste Trade<br>is in Dangerous Material?</h1>
				</div>
		</div>
	</div>

<!-- 		<div class="container">
			<div class="col-md-8"></div>
      <div class="col-md-4"></div>
		</div> -->
    <div class="col-md-12"><img src="img/pg.png" id="mercuryMap" alt="Mercury Waste Flow Map"/><br><br></div>
		<div class="container">
			<div class="col-md-12" id = "bodyText"><h4>What percent of materials are dangerous?</h4>

          <script>
        </script>
        <div class="text">
				<h5>The data for this map comes from ..... Are there differences in the interactive map and static map? If not, can we make them different to enhance the story?
				</h5><br><br>
				</div>
				

		<br><br>
			</div>
		</div>
<!-- <script>
            //global variables
            var svg, zoomer, path, projection, width100, height100, globalMin, globalMax, arcGroup, exGlobalMin, exGlobalMax, circleMax
            var defaultColor = "#D1D3D4", exDefaultColor = "#4D4D4F"
              var defaultStroke = {"stroke": "#262626", "opacity": 1}
            var u, b, imp, exp;
            var tooltip = d3.tip()
              .attr('class', 'd3-tip')
              .offset([-5, 0])
              .html(function(d) {
                return "<span style='color:white'>" + d.namer + "</span>";
              })
            var flanneryScale;
            var importers
            var format = d3.format(".4r")
            //scale stuff
            var smallCircle = window.innerWidth < 500 ? 4 : 8
            var bigCircle = window.innerWidth < 500 ? 16 : 32
            var mapScalar = window.innerWidth < 500 ? .9 : 1.4
            var circleData = [[globalMax, defaultColor], [globalMin, defaultColor], [exGlobalMax, exDefaultColor], [exGlobalMin, exDefaultColor]]
            // var stringwork2 = ["Shipments"]

            //begin script when window loads
            initialize();

            //the first function called once the html is loaded
            function initialize(){

              height100 =  window.innerHeight/1.1
              $(".col-md-8").height(height100)
              width100 = $(".col-md-8").width()

              svg = d3.select(".col-md-8").append("svg")
                .attr("id", "mapSVG")
                .style({"height": height100, "width": width100, "position": "absolute"})

              //create map projection
              projection = d3.geo.albers()
              .center([2,38])
              .scale(height100*mapScalar)
              .translate([(width100)/2, (height100)/2]);

              function updateWindow(){
                y = window.innerHeight/2
                x = $(".col-md-8").width()
                svg.style({"width": x, "height": y});
              }
              window.onresize = updateWindow;

              path = d3.geo.path()
                .projection(projection);

              u = svg.append("g")
              b = svg.append("g")

              queue()
                .defer(d3.json, "data/na.json")
                .defer(d3.json, "data/borders.json")
                .await(callback);

                function callback(error, na, borders){
                  b.selectAll('path')
                    .data(topojson.feature(borders, borders.objects.borders).features)
                    .enter().append("path")
                      .attr("d", path)
                      .attr("class", "borders")


                  u.selectAll("path")
                    .data(topojson.feature(na, na.objects.na).features)
                    .enter().append("path")
                      .attr("d", path)
                      .attr("class", function (d){
                        return d.properties.gu_a3
                      })
                      .attr("id", function (d){
                        return d.properties.postal
                      })
                };
              setData();
            }

            function setData(){
              NProgress.start()
d3.csv("data/PGdata.csv", function(data) {
  data.forEach(function(d){
    d.totalQuantityinShipment = +d.totalQuantityinShipment // convert the quantity of waste from string to number
    d.exporterLAT = +d.exporterLAT
    d.exporterLONG = +d.exporterLONG
    d.receivingLat = +d.latitude
    d.receivingLong = +d.longitude
  });



  siteKey={}
  data.forEach(function(d) {
    siteKey[d.ReceivingFacilityEPAIDNumber] = d.importer_name;
    siteKey[d.exporter_key] = d.exporter_name;
  });
  var facilityDetails = d3.nest()
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number

  .map(data); //.entries(data)
  //by facility, show # of shipments by packing group
  var facilitySum = d3.nest()
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .key(function(d){return d["DOT Packing Group"]})
  .rollup(function(leaves) { return leaves.length} ) // sum by receiving facility code
  .map(data); //.entries(data)
  console.log(facilitySum)

  var key = d3.keys(facilitySum)
  var importers = facilitySum

  var build= []
  //calculate total shipments per facility
  var facilityShips = d3.nest()
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .rollup(function(leaves) { return leaves.length} ) // sum by receiving facility code
  .map(data); //.entries(data)

  //for each site, determine highest level of danger
  key.forEach(function(d){
    var construct={"danger": "I", "percent": 0, "unknown": false}
    var dump = facilitySum[d]
    var PGs = d3.keys(dump)
    if (PGs.includes("N/A") || PGs.includes("")){
      construct.unknown=true
    }
    if (PGs.includes("I")){
      var percent = dump["I"]/facilityShips[d]
      construct.percent = percent*100
      construct.danger = "I"
      construct["site"]=facilityDetails[d][0]
      construct["totalships"] = facilityShips[d]
    } else if (PGs.includes("II")){
      var percent = dump["II"]/facilityShips[d]
      construct.percent = percent*100
      construct.danger = "II"
      construct["site"]=facilityDetails[d][0]
      construct["totalships"] = facilityShips[d]
    } else if (PGs.includes("III")){
      var percent = dump["III"]/facilityShips[d]
      construct.percent = percent*100
      construct.danger = "III"
      construct["site"]=facilityDetails[d][0]
      construct["totalships"] = facilityShips[d]
    } //need case for unknown only...
    build.push(construct)

  })
  build = build.filter(function(d){return d.site})
  console.log(build)



          build.sort(function(a,b){return b.percent-a.percent})


      var totals = build.map(function(d){return d.percent}) //scale for shading danger

            //set importers
        max = d3.max(totals), min = d3.min(totals), mean = d3.mean(totals)

       shipsArray = [max, mean, min]
        var flanMax = calcFlanneryRadius(max);
        var flanMin = calcFlanneryRadius(min);

        flanneryScale = d3.scale.pow().exponent(3).domain([flanMin, flanMax]).range([smallCircle, bigCircle/1.75]);

        explanation={"I": "Minor Danger", "II": "Medium Danger", "III": "Great Danger"}
        var color={"I": "yellow", "II": "orange", "III": "red"}
        tooltip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-5, 0])
        .html(function(d) {
          var language = d.unknown ? " " : " not"
          return "<span style='color:white'>" + d.site.importer_name + ": "+format(d.percent)+"% of shipments contained level "+d.danger+" material, or "+explanation[d.danger]+" material. <p>This site did"+language+" also import material with unknown danger level.</span>";
        })

        svg.call(tooltip)

        imp = svg.append("g")
        imp.selectAll("circle")
          .data(build)
          .enter().append("circle")
         // .attr("class", function(d) {return d.ReceivingFacilityEPAIDNumber+" "+d.state+d.years+" "+d.importer_name+" circleOnMap circle"})
          .attr("id", "importer")
          .style("fill", function(d){
            return color[d.danger]
          })
          .style("fill-opacity", function(d){
            if (d.unknown){return 1} else{return .4}
          })
          /*.style("stroke", function(d){
            return color[d.danger]
          })*/
          .style(defaultStroke)
          .style("stroke-opacity", function(d){
            if (d.unknown){return 1} else{return .4}
          })
          .attr("cx", function(d) {if (d.site){return projection([d.site.longitude, d.site.latitude])[0];} })
          .attr("cy", function(d) {if (d.site){return projection([d.site.longitude, d.site.latitude])[1];} })
          //.attr("id", function(d){return data.state})
          .on("mouseover", function(d){
          	console.log(d)
            tooltip.show(d);
            highlight(d);
          })
          .on("mouseout", function(d){
            tooltip.hide(d);
            dehighlight(d);
            //drawLinesOut(d);
          })
        imp.selectAll("circle")
          .attr("r", function(d) {
           return radiusFlannery(d.percent)
          })


          width100 = $(".col-md-4").width()
          //height100=$(".map").height()
          var scalar = window.innerWidth < 500 ? 3 : 2 //scale based on screen size
          $(".col-md-4").height(height100/scalar)
          d3.select(".col-md-4").append("div")
            .attr("class", "legDiv")
            .style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
          var leg = d3.selectAll(".legDiv").append("svg")
          .attr("id", "legSVG")
          .style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})



         leg.selectAll("legcircle")
            .data(shipsArray)
            .enter()
            .append("circle")
            .style(defaultStroke)
            //.attr("class", function(d) {return data.parent.name})
            .style("fill", 'none')
            .attr("r", function(d){return radiusFlannery(d)})
            .attr("cy", function(d,i){
              //y position should be function of largest radius
              var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
              var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d)
              var position = i == 0 ? def : otherCirclesPosition
              return position
            })
            .attr("cx", radiusFlannery(shipsArray[0])+16)
            function yScalar (d,i){
              var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
              var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d)*2
              return otherCirclesPosition
            }
           leg.selectAll("circletitle")
            .data(["% of total shipments that were at highest danger level"])
             .enter()
             .append("text")
             .text(function(d){return d})
             .attr("text-anchor", "right")
             .attr("x", 16)
             .attr("y", 10)
             .attr("class", "legendTitle")
           var legTitles = ["Max", "Mean", "Min"]
           leg.selectAll("circletext")
            .data(shipsArray)
             .enter()
             .append("text")
             .text(function(d, i){return legTitles[i]+": "+format(d)+" %"})
             .attr("text-anchor", "right")
             .attr("x", radiusFlannery(max)*2+20)
             .attr("y",function(d,i){return yScalar(d,i)})
             .attr("class", "legendText")
           leg.selectAll("circlelines")
            .data(shipsArray)
            .enter()
            .append("line")          // attach a line
            .style("stroke", "black")  // colour the line
            .attr("x1", radiusFlannery(max)+16)     // x position of the first end of the line
            .attr("y1",  function(d,i){
                //y position should be function of largest radius
                return yScalar(d,i)
              })    // y position of the first end of the line
            .attr("x2", radiusFlannery(max) * 2 +18)     // x position of the second end of the line
            .attr("y2", function(d,i){
                return yScalar(d,i)
              }) //y position of the second end of the line
             var def = window.innerWidth < 500 ? 25 : 60
        leg.selectAll("rect")
                .data(["red", "orange", "yellow"])
                .enter()
                .append("rect")
                .style("fill", function(d, i) {
                    return d
                     })
                .style("fill-opacity", .4)
                .attr("width", 16)
                .attr("height", 16)
                .attr("y", function(d,i){return i * 16 + def + radiusFlannery(shipsArray[0]) * 3})
                .attr("x", 16)

              leg.selectAll("compliancetext")
                .data(d3.values(explanation).reverse())
                 .enter()
                 .append("text")
                 .text(function(d){return d})
                 .attr("text-anchor", "right")
                 .attr("x", 45)
                 .attr("y", function(d,i){return i * 16 + 14 + def + radiusFlannery(shipsArray[0]) * 3})
                 .attr("class", "legendText")
              leg.selectAll("toptext")
                .data(["Level of most dangerous material imported"])
                 .enter()
                 .append("text")
                 .text(function(d){return d})
                 .attr("text-anchor", "right")
                 .attr("x", 16)
                 .attr("y", def + radiusFlannery(shipsArray[0]) * 3 - 5)
                 .attr("class", "legendTitle")

        leg.selectAll("rect2")
                .data(["red", "orange", "yellow"])
                .enter()
                .append("rect")
                .style("fill", function(d, i) {
                    return d
                     })

                .attr("width", 16)
                .attr("height", 16)
                .attr("y", function(d,i){return i * 16 + def + radiusFlannery(shipsArray[0]) * 6})
                .attr("x", 16)

              leg.selectAll("compliancetext2")
                .data(d3.values(explanation).reverse())
                 .enter()
                 .append("text")
                 .text(function(d){return d+" and unknown danger level material also"})
                 .attr("text-anchor", "right")
                 .attr("x", 45)
                 .attr("y", function(d,i){return i * 16 + 14 + def + radiusFlannery(shipsArray[0]) * 6})
                 .attr("class", "legendText")

    })

  };
NProgress.done()



            function highlight(data){
              svg.selectAll(".circle")
                .transition().duration(500)
                .style({"opacity": ".2"})
              svg.selectAll("."+data.ReceivingFacilityEPAIDNumber)
                .transition().duration(500)
                .style({"opacity": "1"})
            }

            function dehighlight(data){
              svg.selectAll(".circle")
                .transition().duration(500)
                .style({"opacity": "1"})
            };


            //various helper functions here: calculating flannery's compensation, and svg z-indexing.
            //flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
            var calcFlanneryRadius = function(x, max) {
              // Flannery Compensation formula as described here:
              //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
              // log x * 0.57
              // anti log
              var flannery = 0.57;
              var log = Math.log(x);
              var r = log * flannery;
              r = Math.exp(r);
              return (r);
            };

            var radiusFlannery = function(x) {
              return flanneryScale(calcFlanneryRadius(x));
            };


          </script> -->
					<footer class="footer">
						<!-- <div class="container"> -->
							<div class="logos">
							<a href = "http://geography.wisc.edu" target="blank"><img src="img/uwgeog-01.png" alt="UW Geography Logo" hspace="10"></a>
							<a href = "https://www.nsf.gov/" target="blank"><img src="img/nsf-01-01.png" alt="NSF Logo" hspace="10"></a>
							<a href = "http://www.geography.wisc.edu/cartography/" target="blank"><img src="img/uwcart-01-01.png" alt="uwcart Logo" hspace="10"></a>
							</div>
						<!-- </div> -->
					</footer>
	</body>


</html>
