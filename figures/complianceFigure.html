<!DOCTYPE HTML>
<html lang="en">

	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
				<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
				<link href="https://fonts.googleapis.com/css?family=Doppio+One" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Company Compliance</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script type="text/javascript" src="lib/d3-save-svg.min.js"></script>
			<script src='lib/nprogress.js'></script>
			<link rel='stylesheet' href='CSS/nprogress.css'/>
			<script src="lib/w3HTMLinclude.js"></script>

	</head>

	<body>

		<p><input id="dl"
			      name="downloadButton"
			      type="button"
			      value="Download Map SVG" />
		<p><input id="dl2"
			      name="downloadButton"
			      type="button"
			      value="Download Leg SVG" />
		<div class="container">
			<div class="col-md-8"></div>
			<div class="col-md-4" id="rightLegend"></div>
		</div>

					<script>
					//global variables
					d3.select('#dl').on('click', function() {
					      var config = {
					        filename: 'mapSVG',
					      }
					      d3_save_svg.save(d3.select('svg').node(), config);
					    });
					d3.select('#dl2').on('click', function() {
					      var config = {
					        filename: 'legSVG',
					      }
					      d3_save_svg.save(d3.select('#legend').node(), config);
					    });
					var svg, zoomer, projection, width100, height100, colorKey, mapData = {}, dates = [], max, circleMax, path, time, firstTime = true;
					var defaultColor = "#D1D3D4", exDefaultColor = "#4D4D4F", update = []
							var defaultStroke = {"stroke": "#262626", "opacity": 1}
					var zoom = d3.behavior.zoom()
					    .scaleExtent([1, 12])
					    .on("zoom",zoomer);
					var u, b, imp, exp;
					var tooltip = d3.tip()
					  .attr('class', 'd3-tip')
					  .offset([-5, 0])
					  .html(function(d, status, time) {
					    return "<span style='color:white'>" + d.name + ": "+ format(d.shipments)+" shipments <br>"+time+": "+plegend[status]+"</span>";
					  })
					var flanneryScale;
					var format = d3.format(",.0f")  ;
					var smallCircle = window.innerWidth < 500 ? 4 : 8
					var bigCircle = window.innerWidth < 500 ? 16 : 32
					var mapScalar = window.innerWidth < 500 ? .9 : 1.4
					var plegend={"SNC": "Significant Non-Compliance", "In Viol": "In Violation", "No Viol": "No violation", "null": "Unknown status"}

					//begin script when window loads
					initialize();

					//the first function called once the html is loaded
					function initialize(){

					  height100 =  window.innerHeight/1.5
					  $(".col-md-8").height(height100)
					  width100 = $(".col-md-8").width()

					  svg = d3.select(".col-md-8").append("svg")
					    .attr("id", "mapSVG")
					    .style({"height": height100, "width": width100, "position": "absolute"})

					  //create map projection
					  projection = d3.geo.albers()
					  .center([2,38])
					  .scale(height100*mapScalar)
					  .translate([(width100)/2, (height100)/2]);

						  function updateWindow(){
						    y = window.innerHeight/2
						    x = $(".col-md-8").width()
						    svg.style({"width": x, "height": y});
						  }
						  window.onresize = updateWindow;

					  path = d3.geo.path()
					    .projection(projection);

					  u = svg.append("g")
					  b = svg.append("g")

					  queue()
					    .defer(d3.json, "data/na.json")
					    .defer(d3.json, "data/borders.json")
					    .await(callback);

					    function callback(error, na, borders){
					      //svg.call(zoom);

					      b.selectAll('path')
					        .data(topojson.feature(borders, borders.objects.borders).features)
					        .enter().append("path")
					          .attr("d", path)
					          .attr("class", "borders")


					      u.selectAll("path")
					        .data(topojson.feature(na, na.objects.na).features)
					        .enter().append("path")
					          .attr("d", path)
					          .attr("class", function (d){
					            return d.properties.gu_a3
					          })
					          .attr("id", function (d){
					            return d.properties.postal
					          })
					    };
					  setData();
					  //legend();
					}

					function setData(){

					  d3.csv("data/us-importers-geocoding.csv", function(importerData) {
					    importerData.forEach(function(d){
					      mapData[d.EPAID] = {"id": d.EPAID, "name": d.name, "latitude": d.lat, "longitude": d.lon, "shipments": d.shipments, "Status": {}}
					      //ECHO(d)
					    });
					    otherstuff();
					  })
					 }
					function otherstuff(){
						var array = d3.values(mapData).sort(function(a,b){return b.shipments-a.shipments})
						array.forEach(function(d){
							setTimeout(function() { ECHO(d); }, 3000)
						})
					}

/*					    d3.values(mapData).forEach(function(d){
					    	ECHO(d)
					    })*/
					  	//ECHO(mapData["TXD981053770"])

					    //run echo here
						function ECHO(data){
						  var name = data.id
						  $.ajax({
						    url:"https://ofmpub.epa.gov/echo/dfr_rest_services.get_rcra_compliance?output=JSON&p_id="+name+"", //epa id
						    dataType:"json",
						    success: function (d){
						    	//console.log(d)
						      if (d.Results.RCRACompliance.Sources[0].Status){
						        data = d.Results.RCRACompliance.Sources[0].Status
						        var legend = d.Results.RCRACompliance
						        delete legend.Sources
								//console.log(data, legend, name);
						      }
						        ECHOchart(data, legend, name)
						    }

						  })
						}

						function ECHOchart(data, legend, name){
						      var p = d3.keys(data)
						      p.shift()
						      var q = d3.values(data)
						      q.shift()
						      console.log(q)

						     //count % of time in viol or sig non compliance
						     var dump = []
						     q.forEach(function(d){
						     	if (d=="SNC"||d=="In Viol"){dump.push(1)}
						     })
						     dump = d3.sum(dump)
						     var percent =dump/q.length

						     update.push(percent)
						     console.log(dump, percent, update)
						      //console.log(data, legend, name)
						      //console.log(q, legend)
						      var status = {}
						      status[name] = {}
						      for (var i =0; i<d3.values(legend).length; i+=2){
						      	var j = i + 1
						      	var counter = d3.values(legend)[i]

						      	mapData[name]["Status"][counter]  = i == 0 ? q[0] : q[i/2]
						      	status[name][counter] = i == 0 ? q[0] : q[i/2]
						      	dates[counter] = "" //[d3.values(legend)[i]+"-"+d3.values(legend)[j]] = ""
						      }
						      //console.log(status)
						      time = d3.values(legend)[0]
						      map(status, time, percent)

						}


					/*  svg.append('g').selectAll("rect").data("Click me").enter().append("rect")
					    .attr({"fill": "blue", "width": 20, "height": 20, "x": width100/3, "y": height100/2})
					    .on('click', filter)*/




					function map(status, time, percent){

   	 					var name = d3.keys(status)[0];
   	 					//console.log(d3.keys(status)[0])
   	 					//console.log(status[name][time])
							    //colorKey={"SNC": "red", "In Viol": "orange", "No Viol": "black", "null": "grey"}
							    var scale = d3.scale.threshold()
								  .domain([.25,.75])
								  .range(['grey', 'yellow', 'red']);
						        var ships = d3.values(mapData).map(function(d){return +d.shipments})
						        var max = d3.max(ships)
						        var min = d3.min(ships)
						        var mean = d3.mean(ships)
						        var shipsArray = [max, mean, min]

						        circleMax = height100/16

						        var flanMax = calcFlanneryRadius(max);
						        flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

						/*if (status[name][time] === undefined){return} else{var test = [status[name][time]]}*/
				        var exp = svg.append("g")
				        exp.selectAll("circle")
				          .data([percent])
				          .enter().append("circle")
				          .attr("class", "circle circleOnMap")
				          //.attr("id", function(d){return mapData[name].id})
				          .style("fill", function(d) {
				          	return scale(d)//colorKey[d]
				          	//return "blue"
					       })
				          .style(defaultStroke)
				          .attr("cx", function(d) {return projection([mapData[name].longitude, mapData[name].latitude])[0]; })
				          .attr("cy", function(d) { return projection([mapData[name].longitude, mapData[name].latitude])[1]; })
				          .on("mouseover",function(d){console.log(name)})


				        exp.selectAll("circle")
				          .transition()
				          .duration(1000)
				          .attr("r", function(d){return radiusFlannery(mapData[name].shipments)})

				        if(firstTime){firstTime = false; legend(plegend, dates, time, shipsArray)}

					}
					function legend(plegend, dates, time, shipsArray){
						d3.select("#legend").remove()
						d3.select("#timer").remove()

					    vwidth100 = $(".col-md-4").width()
						//height100=$(".map").height()
						var scalar = window.innerWidth < 500 ? 3 : 2 //scale based on screen size
						$(".col-md-4").height(height100/scalar)
						d3.select(".col-md-4").append("div")
							.attr("class", "legDiv")
							.style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
						var leg = d3.selectAll(".legDiv").append("svg")
						.attr("id", "legend")
						.style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})


						 leg.selectAll("legcircle")
					      .data(shipsArray)
					      .enter()
					      .append("circle")
					      .style(defaultStroke)
					      //.attr("class", function(d) {return data.parent.name})
					      .style("fill", 'none')
					      .attr("r", function(d){return radiusFlannery(d)})
					      .attr("cy", function(d,i){
					      	//y position should be function of largest radius
					      	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
					      	var otherCirclesPosition = def + radiusFlannery(shipsArray[0]) - radiusFlannery(d)
					      	var position = i == 0 ? def : otherCirclesPosition
					      	return position
					      })
					      .attr("cx", radiusFlannery(shipsArray[0])+16)
					      function yScalar (d,i){
						 	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
					      	var otherCirclesPosition = def + radiusFlannery(shipsArray[0]) - radiusFlannery(d)*2
					      	return otherCirclesPosition
						 }
					     leg.selectAll("circletitle")
					      .data(["Number of shipments"])
					       .enter()
					       .append("text")
					       .text(function(d){return d})
					       .attr("text-anchor", "right")
					       .attr("x", 16)
					       .attr("y", 10)
					       .attr("class", "legendTitle")

					     var legTitles = ["Max", "Mean", "Min"]
					     leg.selectAll("circletext")
					      .data(shipsArray)
					       .enter()
					       .append("text")
					       .text(function(d, i){return legTitles[i]+": "+format(d)+" shipments"})
					       .attr("text-anchor", "right")
					       .attr("x", radiusFlannery(shipsArray[0])*2+20)
					       .attr("y",function(d,i){return yScalar(d,i)})
					       .attr("class", "legendText")

					     leg.selectAll("circlelines")
					     	.data(shipsArray)
					     	.enter()
					     	.append("line")          // attach a line
						    .style("stroke", "black")  // colour the line
						    .attr("x1", radiusFlannery(shipsArray[0])+16)     // x position of the first end of the line
						    .attr("y1",  function(d,i){
						      	//y position should be function of largest radius
						      	return yScalar(d,i)
					      	})    // y position of the first end of the line
						    .attr("x2", radiusFlannery(shipsArray[0]) * 2 +18)     // x position of the second end of the line
						    .attr("y2", function(d,i){
						      	return yScalar(d,i)
					      	}) //y position of the second end of the line

						var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
						var colors={"Unknown status or in compliance for at least 8 of the past 12 quarters": "grey", "In Violation or Significant Non-Compliance for 4-8 of the past 12 quarters": "yellow", "In Violation or Significant Non-Compliance for over 8 of the past 12 quarters": "red"}
					    leg.selectAll("rect")
					      .data(d3.values(colors))
					      .enter()
					      .append("rect")
					      .style("fill", function(d, i) {
					          return d
					           })
					      .attr("width", 16)
					      .attr("height", 16)
					      .attr("y", function(d,i){return i * 16 + def + radiusFlannery(shipsArray[0]) * 3})
					      .attr("x", 16)
					    console.log(plegend)
					    leg.selectAll("compliancetext")
					      .data(d3.keys(colors))
					       .enter()
					       .append("text")
					       .text(function(d){return d})
					       .attr("text-anchor", "right")
					       .attr("x", 45)
					       .attr("y", function(d,i){return i * 16 + 14 + def + radiusFlannery(shipsArray[0]) * 3})
					       .attr("class", "legendText")
					    leg.selectAll("toptext")
					      .data(["Compliance status"])
					       .enter()
					       .append("text")
					       .text(function(d){return d})
					       .attr("text-anchor", "right")
					       .attr("x", 16)
					       .attr("y", def + radiusFlannery(shipsArray[0]) * 3 - 5)
					       .attr("class", "legendTitle")



						}

/*					function zoomer() {
					  u.attr("transform", "translate(" +  zoom.translate() + ")scale(" + zoom.scale() + ")")
					      .selectAll("path").style("stroke-width", 1 / zoom.scale() + "px" );
					  b.attr("transform", "translate(" +  zoom.translate() + ")scale(" + zoom.scale() + ")")
					      .selectAll("path").style("stroke-width", 1 / zoom.scale() + "px" );
					  svg.selectAll("circle").attr("transform", "translate(" +  zoom.translate() + ")scale(" + zoom.scale() + ")")
					      .attr("r", function (d){
					      return 10//radiusFlannery(d.shipments)/(zoom.scale())
					      })
					      .style("stroke-width", 1 / zoom.scale() + "px" )
					 }*/

					//various helper functions here: calculating flannery's compensation, and svg z-indexing.
					//flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
					var calcFlanneryRadius = function(x, max) {
					  // Flannery Compensation formula as described here:
					  //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
					  // log x * 0.57
					  // anti log
					  var flannery = 0.57;
					  var log = Math.log(x);
					  var r = log * flannery;
					  r = Math.exp(r);
					  return (r);
					};

					var radiusFlannery = function(x) {
					  return flanneryScale(calcFlanneryRadius(x));
					};
					function closest (num, arr) {
					    var curr = arr[0];
					    var diff = Math.abs (num - curr);
					    for (var val = 0; val < arr.length; val++) {
					        var newdiff = Math.abs (num - arr[val]);
					        if (newdiff < diff) {
					            diff = newdiff;
					            curr = arr[val];
					        }
					    }
					    return curr;
					}

					function highlight(data){
					  svg.selectAll(".circle")
					    .transition().duration(500)
					    .style({"opacity": ".2"})
					  svg.selectAll("#"+data.id)
					    .transition().duration(500)
					    .style({"opacity": "1"})
					}

					function dehighlight(data){
					  svg.selectAll(".circle")
					    .transition().duration(500)
					    .style({"opacity": "1"})
					};

					function redraw (base){
					  svg.selectAll(".circle").sort(function (a, b) {
					    if (a != base) return 0;               // a is not the hovered element, send "a" to the back
					    else return 1;                             // a is the hovered element, bring "a" to the front
					  });
					}

				</script>



	</body>


</html>
