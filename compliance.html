<!DOCTYPE HTML>
<html lang="en">

	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
				<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
				<link href="https://fonts.googleapis.com/css?family=Doppio+One" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Compliance</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script type="text/javascript" src="lib/d3-save-svg.min.js"></script>
			<script src='lib/nprogress.js'></script>
			<link rel='stylesheet' href='CSS/nprogress.css'/>
			<script src="lib/w3HTMLinclude.js"></script>

	</head>

	<body>

	<style>
		@font-face {
			font-family: Blackout;
			src: url(fonts/Blackout-Midnight.ttf);
		}
		h1 {
			font-family: Blackout;
		}
	</style>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87476640-1', 'auto');
  ga('send', 'pageview');

</script>
	<div w3-include-html="nav.html"></div>
	<script>
	w3IncludeHTML();
	</script>
	<div class="center">
		<div class="jumbotron">
				<div class="container">
						<h1>Are Waste Processors in Compliance?</h1>

				</div>
		</div>
	</div>
	<div class="container">
		<div class="col-md-12" id = "bodyText">
			<!-- <h4>Compliance Status of United States Waste Importers</h4> -->

			<h5>Hazardous waste processing facilities are required to follow operating guidelines set by the EPA. Data from the U.S. EPA <div class="definition" style="cursor:help">ECHO<span class="tooltiptext">Enforcement and Compliance History Online-contains facility level compliance data</span></div> shows whether plants have had any violations from October 2013-July 2016. This map correlates compliance status with the number of shipments the facilites received from 2007 to 2012. The facilities of the firm Clean Harbors are some of the most <a href="imports.html">active importers</a>. Its Kimball, Nebraska and El Dorado, Arkansas sites are two of the top importers, but these sites are regularly out of compliance. This raises <a href="demographics.html">environmental justice concerns</a>.</h5> <h6><i>*Indicates plant-wide status, not necessary imported waste processing.</i></h6>
		<br>
	</div>
	</div>
		<div class="container">
			<div class="col-md-8"></div>
			<div class="col-md-3" id="rightLegend"></div>
		</div>
		<div class="container" >
			<div class="col-md-12" id = "timeDiv"></div>
		</div>
		<div class="container" >
			<div class="col-md-12"><br><br></div>
		</div>

					<script>
					//global variables
					d3.select('#dl').on('click', function() {
					      var config = {
					        filename: 'flowSVG',
					      }
					      d3_save_svg.save(d3.select('svg').node(), config);
					    });
					var svg, zoomer, projection, width100, height100, colorKey, mapData = {}, dates = [], max, circleMax, path, time, firstTime = true;
					var defaultColor = "#D1D3D4", exDefaultColor = "#4D4D4F"
							var defaultStroke = {"stroke": "#262626", "opacity": 1}
					var zoom = d3.behavior.zoom()
					    .scaleExtent([1, 12])
					    .on("zoom",zoomer);
					var u, b, imp, exp;
					var tooltip = d3.tip()
					  .attr('class', 'd3-tip')
					  .offset([-5, 0])
					  .html(function(d, status, time) {
					    return "<span style='color:white'>" + d.name + ": "+ format(d.shipments)+" shipments <br>"+time+": "+plegend[status]+"</span>";
					  })
					var flanneryScale;
					var format = d3.format(",.0f")  ;
					var smallCircle = window.innerWidth < 500 ? 4 : 8
					var bigCircle = window.innerWidth < 500 ? 16 : 32
					var mapScalar = window.innerWidth < 500 ? .9 : 1.4
					var plegend={"SNC": "Significant Non-Compliance", "In Viol": "In Violation", "No Viol": "No violation", "null": "Unknown status"}

					//begin script when window loads
					initialize();

					//the first function called once the html is loaded
					function initialize(){

					  height100 =  window.innerHeight/1.5
					  $(".col-md-8").height(height100)
					  width100 = $(".col-md-8").width()

					  svg = d3.select(".col-md-8").append("svg")
					    .attr("id", "mapSVG")
					    .attr("height", height100)
					    .attr("width", width100)
					    .attr("position", "absolute")
					    //.style({"height": height100, "width": width100, "position": "absolute"})

					  //create map projection
					  projection = d3.geo.albers()
					  .center([2,38])
					  .scale(height100*mapScalar)
					  .translate([(width100)/2, (height100)/2]);

						  function updateWindow(){
						    y = window.innerHeight/2
						    x = $(".col-md-8").width()
						    svg.style({"width": x, "height": y});
						  }
						  window.onresize = updateWindow;

					  path = d3.geo.path()
					    .projection(projection);

					  u = svg.append("g")
					  b = svg.append("g")

					  queue()
					    .defer(d3.json, "data/na.json")
					    .defer(d3.json, "data/borders.json")
					    .await(callback);

					    function callback(error, na, borders){
					      //svg.call(zoom);

					      b.selectAll('path')
					        .data(topojson.feature(borders, borders.objects.borders).features)
					        .enter().append("path")
					          .attr("d", path)
					          .attr("class", "borders")


					      u.selectAll("path")
					        .data(topojson.feature(na, na.objects.na).features)
					        .enter().append("path")
					          .attr("d", path)
					          .attr("class", function (d){
					            return d.properties.gu_a3
					          })
					          .attr("id", function (d){
					            return d.properties.postal
					          })
					    };
					  setData();
					  //legend();
					}

					function setData(){
					 NProgress.start()
					  svg.call(tooltip)

					  d3.csv("data/us-importers-geocoding.csv", function(importerData) {
					    importerData.forEach(function(d){
					      mapData[d.EPAID] = {"id": d.EPAID, "name": d.name, "latitude": d.lat, "longitude": d.lon, "shipments": d.shipments, "Status": {}}
					      //ECHO(d)
					    });
					    otherstuff();
					  })
					 }
					function otherstuff(){
						//console.log(mapData)
						var array = d3.values(mapData)
						array.sort(function(a,b){return b.shipments - a.shipments})
						array.forEach(function(d){
							ECHO(d)
						})
					}

/*					    d3.values(mapData).forEach(function(d){
					    	ECHO(d)
					    })*/
					  	//ECHO(mapData["TXD981053770"])

					    //run echo here
						function ECHO(data){
						  var name = data.id
						  $.ajax({
						    url:"https://ofmpub.epa.gov/echo/dfr_rest_services.get_dfr?output=JSON&p_id="+name+"", //epa id
						    dataType:"json",
						    success: function (d){
						      if (d.Results.RCRACompliance.Sources[0].Status){
						        data = d.Results.RCRACompliance.Sources[0].Status
						        var legend = d.Results.RCRACompliance
						        delete legend.Sources
								//console.log(data, legend, name);
						      }
						        ECHOchart(data, legend, name)
						    }

						  })
						}

						function ECHOchart(data, legend, name){
						      var p = d3.keys(data)
						      p.shift()
						      var q = d3.values(data)
						      q.shift()

						      console.log(data, legend, name)
						      //console.log(q, legend)
						      var status = {}
						      status[name] = {}
						      for (var i =0; i<d3.values(legend).length; i+=2){
						      	var j = i + 1
						      	var counter = d3.values(legend)[i]

						      	mapData[name]["Status"][counter]  = i == 0 ? q[0] : q[i/2]
						      	status[name][counter] = i == 0 ? q[0] : q[i/2]
						      	dates[counter] = "" //[d3.values(legend)[i]+"-"+d3.values(legend)[j]] = ""
						      }
						      //console.log(status)
						      time = d3.values(legend)[0]
						      map(status, time)

						}


					/*  svg.append('g').selectAll("rect").data("Click me").enter().append("rect")
					    .attr({"fill": "blue", "width": 20, "height": 20, "x": width100/3, "y": height100/2})
					    .on('click', filter)*/



					function map(status, time){

   	 					var name = d3.keys(status)[0];
   	 					//console.log(d3.keys(status)[0])
   	 					//console.log(status[name][time])

							    colorKey={"SNC": "red", "In Viol": "orange", "No Viol": "black", "null": "grey"}

						        var ships = d3.values(mapData).map(function(d){return +d.shipments})
						        var max = d3.max(ships)
						        var min = d3.min(ships)
						        var mean = d3.mean(ships)
						        var shipsArray = [max, mean, min]

						        circleMax = height100/16

						        var flanMax = calcFlanneryRadius(max);
						        flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

						//console.log(mapData[name])
						if (status[name][time] === undefined){return} else{var test = [status[name][time]]}
				        var exp = svg.append("g")
				        exp.selectAll("circle")
				          .data(test)
				          .enter().append("circle")
				          .attr("class", "circle circleOnMap")
				          .attr("id", function(d){return mapData[name].id})
				          .style("fill", function(d) {
				          	return colorKey[d]
				          	//return "blue"
					       })
				          .style(defaultStroke)
				          .attr("cx", function(d) {return projection([mapData[name].longitude, mapData[name].latitude])[0]; })
				          .attr("cy", function(d) { return projection([mapData[name].longitude, mapData[name].latitude])[1]; })
				          .on("mouseover", function(d){
				            tooltip.show(mapData[name], d, time);
				            highlight(mapData[name]);
				          })
				          .on("mouseout", function(d){
				            tooltip.hide(mapData[name]);
				            dehighlight(mapData[name]);
				          })
				          .on('click', function(d){
				            redraw(mapData[name]);
				          })

				        exp.selectAll("circle")
				          .transition()
				          .duration(1000)
				          .attr("r", function(d){return radiusFlannery(mapData[name].shipments)})

				        if(firstTime){firstTime = false; legend(plegend, dates, time, shipsArray)}

					}
					function legend(plegend, dates, time, shipsArray){
						d3.select("#legend").remove()
						d3.select("#timer").remove()

					    vwidth100 = $(".col-md-3").width()
						//height100=$(".map").height()
						var scalar = window.innerWidth < 200 ? 3 : 2 //scale based on screen size
						$(".col-md-3").height(height100/scalar)
						d3.select(".col-md-3").append("div")
							.attr("class", "legDiv")
							.style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
						var leg = d3.selectAll(".legDiv").append("svg")
						.attr("id", "legend")
						.style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})


						 leg.selectAll("legcircle")
					      .data(shipsArray)
					      .enter()
					      .append("circle")
					      .style(defaultStroke)
					      //.attr("class", function(d) {return data.parent.name})
					      .style("fill", 'none')
					      .attr("r", function(d){return radiusFlannery(d)})
					      .attr("cy", function(d,i){
					      	//y position should be function of largest radius
					      	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
					      	var otherCirclesPosition = def + radiusFlannery(shipsArray[0]) - radiusFlannery(d)
					      	var position = i == 0 ? def : otherCirclesPosition
					      	return position
					      })
					      .attr("cx", radiusFlannery(shipsArray[0])+16)
					      function yScalar (d,i){
						 	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
					      	var otherCirclesPosition = def + radiusFlannery(shipsArray[0]) - radiusFlannery(d)*2
					      	return otherCirclesPosition
						 }
					     leg.selectAll("circletitle")
					      .data(["Number of shipments"])
					       .enter()
					       .append("text")
					       .text(function(d){return d})
					       .attr("text-anchor", "right")
					       .attr("x", 16)
					       .attr("y", 10)
					       .attr("class", "legendTitle")

					     var legTitles = ["Max", "Mean", "Min"]
					     leg.selectAll("circletext")
					      .data(shipsArray)
					       .enter()
					       .append("text")
					       .text(function(d, i){return legTitles[i]+": "+format(d)+" shipments"})
					       .attr("text-anchor", "right")
					       .attr("x", radiusFlannery(shipsArray[0])*2+20)
					       .attr("y",function(d,i){return yScalar(d,i)})
					       .attr("class", "legendText")

					     leg.selectAll("circlelines")
					     	.data(shipsArray)
					     	.enter()
					     	.append("line")          // attach a line
						    .style("stroke", "black")  // colour the line
						    .attr("x1", radiusFlannery(shipsArray[0])+16)     // x position of the first end of the line
						    .attr("y1",  function(d,i){
						      	//y position should be function of largest radius
						      	return yScalar(d,i)
					      	})    // y position of the first end of the line
						    .attr("x2", radiusFlannery(shipsArray[0]) * 2 +18)     // x position of the second end of the line
						    .attr("y2", function(d,i){
						      	return yScalar(d,i)
					      	}) //y position of the second end of the line

						var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
					    leg.selectAll("rect")
					      .data(d3.keys(plegend))
					      .enter()
					      .append("rect")
					      .style("fill", function(d, i) {
					          return colorKey[d]
					           })
					      .attr("width", 16)
					      .attr("height", 16)
					      .attr("y", function(d,i){return i * 16 + def + radiusFlannery(shipsArray[0]) * 3})
					      .attr("x", 16)
					    console.log(plegend)
					    leg.selectAll("compliancetext")
					      .data(d3.values(plegend))
					       .enter()
					       .append("text")
					       .text(function(d){return d})
					       .attr("text-anchor", "right")
					       .attr("x", 45)
					       .attr("y", function(d,i){return i * 16 + 14 + def + radiusFlannery(shipsArray[0]) * 3})
					       .attr("class", "legendText")
					    leg.selectAll("toptext")
					      .data(["Compliance status"])
					       .enter()
					       .append("text")
					       .text(function(d){return d})
					       .attr("text-anchor", "right")
					       .attr("x", 16)
					       .attr("y", def + radiusFlannery(shipsArray[0]) * 3 - 5)
					       .attr("class", "legendTitle")


					    //time slider
						var margin = {top: 20, right: 25, left: 25},
						    width = $(".col-md-8").width(),
						    height = 100

						$("#timeDiv").height(50)

						var Ssvg = d3.select("#timeDiv").append("svg")
						.attr("id", "timer")
						    .style({"height": height+margin.top, "width": width+margin.right})

						var timeScale =  d3.scale.ordinal()
						    .domain(d3.keys(dates))
						   .rangeRoundBands([0, width-margin.right]);


						// initial value
						var brushT = d3.svg.brush()
						  .x(timeScale)
						  .extent([d3.keys(dates)[0], d3.keys(dates).length-1])
						  .on("brush", brushedT)

						//var heightx = height100-40
						var pad = 30

						Ssvg.append("g")
						  .attr("class", "x axis legendText")
						  .attr("transform", "translate("+0+"," + 20+ ")")
						// inroduce axis
						.call(d3.svg.axis()
						  .scale(timeScale)
						  .orient("bottom")
						  .tickFormat(function(d) {
						    return d;
						  })
						  .tickSize(5)
						  .tickPadding(12)
						  .tickValues(d3.keys(dates)))
						  .selectAll("text")
    						.attr("transform", "rotate(-45)")
    						.attr("y", "3em")
    						.attr("x", "-1em")
    						.style("font-weight", function (d){
					       	if (d==time){return "bolder"}
					       })
						  .select(".domain")
						  .select(function() {
						    return this.parentNode.appendChild(this.cloneNode(true));
						  })
						  .attr("class", "halo")

					    Ssvg.selectAll("toptext")
					      .data(["Time period"])
					       .enter()
					       .append("text")
					       .text(function(d){return d})
					       .attr("text-anchor", "right")
					       .attr("x", width/2-10)
					       .attr("y", 10)
					       .attr("class", "legendText")


						var slider = Ssvg.append("g")
						  .attr("class", "slider")
						  .attr("transform", "translate("+pad+"," + pad+ ")")
						  .call(brushT);

						slider.selectAll(".extent,.resize")
						  .remove();

						slider.select(".background")
							.attr("transform", "translate("+0+"," +0+ ")")
						  .attr("height", 30);

						var handle = slider.append("circle")
						    .attr("class", "handle")
						    .attr("transform", "translate(0," + pad + ")")
						    .attr("r", 9);

						slider
						  .call(brushT.event)


						NProgress.done()
						function brushedT() {
						  var value = brushT.extent()[0];
						  var d0 = closest(value, timeScale.range())
						  brushT.extent([d0,d0])

						  handle.attr("transform", "translate(" + value + ",0)");
						  handle.select('text').text(value);

						  //calculate dates
						  var z = timeScale.range().indexOf(d0)
						  time = d3.keys(dates)[z]
						  svg.selectAll(".circle").remove()
						  Ssvg.select(".axis").selectAll("text")
    						.style("font-weight", function (d){
					       	if (d==time){return "bolder"}
					       })
    						.style("font-size", function (d){
					       	if (d==time){return "14px"}
					       })
					      d3.values(mapData).forEach(function(d){
					       		var obj = {}
					       		obj[d.id]=d["Status"]
					       		map(obj, time)
					      })

						}
					}

/*					function zoomer() {
					  u.attr("transform", "translate(" +  zoom.translate() + ")scale(" + zoom.scale() + ")")
					      .selectAll("path").style("stroke-width", 1 / zoom.scale() + "px" );
					  b.attr("transform", "translate(" +  zoom.translate() + ")scale(" + zoom.scale() + ")")
					      .selectAll("path").style("stroke-width", 1 / zoom.scale() + "px" );
					  svg.selectAll("circle").attr("transform", "translate(" +  zoom.translate() + ")scale(" + zoom.scale() + ")")
					      .attr("r", function (d){
					      return 10//radiusFlannery(d.shipments)/(zoom.scale())
					      })
					      .style("stroke-width", 1 / zoom.scale() + "px" )
					 }*/

					//various helper functions here: calculating flannery's compensation, and svg z-indexing.
					//flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
					var calcFlanneryRadius = function(x, max) {
					  // Flannery Compensation formula as described here:
					  //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
					  // log x * 0.57
					  // anti log
					  var flannery = 0.57;
					  var log = Math.log(x);
					  var r = log * flannery;
					  r = Math.exp(r);
					  return (r);
					};

					var radiusFlannery = function(x) {
					  return flanneryScale(calcFlanneryRadius(x));
					};
					function closest (num, arr) {
					    var curr = arr[0];
					    var diff = Math.abs (num - curr);
					    for (var val = 0; val < arr.length; val++) {
					        var newdiff = Math.abs (num - arr[val]);
					        if (newdiff < diff) {
					            diff = newdiff;
					            curr = arr[val];
					        }
					    }
					    return curr;
					}

					function highlight(data){
					  svg.selectAll(".circle")
					    .transition().duration(500)
					    .style({"opacity": ".2"})
					  svg.selectAll("#"+data.id)
					    .transition().duration(500)
					    .style({"opacity": "1"})
					}

					function dehighlight(data){
					  svg.selectAll(".circle")
					    .transition().duration(500)
					    .style({"opacity": "1"})
					};

					function redraw (base){
					  svg.selectAll(".circle").sort(function (a, b) {
					    if (a != base) return 0;               // a is not the hovered element, send "a" to the back
					    else return 1;                             // a is the hovered element, bring "a" to the front
					  });
					}

				</script>
<br>
<!-- start LA County section -->

<!-- <div class="container">
	<div class="col-md-12" id = "bodyText"><h4><br><br>The Case of Veolia</h4>
		<h5> Veolia is a French transnational corporation, infamously known as the company in part responsible for the Flint water crisis. In Los Angeles County, Veolia has a waste recycling and disposal facility. Despite the “green” face recycling facilities often put forth, this facility has been subject to numerous recurring violations. Urban geographer Laura Pulido (2015) describes the significance of white supremacy in producing environmental injustice. Using the example of a battery recycling facility in majority-Latinx East Los Angeles, Pulido argues that white supremacy does not simply describe hate groups such as the KKK. Rather, it is an attitude of superiority that is much more ubiquitous, which corporations put into practice by knowingly polluting black and brown communities. The case of Veolia extends Pulido’s argument to a transnational level. Not only does the corporation act in continued noncompliance, but it is enabled to do so through transnational trade agreements. They import from 15 sites, mostly on the U.S.-Mexico border.
		</h5>
	</div>
</div><br> -->
<div class="container">
	<div class="row">
		<div class="col-md-4">
		<h4>Continue to next story:</h4>
			<div class="thumbnail portfolio-thumbnail center-block" id = "image">
					<a href = "demographics.html"><img src="img/race-and-income-01.jpg"
					alt="Alberta Tar Sands"/>
					 <p class="imgDescription-col4">What are waste community demographics?</p>
					</a>
			</div>
	</div>
			<div class="col-md-4">
			<h4>Back to Story selection:</h4>
				<div class="thumbnail portfolio-thumbnail center-block" id = "image">
						<a href = "stories.html"><img src="img/storiesLanding.png"
						alt="Alberta Tar Sands"/>
						 <p class="imgDescription-col4">Story selection</p>
						</a>
				</div>
		</div>
		<div class="col-md-4">
			<h4>Further exploration:</h4>
				<div class="thumbnail portfolio-thumbnail center-block" id = "image">
						<a href = "hmm/index.html" target = "blank"><img src="img/hmmLanding.png"
						alt="Alberta Tar Sands"/>
						 <p class="imgDescription-col4">HazMatMapper</p>
						</a>
				</div>
				</div>
		</div>
		</div>
		<br><br>
				<footer class="footer">
					<!-- <div class="container"> -->
						<div class="logos">
						<a href = "http://geography.wisc.edu" target="blank"><img src="img/uwgeog-01.png" alt="UW Geography Logo" hspace="10"></a>
						<a href = "https://www.nsf.gov/" target="blank"><img src="img/nsf-01-01.png" alt="NSF Logo" hspace="10"></a>
						<a href = "http://www.geography.wisc.edu/cartography/" target="blank"><img src="img/uwcart-01-01.png" alt="uwcart Logo" hspace="10"></a>
						</div>
					<!-- </div> -->
				</footer>
	</body>


</html>
