<!DOCTYPE HTML>
<html lang="en">

	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
				<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Lead Trade</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script src='lib/nprogress.js'></script>
			<link rel='stylesheet' href='CSS/nprogress.css'/>
			<script src="lib/w3HTMLinclude.js"></script>

	</head>

	<body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87476640-1', 'auto');
  ga('send', 'pageview');

</script>
	<div w3-include-html="nav.html"></div>
	<script>
	w3IncludeHTML();
	</script>
	<div class="center">
		<div class="jumbotron">
				<div class="container">
						<h1>The Licit Trade in Lead</h1>
				</div>
		</div>
	</div>

		<div class="container map">
			<div class=" col-md-8" id="clean-harbors-shipments-image"></div>
			<div class="col-md-2"></div>
		</div>
		<div class="container">
			<div class="col-md-12 title-container"></div>
			<div class="col-md-12" id = "bodyText"><h4>Tracking the Licit Lead Trade</h4>
				<div class="text">
				<h5>A lot of attention has been paid to lead recently, given its presence in municipal water supplies in cities like Pittsburgh and Flint. In certain concentrations it can lead to developmental problems especially in children. Lead is found in many products, including car batteries. As a valuable material, there's a significant trade in lead recycling. The Washington Post has sought to track the illegal trade of lead, in which US entities send batteries across the border into Mexico, where workers labor under hazardous conditions to scrap them and return the material to the US, where it is reused. Data on this illicit trade is unsurprisingly hard to come by. Here we map the sanctioned trade in lead-containing material into and out of the US in 2012.
				</h5>
				</div>

		<br><br>
			</div>
		</div>
<script>
						//global variables
						var svg, zoomer, path, projection, width100, height100, globalMin, globalMax, arcGroup, exGlobalMin, exGlobalMax, siteKey
						var defaultColor = "#D1D3D4", exDefaultColor = "#4D4D4F"
						var defaultStroke = {"stroke": "#262626", "opacity": 1}
						var u, b, imp, exp;
						var tooltip = d3.tip()
						  .attr('class', 'd3-tip')
						  .offset([-5, 0])
						  .html(function(d) {
						    return "<span style='color:white'>" + d.namer + "</span>";
						  })
						var flanneryScale;
						var format = d3.format(",.0f")  ;
						var smallCircle = 8, bigCircle=32;
						var phase = {"selected":"kg", "unselected": "l"};

						//begin script when window loads
						initialize();

						//the first function called once the html is loaded
						function initialize(){

						  height100 =  window.innerHeight/1.5
						  $(".map").height(height100)
						  width100 = $(".col-md-8").width()

						  svg = d3.select(".col-md-8").classed("svg-container", true).append("svg")
						   .attr("id", "mapSVG")
						   .attr("preserveAspectRatio", "xMinYMin meet")
						   .attr("viewBox", "0 0 "+width100+ " "+height100+"")
						   //class to make it responsive
						   .classed("svg-content-responsive", true);

						  //create map projection
						  projection = d3.geo.albers()
						  .center([-2,40])
						  .scale(height100*1.4)
						  .translate([(width100/2.25), (height100/2)]);


						  path = d3.geo.path()
						    .projection(projection);

						  u = svg.append("g")
						  b = svg.append("g")

						  queue()
						    .defer(d3.json, "data/na.json")
						    .defer(d3.json, "data/borders.json")
						    .await(callback);

						    function callback(error, na, borders){
						      b.selectAll('path')
						        .data(topojson.feature(borders, borders.objects.borders).features)
						        .enter().append("path")
						          .attr("d", path)
						          .attr("class", "borders")


						      u.selectAll("path")
						        .data(topojson.feature(na, na.objects.na).features)
						        .enter().append("path")
						          .attr("d", path)
						          .attr("class", function (d){
						            return d.properties.gu_a3
						          })
						          .attr("id", function (d){
						            return d.properties.postal
						          })
						    };
						  setData();
						}

						function setData(){
							NProgress.start();
						  svg.call(tooltip)
						  d3.select(".title").remove()

							  d3.csv("data/us-exporters-geocoding.csv", function(ExporterData) {
							  	var exLookup = {}
							    ExporterData.forEach(function(d){
							      d.namer = d.USExporterSiteName
							      d.id = d.id
							      d.latitude = +d.latitude
							      d.longitude = +d.longitude
							      d.export = +d.export
							      d.import = +d.import
							      exLookup[d.id] = {"lat": d.latitude, "long": d.longitude}
							    });


							    //do math to filter
							    d3.csv("data/us-importers-data.csv", function(AllData){
							      AllData.forEach(function(d){
							        d.ReceivingFacilityEPAIDNumber = d.ReceivingFacilityEPAIDNumber
							        d.totalQuantityinShipment = +d.totalQuantityinShipment
							      })

							      d3.csv("data/us-exporters-data.csv", function(exData){
							      exData.forEach(function(d){
							        d.exporterID = d.exporterID
							        d.quantity = +d.quantity
							      })

							        AllData = AllData.filter(function(d){return d.units_final == phase.selected && d["Year"] == "2012" && d.fullDescription.toLowerCase().includes("lead")})
							        exData = exData.filter(function(d){return d.units_final == phase.selected && d["Report Year"] == "2012" && d.hazWasteDesc.toLowerCase().includes("lead")})
							         //nest by receiving facility id
							        var exfacilitySum = d3.nest()
							          .key(function(d) { return d.exporterID; }) // EPA ID number
							          .rollup(function(leaves) { return {"id": leaves[0].exporterID,"lat": exLookup[leaves[0].exporterID].lat, "long": exLookup[leaves[0].exporterID].long,"total_waste": d3.sum(leaves, function(d) {return d.quantity;})} }) // sum by receiving facility code
							          .map(exData);
							       	var foreignImporters = d3.nest()
							          .key(function(d) { return d["Receiving Facility Street Address"] }) // EPA ID number
							          .rollup(function(leaves) { return {"id": leaves[0]["Receiving Facility Name"],"lat": leaves[0]["Receiving Facility latitude"], "long": leaves[0]["Receiving Facility longitude"],"total_waste": d3.sum(leaves, function(d) {return d.quantity;})} }) // sum by receiving facility code
							          .map(exData);
							       var foreignExporters = d3.nest()
							          .key(function(d) { return d["exporter_name"] }) // EPA ID number
							          .rollup(function(leaves) { return {"id": leaves[0]["exporter_name"],"lat": leaves[0]["exlat"], "long": leaves[0]["exlong"],"total_waste": d3.sum(leaves, function(d) {return d.quantity;})} }) // sum by receiving facility code
							          .map(AllData);
							        var facilitySum = d3.nest()
							          .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
							          .rollup(function(leaves) { return {"id": leaves[0].ReceivingFacilityEPAIDNumber,"lat": leaves[0].latitude, "long": leaves[0].longitude, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
							          .map(AllData);
							     console.log(AllData)
						    siteKey={}
							AllData.forEach(function(d) {
							    siteKey[d.ReceivingFacilityEPAIDNumber] = d.importer_name+" - "+d.importer_city+", "+d.importer_state;
							    siteKey[d.exporter_name] = d.exporter_name+" - "+d.exporter_city+", "+d.exporter_state;
							});
							exData.forEach(function(d) {
							    siteKey[d.exporterID] = d["US Exporter Site Name"]+" - "+d["US Exporter Site City"]+", "+d["US Exporter Site State"];
							    siteKey[d["Receiving Facility Name"]] = d["Receiving Facility Name"]+" - "+d["Receiving Facility City"]+", "+d["Receiving Facility State/Province"];
							});
							console.log(foreignExporters)
							//facilitySum is US imports, exfacilitySum is US exports
							//xxxx is foreign imports, yyyyy is foreign exports

						  //imports calc
						  var dump = d3.values(facilitySum)
						  var max = d3.max(dump, function(d) {return d.total_waste}),
						  min = d3.min(dump, function(d) {return d.total_waste})
						  dump.sort(function(a,b){return b.total_waste-a.total_waste})
						  globalMax = max, globalMin = min

						  var flanMax = calcFlanneryRadius(max);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

						  var tooltip = d3.tip()
						  .attr('class', 'd3-tip')
						  .offset([-5, 0])
						  .html(function(d) {
						    return "<span style='color:white'>" + siteKey[d.id] + "</span>";
						  })
						  console.log(dump)
						  svg.call(tooltip)
						  imp = svg.append("g")
						  imp.selectAll("circle")
						      .data(dump)
						      .enter().append("circle").attr("class", "circle circleOnMap")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d.id})
						      .style("fill", defaultColor)
						      .style(defaultStroke)
						      .attr("cx", function(d) {return projection([d.long, d.lat])[0]; })
						      .attr("cy", function(d) { return projection([d.long, d.lat])[1]; })
						      .on("mouseover", function(d){
						        tooltip.show(d);
						        highlight(d);
						      })
						      .on("mouseout", function(d){
						        tooltip.hide(d);
						        dehighlight(d);
						      })
						      .on("click", function(d){
						      	d3.selectAll(".arc").remove();
						        exportThis(d, latlongs, nest)
						      })
						    imp.selectAll("circle")
						      .transition()
						      .duration(1000)
						      .attr("r", function(d){return radiusFlannery(d.total_waste)})


						 //exports calc
						 dump = d3.values(exfacilitySum)
						  var max = d3.max(dump, function(d) {return d.total_waste}),
						  min = d3.min(dump, function(d) {return d.total_waste})
						 dump.sort(function(a,b){return b.total_waste-a.total_waste})

						  exGlobalMax = max
						  exGlobalMin = min

						  var flanMax = calcFlanneryRadius(max);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);


						    exp = svg.append("g")
						    exp.selectAll("circle")
						      .data(dump)
						      .enter().append("circle").attr("class", "circle circleOnMap")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d.id})
						      .style("fill", exDefaultColor)
						      .style(defaultStroke)
						      .attr("cx", function(d) {return projection([d.long, d.lat])[0]; })
						      .attr("cy", function(d) { return projection([d.long, d.lat])[1]; })
						      .on("mouseover", function(d){
						        tooltip.show(d);
						      })
						      .on("mouseout", function(d){
						        tooltip.hide(d);
						      })
						    exp.selectAll("circle")
						      .transition()
						      .duration(1000)
						      .attr("r", function(d){return radiusFlannery(d.total_waste)})

						  //foreign importers calc
						 dump = d3.values(foreignImporters)
						  var max = d3.max(dump, function(d) {return d.total_waste}),
						  min = d3.min(dump, function(d) {return d.total_waste})
						 dump.sort(function(a,b){return b.total_waste-a.total_waste})

						  globalMax = globalMax > max ? globalMax : max
						  globalMin = globalMin < min ? globalMin : min

						  var flanMax = calcFlanneryRadius(max);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);


						    foreignimps = svg.append("g")
						    foreignimps.selectAll("circle")
						      .data(dump)
						      .enter().append("circle").attr("class", "circle circleOnMap")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d.id})
						      .style("fill", defaultColor)
						      .style(defaultStroke)
						      .attr("cx", function(d) {return projection([d.long, d.lat])[0]; })
						      .attr("cy", function(d) { return projection([d.long, d.lat])[1]; })
						      .on("mouseover", function(d){
						        tooltip.show(d);
						      })
						      .on("mouseout", function(d){
						        tooltip.hide(d);
						      })
						    foreignimps.selectAll("circle")
						      .transition()
						      .duration(1000)
						      .attr("r", function(d){return radiusFlannery(d.total_waste)})


						  //foreign exporters calc
						 dump = d3.values(foreignExporters)
						  var max = d3.max(dump, function(d) {return d.total_waste}),
						  min = d3.min(dump, function(d) {return d.total_waste})
						 dump.sort(function(a,b){return b.total_waste-a.total_waste})

						  exGlobalMax = exGlobalMax > max ? exGlobalMax : max
						  exGlobalMin = exGlobalMin < min ? exGlobalMin : min

						  var flanMax = calcFlanneryRadius(max);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);


						    foreignexps = svg.append("g")
						    foreignexps.selectAll("circle")
						      .data(dump)
						      .enter().append("circle").attr("class", "circle circleOnMap")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d.id})
						      .style("fill", exDefaultColor)
						      .style(defaultStroke)
						      .attr("cx", function(d) {return projection([d.long, d.lat])[0]; })
						      .attr("cy", function(d) { return projection([d.long, d.lat])[1]; })
						      .on("mouseover", function(d){
						        tooltip.show(d);
						      })
						      .on("mouseout", function(d){
						        tooltip.hide(d);
						      })
						    foreignexps.selectAll("circle")
						      .transition()
						      .duration(1000)
						      .attr("r", function(d){return radiusFlannery(d.total_waste)})


						  var flanMax = calcFlanneryRadius(globalMax);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

						  var stringwork2 = ["Importers","Exporters"]
						  var circleData = [[globalMax, defaultColor], [globalMin, defaultColor], [exGlobalMax, exDefaultColor], [exGlobalMin, exDefaultColor]]
						  //var circleSpot = [34, 53, 58, 34, 54, 57]

						  var legendKey = ["Max Imports", "Min Imports","Max Exports", "Min Exports"]


						   var leg = d3.select(".col-md-2").append("svg")
							    .attr("id", "legSVG")
							    .style({"height": height100, "width": width100, "position": "absolute"})


							 leg.selectAll("circle")
						      .data(circleData)
						      .enter()
						      .append("circle")
						      .style(defaultStroke)
						      //.attr("class", function(d) {return data.parent.name})
						      .style("fill", function(d){return d[1]})
						      .attr("r", function(d){return radiusFlannery(d[0])})
						      .attr("cy", function(d,i){
						      	//y position should be function of largest radius
						      	var def = -4 * 16 + height100/1.2
						      	var max = i > 1 ? exGlobalMax : globalMax
						      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])
						      	var position = i == 0 ? def : otherCirclesPosition
						      	position = i > 1 ? position+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : position
						      	return position
						      })
						      .attr("cx", radiusFlannery(globalMax)+20)

						      function yScalar (d,i){
							 	var def = -4 * 16 + height100/1.2
							 	var max = i > 1 ? exGlobalMax : globalMax
						      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])*2
						      	otherCirclesPosition = i > 1 ? otherCirclesPosition+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : otherCirclesPosition
						      	return otherCirclesPosition
							  }

						     leg.selectAll("circletitle")
						      .data(["Amount of waste"])
						       .enter()
						       .append("text")
						       .text(function(d){return d})
						       .attr("text-anchor", "right")
						       .attr("x", 16)
						       .attr("y", -4 * 16 + height100/1.35)
						       .attr("class", "legendTitle")


						     leg.selectAll("circletext")
						      .data(circleData)
						       .enter()
						       .append("text")
						       .text(function(d, i){return legendKey[i]+": "+format(d[0])+" "+phase.selected})
						       .attr("text-anchor", "right")
						       .attr("x", radiusFlannery(globalMax)*2+20)
						       .attr("y",function(d,i){
						       	return yScalar(d,i)
						       })
						       .attr("class", "legendText")


						     leg.selectAll("circlelines")
						     	.data(circleData)
						     	.enter()
						     	.append("line")          // attach a line
							    .style("stroke", "black")  // colour the line
							    .attr("x1", radiusFlannery(globalMax)+20)     // x position of the first end of the line
							    .attr("y1",  function(d,i){
							      	//y position should be function of largest radius
							      	return yScalar(d,i)
						      	})    // y position of the first end of the line
							    .attr("x2", radiusFlannery(globalMax)*2+20)     // x position of the second end of the line
							    .attr("y2", function(d,i){
							      	return yScalar(d,i)
						      	}) //y position of the second end of the line


/*

						  leg.selectAll("flowline")
						    .data([globalMin, globalMax])
						    .enter()
						    .append("rect")
						    //.attr("class", function(d) {return data.parent.name})
						    .style("fill", function(d){return "#252525"})
						    .attr("width", 100)
						    .attr("height", function(d,i){if(i==0){return 2}else{return 15}})
						    .attr("y", function(d,i){if(i==0){return height100/1.1} else{return (height100/1.1) + 20}})
						    .attr("x", 16)

						  leg.selectAll("texts")
						    .data([globalMin, globalMax])
						    .enter()
						    .append('text')
						    .attr("x", 16)
						    .attr("y", function(d,i){if(i==0){return height100/1.1 - 4} else{return (height100/1.1) + 16}})
						    .text(function(d, i){if(i==0){return "Minimum # of shipments: "+ globalMin}else{return "Maximum: "+globalMax}})
						    .attr("class", "legendText")*/
						     d3.select(".title-container").append('div')
							        .attr('class', 'title')
							       	.html('<span class="legendTitle">Show by measure: </span>'+"("+phase.selected+")"+" <span class ='phaser'>"+phase.unselected)
							        .on('click', function(){
							          var temp = phase.selected
							          phase.selected = phase.unselected
							          phase.unselected = temp
							          svg.selectAll("circle").remove()
							          leg.selectAll("circle, line, text").remove()
							          setData()
							        })


						  arcGroup = svg.append('g');
						NProgress.done()
						});
	});
						  });


						};

						function filter() {
						/*   svg.selectAll('circle')
						    .filter(function (d){return d.namer.indexOf("CLEAN HARBOR") == -1}) // >-1
						    .style("fill", "blue")
						    //.remove()
						*/
						}

						function highlight(data){
						  /*svg.selectAll(".circle")
						    .transition().duration(500)
						    .style({"opacity": ".2"})
						  svg.selectAll("#"+data.id)
						    .transition().duration(500)
						    .style({"opacity": "1"})*/
						}

						function dehighlight(data){
						  /*svg.selectAll(".circle")
						    .transition().duration(500)
						    .style({"opacity": "1"})*/
						};

						function drawLinesOver(data, base){
						  //var max = d3.max(data, function(d) {return d.total_waste}),
						  //min = d3.min(data, function(d) {return d.total_waste})

						  lineStroke = d3.scale.sqrt()
						    .domain([globalMin, globalMax])
						    .range([2, 15])

						  //based on: http://bl.ocks.org/enoex/6201948

						  var path = d3.geo.path()
						    .projection(projection);

						// --- Helper functions (for tweening the path)
						        var lineTransition = function lineTransition(path) {
						            path.transition()
						                //NOTE: Change this number (in ms) to make lines draw faster or slower
						                .duration(1500)
						                .attrTween("stroke-dasharray", tweenDash)
						                .each("end", function(d,i) {
						                    ////Uncomment following line to re-transition
						                    //d3.select(this).call(transition);

						                    //We might want to do stuff when the line reaches the target,
						                    //  like start the pulsating or add a new point or tell the
						                    //  NSA to listen to this guy's phone calls
						                    //doStuffWhenLineFinishes(d,i);
						                });
						        };
						        var tweenDash = function tweenDash() {
						            //This function is used to animate the dash-array property, which is a
						            //  nice hack that gives us animation along some arbitrary path (in this
						            //  case, makes it look like a line is being drawn from point A to B)
						            var len = this.getTotalLength(),
						                interpolate = d3.interpolateString("0," + len, len + "," + len);

						            return function(t) { return interpolate(t); };
						        };

						var links = [];
						for(var i=0, len=data.length; i<len; i++){
						    // (note: loop until length - 1 since we're getting the next
						    //  item with i+1)
						        links.push({
						            type: "LineString",
						            coordinates: [
						                [ data[i].long, data[i].lat ],
						                [ base.long, base.lat ]
						            ],
						            shipments: data[i].shipments
						        });
						    }
						var pathArcs = arcGroup.selectAll("arc")
						            .data(links);

						        //enter
						        pathArcs.enter()
						            .append("path")
						            .style({
						                fill: 'none',
						            });

						        //update
						        pathArcs.attr({
						                //d is the points attribute for this path, we'll draw
						                //  an arc between the points using the arc function
						                d: path
						            })
						            .style("stroke", "#252525")
						            .attr("class", "arc")
						            .style('stroke-width', function(d) {return lineStroke(d.shipments)})
						                //'stroke-dasharray': '5'
						            .call(lineTransition); //at end of function call positions?
						}
						//various helper functions here: calculating flannery's compensation, and svg z-indexing.
						//flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
						var calcFlanneryRadius = function(x, max) {
						  // Flannery Compensation formula as described here:
						  //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
						  // log x * 0.57
						  // anti log
						  var flannery = 0.57;
						  var log = Math.log(x);
						  var r = log * flannery;
						  r = Math.exp(r);
						  return (r);
						};

						var radiusFlannery = function(x) {
						  return flanneryScale(calcFlanneryRadius(x));
						};

						function exportThis(data, latlongs, nest){
						  latlongdump = [];
						  var p = nest[data.long]
						  var keys = d3.keys(p)
						  for (var k=0; k<keys.length; k++){
						    latlongdump.push({"lat": p[keys[k]][0].exporterLAT, "long": p[keys[k]][0].exporterLONG, "shipments":p[keys[k]].length})
						  }
						  //draw lines between exporters and this site
						  drawLinesOver(latlongdump, data);
						}
					</script>

	</body>


</html>
