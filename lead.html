<!DOCTYPE HTML>
<html lang="en">

	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
				<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
				<link href="https://fonts.googleapis.com/css?family=Doppio+One" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Lead Waste</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/style2a.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script src='lib/nprogress.js'></script>
			<link rel='stylesheet' href='CSS/nprogress.css'/>
			<script src="lib/w3HTMLinclude.js"></script>

	</head>

	<body>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87476640-1', 'auto');
  ga('send', 'pageview');

</script>
	<div w3-include-html="nav.html"></div>
	<script>
	w3IncludeHTML();
	</script>

		<div class="jumbotron">
						<h1>What does the lead waste trade look like?</h1>
				</div>

		<div class="col-md-8">
			<div class="col-md-12" id = "map"></div>
			<div class="col-md-12" id='button-container'>
				Show by:
	  			<div class="btn-group" data-toggle="buttons" id="selector">
		            <label class="btn btn-primary active" onClick="setData('kg')"  value="kg" >
		            <input type="radio" checked> Kilograms
		          </label>
		          <label class="btn btn-primary" onClick="setData('l')" value="liters">
		            <input type="radio" > Liters
		          </label>
				</div>
			 </div>
		</div>
		<div class="col-md-4">
				<div class="col-md-12">
					<h5>A lot of attention has been paid to lead recently, given its presence in municipal water supplies in cities like Pittsburgh and Flint. In certain concentrations it can contribute to developmental problems especially in children. Lead is found in many products, including car batteries. As a valuable material, there's a significant trade in lead recycling. The Washington Post has sought to <a href="http://www.washingtonpost.com/sf/national/2016/02/26/a-dangerous-export-americas-car-battery-waste-is-making-mexican-communities-sick" target="blank">track the illegal trade of lead</a>, in which U.S. entities send batteries across the border into Mexico, where workers labor under hazardous conditions to scrap them and return the material to the U.S. Data on this illicit trade is unsurprisingly hard to come by. Here we map the sanctioned trade in lead-containing material into and out of the U.S. in 2012.
					</h5>
				</div>

        		<div class="col-md-12" id="leftLegend"></div>
        </div>

<script>
						//global variables
						var svg, zoomer, path, projection, width100, height100, globalMin, globalMax, arcGroup, exGlobalMin, exGlobalMax, siteKey
						var defaultColor = "#D1D3D4", exDefaultColor = "#4D4D4F"
						var defaultStroke = {"stroke": "#262626", "opacity": 1}
						var u, b, imp, exp;
						var tooltip = d3.tip()
						  .attr('class', 'd3-tip')
						  .offset([-5, 0])
						  .html(function(d) {
						    return "<span style='color:white'>" + d.namer + "</span>";
						  })
						var flanneryScale;
						var format = d3.format(",.0f")  ;
						var phase = {"selected":"kg", "unselected": "l"};
						var windowWidth = window.innerWidth
						var smallCircle
						var bigCircle
						var mapScalar
						var mapHeightRatio
						function scaler (){
							if (windowWidth < 500) {
								smallCircle = 4
								bigCircle = 16
								mapScalar = 1.6
								mapHeightRatio = 2
							} else if (windowWidth > 500 && windowWidth < 1500) {
								smallCircle =  9
								bigCircle =  36
								mapScalar = 1.9
								mapHeightRatio = 1.1
							} else if (windowWidth > 1500) {
								smallCircle =  12
								bigCircle =  48
								mapScalar = 2.1
								mapHeightRatio = 1.1
							}
						}
						scaler()


					//begin script when window loads
					initialize();

					//the first function called once the html is loaded
					function initialize(){

					  height100 =  window.innerHeight/1.25
					  $("#map").height(height100/mapHeightRatio )
					  width100 = $("#map").width()
					  svg = d3.select("#map").append("svg")
					    .attr("id", "mapSVG")
					    .attr("height", height100/mapHeightRatio )
					    .attr("width", width100)
					    .attr("position", "absolute")
					    //.style({"height": height100, "width": width100, "position": "absolute"})

					  //create map projection
					  projection = d3.geo.albers()
					  .center([-1,39])
					  .scale(height100/mapHeightRatio *mapScalar)
					  .translate([(width100)/2, (height100/mapHeightRatio )/2]);


						  path = d3.geo.path()
						    .projection(projection);

						  u = svg.append("g")
						  b = svg.append("g")

						  queue()
						    .defer(d3.json, "data/na.json")
						    .defer(d3.json, "data/borders.json")
						    .await(callback);

						    function callback(error, na, borders){
						      b.selectAll('path')
						        .data(topojson.feature(borders, borders.objects.borders).features)
						        .enter().append("path")
						          .attr("d", path)
						          .attr("class", "borders")


						      u.selectAll("path")
						        .data(topojson.feature(na, na.objects.na).features)
						        .enter().append("path")
						          .attr("d", path)
						          .attr("class", function (d){
						            return d.properties.gu_a3
						          })
						          .attr("id", function (d){
						            return d.properties.postal
						          })
						    };
						  setData("kg");
						}

						function setData(type){
							phase.selected=type
							NProgress.start();
							          d3.selectAll("circle, line, text").remove()
						  svg.call(tooltip)
						  d3.select(".title").remove()

							  d3.csv("data/us-exporters-geocoding.csv", function(ExporterData) {
							  	var exLookup = {}
							    ExporterData.forEach(function(d){
							      d.namer = d.USExporterSiteName
							      d.id = d.id
							      d.latitude = +d.latitude
							      d.longitude = +d.longitude
							      d.export = +d.export
							      d.import = +d.import
							      exLookup[d.id] = {"lat": d.latitude, "long": d.longitude}
							    });


							    //do math to filter
							    d3.csv("data/us-importers-data.csv", function(AllData){
							      AllData.forEach(function(d){
							        d.ReceivingFacilityEPAIDNumber = d.ReceivingFacilityEPAIDNumber
							        d.totalQuantityinShipment = +d.totalQuantityinShipment
							      })

							      d3.csv("data/us-exporters-data.csv", function(exData){
							      exData.forEach(function(d){
							        d.exporterID = d.exporterID
							        d.quantity = +d.quantity
							      })

							        AllData = AllData.filter(function(d){return d.units_final == phase.selected && d["Year"] == "2012" && d.fullDescription.toLowerCase().includes("lead")})
							        exData = exData.filter(function(d){return d.units_final == phase.selected && d["Report Year"] == "2012" && d.hazWasteDesc.toLowerCase().includes("lead")})
							         //nest by receiving facility id
							        var exfacilitySum = d3.nest()
							          .key(function(d) { return d.exporterID; }) // EPA ID number
							          .rollup(function(leaves) { return {"type": "exporter", "id": leaves[0].exporterID,"lat": exLookup[leaves[0].exporterID].lat, "long": exLookup[leaves[0].exporterID].long,"total_waste": d3.sum(leaves, function(d) {return d.quantity;})} }) // sum by receiving facility code
							          .map(exData);
							       	var foreignImporters = d3.nest()
							          .key(function(d) { return d["Receiving Facility Street Address"] }) // EPA ID number
							          .rollup(function(leaves) { return {"type": "importer", "id": leaves[0]["Receiving Facility Name"],"lat": leaves[0]["Receiving Facility latitude"], "long": leaves[0]["Receiving Facility longitude"],"total_waste": d3.sum(leaves, function(d) {return d.quantity;})} }) // sum by receiving facility code
							          .map(exData);
							       var foreignExporters = d3.nest()
							          .key(function(d) { return d["exporter_name"] }) // EPA ID number
							          .rollup(function(leaves) { return {"type": "exporter", "id": leaves[0]["exporter_name"],"lat": leaves[0]["exporterLAT"], "long": leaves[0]["exporterLONG"],"total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
							          .map(AllData);
							        var facilitySum = d3.nest()
							          .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
							          .rollup(function(leaves) { return {"type": "importer", "id": leaves[0].ReceivingFacilityEPAIDNumber,"lat": leaves[0].latitude, "long": leaves[0].longitude, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
							          .map(AllData);
								    siteKey={}
									AllData.forEach(function(d) {
									    siteKey[d.ReceivingFacilityEPAIDNumber] = d.importer_name+" - "+d.importer_city+", "+d.importer_state;
									    siteKey[d.exporter_name] = d.exporter_name+" - "+d.exporter_city+", "+d.exporter_state;
									});
									exData.forEach(function(d) {
									    siteKey[d.exporterID] = d["US Exporter Site Name"]+" - "+d["US Exporter Site City"]+", "+d["US Exporter Site State"];
									    siteKey[d["Receiving Facility Name"]] = d["Receiving Facility Name"]+" - "+d["Receiving Facility City"]+", "+d["Receiving Facility State/Province"];
							});
							//facilitySum is US imports, exfacilitySum is US exports
							//xxxx is foreign imports, yyyyy is foreign exports

						  //imports calc
						  var dump = d3.values(facilitySum)
						  var dump2 = d3.values(exfacilitySum)
						  var dump3=d3.values(foreignImporters)
						  var dump4=d3.values(foreignExporters)
						  var dumps = dump.concat(dump2, dump3, dump4)

						  globalMax = d3.max(dumps, function(d) {if(d.type=="importer"){return d.total_waste}})
						  globalMin = d3.min(dumps, function(d) {if(d.type=="importer"){return d.total_waste}})
						  exGlobalMax = d3.max(dumps, function(d) {if(d.type=="exporter"){return d.total_waste}})
						  exGlobalMin = d3.min(dumps, function(d) {if(d.type=="exporter"){return d.total_waste}})

						  dumps.sort(function(a,b){return b.total_waste-a.total_waste})

						  var solidMax = 32668000
						  var liquidMax  = 282766
						  var trigger = phase.selected == "kg" ? solidMax : liquidMax
						  var flanMax = calcFlanneryRadius(trigger);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);

						  var tooltip = d3.tip()
						  .attr('class', 'd3-tip')
						  .offset([-5, 0])
						  .html(function(d) {
						    return "<span style='color:white'>" + siteKey[d.id] + "</span>";
						  })
						  svg.call(tooltip)
						  sites= svg.append("g")
						  sites.selectAll("circle")
						      .data(dumps)
						      .enter().append("circle").attr("class", "circle circleOnMap")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d.id})
						      .style("fill", function(d){
						      	var color = d.type == "importer" ? defaultColor : exDefaultColor
						      	return color
						      })
						      .style(defaultStroke)
						      .attr("cx", function(d) {return projection([d.long, d.lat])[0]; })
						      .attr("cy", function(d) { return projection([d.long, d.lat])[1]; })
						      .on("mouseover", function(d){
						        tooltip.show(d);
						        highlight(d);
						      })
						      .on("mouseout", function(d){
						        tooltip.hide(d);
						        dehighlight(d);
						      })

						    sites.selectAll("circle")
						      .transition()
						      .duration(1000)
						      .attr("r", function(d){return radiusFlannery(d.total_waste)})

						 //LEGEND
						  var stringwork2 = ["Importers","Exporters"]
						  var circleData = [[globalMax, defaultColor], [globalMin, defaultColor], [exGlobalMax, exDefaultColor], [exGlobalMin, exDefaultColor]]
						  //var circleSpot = [34, 53, 58, 34, 54, 57]

						  var legendKey = ["Max Imports", "Min Imports","Max Exports", "Min Exports"]


						   width100 = $("#leftLegend").width()
							var scalar = window.innerWidth < 500 ? 3 : 1.75 //scale based on screen size
							var def = window.innerWidth < 500 ? 40 : 70
							$("#leftLegend").height(height100/scalar)

							d3.select("#leftLegend").append("div")
								.attr("class", "legDiv")
								.style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
							var leg = d3.select("#leftLegend").select(".legDiv").append("svg")
								.attr("id", "legSVG")
								.style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})


							 leg.selectAll("circle")
						      .data(circleData)
						      .enter()
						      .append("circle")
						      .style(defaultStroke)
						      //.attr("class", function(d) {return data.parent.name})
						      .style("fill", function(d){return d[1]})
						      .attr("r", function(d){return radiusFlannery(d[0])})
						      .attr("cy", function(d,i){
						      	//y position should be function of largest radius
						      	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
						      	var max = i > 1? exGlobalMax : globalMax
						      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])
						      	var position = i == 0 ? def : otherCirclesPosition
						      	position = i > 1 ? position+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : position
						      	return position
						      })
						      .attr("cx", radiusFlannery(globalMax)+20)

						      function yScalar (d,i){
							 	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
							 	var max = i > 1 ? exGlobalMax : globalMax
						      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d[0])*2
						      	otherCirclesPosition = i > 1 ? otherCirclesPosition+2*radiusFlannery(max)+radiusFlannery(exGlobalMax) : otherCirclesPosition
						      	return otherCirclesPosition
							  }

						     leg.selectAll("circletitle")
						      .data(["Amount of Waste"])
						       .enter()
						       .append("text")
						       .text(function(d){return d})
						       .attr("text-anchor", "right")
						       .attr("x", 16)
						       .attr("y", 10) // + height100/1.5
						       .attr("class", "legendTitle")


						     leg.selectAll("circletext")
						      .data(circleData)
						       .enter()
						       .append("text")
						       .text(function(d, i){return legendKey[i]+": "+format(d[0])+" "+phase.selected})
						       .attr("text-anchor", "right")
						       .attr("x", radiusFlannery(globalMax)*2+20)
						       .attr("y",function(d,i){
						       	return yScalar(d,i)
						       })
						       .attr("class", "legendText")


						     leg.selectAll("circlelines")
						     	.data(circleData)
						     	.enter()
						     	.append("line")          // attach a line
							    .style("stroke", "black")  // colour the line
							    .attr("x1", radiusFlannery(globalMax)+20)     // x position of the first end of the line
							    .attr("y1",  function(d,i){
							      	//y position should be function of largest radius
							      	return yScalar(d,i)
						      	})    // y position of the first end of the line
							    .attr("x2", radiusFlannery(globalMax)*2+20)     // x position of the second end of the line
							    .attr("y2", function(d,i){
							      	return yScalar(d,i)
						      	}) //y position of the second end of the line



						  arcGroup = svg.append('g');
						NProgress.done()
						});
	});
						  });


						};

						function filter() {
						/*   svg.selectAll('circle')
						    .filter(function (d){return d.namer.indexOf("CLEAN HARBOR") == -1}) // >-1
						    .style("fill", "blue")
						    //.remove()
						*/
						}

						function highlight(data){
						  /*svg.selectAll(".circle")
						    .transition().duration(500)
						    .style({"opacity": ".2"})
						  svg.selectAll("#"+data.id)
						    .transition().duration(500)
						    .style({"opacity": "1"})*/
						}

						function dehighlight(data){
						  /*svg.selectAll(".circle")
						    .transition().duration(500)
						    .style({"opacity": "1"})*/
						};

						function drawLinesOver(data, base){
						  //var max = d3.max(data, function(d) {return d.total_waste}),
						  //min = d3.min(data, function(d) {return d.total_waste})

						  lineStroke = d3.scale.sqrt()
						    .domain([globalMin, globalMax])
						    .range([2, 15])

						  //based on: http://bl.ocks.org/enoex/6201948

						  var path = d3.geo.path()
						    .projection(projection);

						// --- Helper functions (for tweening the path)
						        var lineTransition = function lineTransition(path) {
						            path.transition()
						                //NOTE: Change this number (in ms) to make lines draw faster or slower
						                .duration(1500)
						                .attrTween("stroke-dasharray", tweenDash)
						                .each("end", function(d,i) {
						                    ////Uncomment following line to re-transition
						                    //d3.select(this).call(transition);

						                    //We might want to do stuff when the line reaches the target,
						                    //  like start the pulsating or add a new point or tell the
						                    //  NSA to listen to this guy's phone calls
						                    //doStuffWhenLineFinishes(d,i);
						                });
						        };
						        var tweenDash = function tweenDash() {
						            //This function is used to animate the dash-array property, which is a
						            //  nice hack that gives us animation along some arbitrary path (in this
						            //  case, makes it look like a line is being drawn from point A to B)
						            var len = this.getTotalLength(),
						                interpolate = d3.interpolateString("0," + len, len + "," + len);

						            return function(t) { return interpolate(t); };
						        };

						var links = [];
						for(var i=0, len=data.length; i<len; i++){
						    // (note: loop until length - 1 since we're getting the next
						    //  item with i+1)
						        links.push({
						            type: "LineString",
						            coordinates: [
						                [ data[i].long, data[i].lat ],
						                [ base.long, base.lat ]
						            ],
						            shipments: data[i].shipments
						        });
						    }
						var pathArcs = arcGroup.selectAll("arc")
						            .data(links);

						        //enter
						        pathArcs.enter()
						            .append("path")
						            .style({
						                fill: 'none',
						            });

						        //update
						        pathArcs.attr({
						                //d is the points attribute for this path, we'll draw
						                //  an arc between the points using the arc function
						                d: path
						            })
						            .style("stroke", "#252525")
						            .attr("class", "arc")
						            .style('stroke-width', function(d) {return lineStroke(d.shipments)})
						                //'stroke-dasharray': '5'
						            .call(lineTransition); //at end of function call positions?
						}
						//various helper functions here: calculating flannery's compensation, and svg z-indexing.
						//flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
						var calcFlanneryRadius = function(x, max) {
						  // Flannery Compensation formula as described here:
						  //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
						  // log x * 0.57
						  // anti log
						  var flannery = 0.57;
						  var log = Math.log(x);
						  var r = log * flannery;
						  r = Math.exp(r);
						  return (r);
						};

						var radiusFlannery = function(x) {
						  return flanneryScale(calcFlanneryRadius(x));
						};

						function exportThis(data, latlongs, nest){
						  latlongdump = [];
						  var p = nest[data.long]
						  var keys = d3.keys(p)
						  for (var k=0; k<keys.length; k++){
						    latlongdump.push({"lat": p[keys[k]][0].exporterLAT, "long": p[keys[k]][0].exporterLONG, "shipments":p[keys[k]].length})
						  }
						  //draw lines between exporters and this site
						  drawLinesOver(latlongdump, data);
						}
					</script>

					<div class="container">
						<div class="row">
							<div class="col-md-4">
							<h4>Continue to next story:</h4>
								<div class="thumbnail portfolio-thumbnail center-block" id = "image">
										<a href = "oilsands.html"><img src="img/oilsands2.png"
										alt="Alberta Tar Sands"/>
										 <p class="imgDescription-col4">What happens to byproducts from oil sands?</p>
										</a>
								</div>
						</div>
							<div class="col-md-4">
							<h4>Back to Story selection:</h4>
								<div class="thumbnail portfolio-thumbnail center-block" id = "image">
										<a href = "stories.html"><img src="img/storiesLanding.png"
										alt="Alberta Tar Sands"/>
										 <p class="imgDescription-col4">Story selection</p>
										</a>
								</div>
						</div>
						<div class="col-md-4">
							<h4>Further exploration:</h4>
								<div class="thumbnail portfolio-thumbnail center-block" id = "image">
										<a href = "hmm/index.html" target = "blank"><img src="img/hmmLanding.png"
										alt="Alberta Tar Sands"/>
										 <p class="imgDescription-col4">HazMatMapper</p>
										</a>
								</div>
								</div>
						</div>
						</div>
						<br><br>
						<footer class="footer">
								<div w3-include-html="footer.html"></div>
						</footer>
	</body>


</html>
