<!DOCTYPE html>
<meta charset="utf-8">
<style>



</style>
<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
      	<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Doppio+One" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Which companies export waste from the US?</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/style2a.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script src='lib/nprogress.js'></script>
			<link rel='stylesheet' href='CSS/nprogress.css'/>
			<script src="lib/w3HTMLinclude.js"></script>

	</head>

	<body>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87476640-1', 'auto');
  ga('send', 'pageview');

</script>
	<div w3-include-html="nav.html"></div>
	<script>
	w3IncludeHTML();
	</script>

		<div class="jumbotron">
				<h1>Which companies export waste from the US?<</h1>
		</div>


		<div class="col-md-8">
			<div class="col-md-12" id = "map"></div>
			<div class="col-md-12" id='button-container'>
				Show by:
	  			<div class="btn-group" data-toggle="buttons" id="selector">
		            <label class="btn btn-primary active" onClick="setData('kg')"  value="kg" >
		            <input type="radio" checked> Kilograms
		          </label>
		          <label class="btn btn-primary" onClick="setData('l')" value="liters">
		            <input type="radio" > Liters
		          </label>
				</div>
			 </div>
		</div>
		<div class="col-md-4" id = "textColumn">
				<div class="col-md-12" id = "bodyText">
		        <div class="text">
				<h5>
				From 2005-2012, there were over 411 exporters of hazardous waste in the United States. Several of these exporting sites are owned by Clean Harbors. A major <a href="imports.html">importer</a> of hazardous waste into the US, Clean Harbors also operates a number of export facilities. Take a look at the map. Do you see the concentration of hazardous waste facilities in the eastern and northeastern United States? These facilities have easy access to Canada, which is where a majority of these companies send their waste. By switching the view from kilograms to liters, a large concentration of exporters is visible around the Great Lakes. It can be costly to ship heavy liquid waste, which may explain why we see US exporters of liquid wastes only very close to processing facilities in Canada.

				<h6><i>*Data for 2005-2010 is incomplete.</i></h6>
				<br>
				</div>
				</div>
        		<div class="col-md-12" id="leftLegend"></div>
        </div>
<script>
					//global variables

					var svg, zoomer, projection, width100, height100, dataz, max, circleMax, path;
					var defaultColor = "#D1D3D4", exDefaultColor = "#4D4D4F"
							var defaultStroke = {"stroke": "#262626", "opacity": 1}
					var zoom = d3.behavior.zoom()
					    .scaleExtent([1, 12])
					    .on("zoom",zoomer);
					var u, b, imp, exp;
					var tooltip = d3.tip()
					  .attr('class', 'd3-tip')
					  .offset([-5, 0])
					  .html(function(d) {
					  	console.log(d)
					    return "<span style='color:white'>" + dataz[d.key].name + ": "+ format(d.values.total_waste)+ " "+ phase.selected +"</span>";
					  })
					var flanneryScale;
					var phase = {"selected":"kg", "unselected": "l"}
					var format = d3.format(",.0f")  ;
					//scale circle sizes
					var windowWidth = window.innerWidth
					var smallCircle 
					var bigCircle 
					var mapScalar 
					var mapHeightRatio
					function scaler (){
						if (windowWidth < 500) {
							smallCircle = 4 
							bigCircle = 16 
							mapScalar = 1.6 
							mapHeightRatio = 2
						} else if (windowWidth > 500 && windowWidth < 1500) {
							smallCircle =  9
							bigCircle =  36
							mapScalar = 2.1
							mapHeightRatio = 1.2
						} else if (windowWidth > 1500) {
							smallCircle =  12
							bigCircle =  48
							mapScalar = 2.1
							mapHeightRatio = 1.1
						}
					}
					scaler()
					

					//begin script when window loads
					initialize();

					//the first function called once the html is loaded
					function initialize(){

					  height100 =  window.innerHeight/1.25
					  $("#map").height(height100/mapHeightRatio )
					  width100 = $("#map").width()
					  svg = d3.select("#map").append("svg")
					    .attr("id", "mapSVG")
					    .attr("height", height100/mapHeightRatio )
					    .attr("width", width100)
					    .attr("position", "absolute")
					    //.style({"height": height100, "width": width100, "position": "absolute"})

					  //create map projection
					  projection = d3.geo.albers()
					  .center([-1,39])
					  .scale(height100/mapHeightRatio *mapScalar)
					  .translate([(width100)/2, (height100/mapHeightRatio )/2]);

					  path = d3.geo.path()
					    .projection(projection);

					  u = svg.append("g")
					  b = svg.append("g")

					  queue()
					    .defer(d3.json, "data/na.json")
					    .defer(d3.json, "data/borders.json")
					    .await(callback);

					    function callback(error, na, borders){
					      //svg.call(zoom);

					      b.selectAll('path')
					        .data(topojson.feature(borders, borders.objects.borders).features)
					        .enter().append("path")
					          .attr("d", path)
					          .attr("class", "borders")


					      u.selectAll("path")
					        .data(topojson.feature(na, na.objects.na).features)
					        .enter().append("path")
					          .attr("d", path)
					          .attr("class", function (d){
					            return d.properties.gu_a3
					          })
					          .attr("id", function (d){
					            return d.properties.postal
					          })
					    };
					  setData("kg");
					}

					function setData(type){
						phase.selected=type
					 NProgress.start()
					  d3.selectAll("circle, line, text").remove()

					  svg.call(tooltip)

					  d3.csv("data/us-exporters-geocoding.csv", function(ExporterData) {
					    ExporterData.forEach(function(d){
					      d.namer = d.USExporterSiteName
					      d.id = d.id
					      d.latitude = +d.latitude
					      d.longitude = +d.longitude
					    });

					    dataz = []
					    for (r =0; r<ExporterData.length; r++){dataz[ExporterData[r].id] = {"name": ExporterData[r].namer, "latitude": ExporterData[r].latitude, "longitude": ExporterData[r].longitude}}

					      d3.csv("data/us-exporters-data.csv", function(exData){
					      exData.forEach(function(d){
					        d.exporterID = d.exporterID
					        d.quantity = +d.quantity
					      })

					        exData = exData.filter(function(d){return d.units_final==phase.selected})


					        //nest by receiving facility id
					        var exfacilitySum = d3.nest()
					          .key(function(d) { return d.exporterID; }) // EPA ID number
					          .rollup(function(leaves) { return {"total_waste": d3.sum(leaves, function(d) {return d.quantity;})} }) // sum by receiving facility code
					          .entries(exData);

					        //Imports side (right)
					        max = d3.max(exfacilitySum, function(d){return d.values.total_waste});
					        min = d3.min(exfacilitySum, function(d){return d.values.total_waste})
					        mean = d3.mean(exfacilitySum, function(d){return d.values.total_waste})

					        var flanMax = calcFlanneryRadius(max);
					        flanneryScale = d3.scale.sqrt().domain([10, flanMax]).range([smallCircle, bigCircle]);

					        exfacilitySum.sort(function(a, b){return b.values.total_waste-a.values.total_waste})

					        var exp = svg.append("g")
					        exp.selectAll("circle")
					          .data(exfacilitySum)
					          .enter().append("circle")
					          .attr("class", "exporter circle circleOnMap")
					          .attr("id", function(d){return d.key})
					          .style("fill", exDefaultColor)
					          .style(defaultStroke)
					          .attr("cx", function(d) {return projection([dataz[d.key].longitude, dataz[d.key].latitude])[0]; })
					          .attr("cy", function(d) { return projection([dataz[d.key].longitude, dataz[d.key].latitude])[1]; })
					          .on("mouseover", function(d){
					            tooltip.show(d);
					            highlight(d);
					          })
					          .on("mouseout", function(d){
					            tooltip.hide(d);
					            dehighlight(d);
					          })
					          .on('click', function(d){
					            redraw(d);
					          })

					        exp.selectAll("circle")
					          .transition()
					          .duration(1000)
					          .attr("r", function(d){return radiusFlannery(d.values.total_waste)})


					     	width100 = $("#leftLegend").width()
							var scalar = window.innerWidth < 500 ? 8 : 2.5 //scale based on screen size
							var def = window.innerWidth < 500 ? 70 : 70
							$("#leftLegend").height(height100/scalar)

							d3.select("#leftLegend").append("div")
								.attr("class", "legDiv")
								.style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
							var leg = d3.select("#leftLegend").select(".legDiv").append("svg")
								.attr("id", "legSVG")
								.style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})
						   
						   var array = [max, mean, min]
						   var legend = ["Max", "Mean", "Min"]

					        leg.selectAll("circle")
						    .data(array)
						    .enter()
						    .append("circle")
						    //.attr("class", function(d) {return data.parent.name})
						   .style("fill", exDefaultColor)
					          .style(defaultStroke)
						    .attr("r", function(d){return radiusFlannery(d)})
						    .attr("cy", function(d,i){
						    	var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
						      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d)
						      	var position = i == 0 ? def : otherCirclesPosition
						      	return position
						    })
						    .attr("cx", radiusFlannery(max)+20)

						    function yScalar (d,i){
							 	var def = window.innerWidth < 500 ? 35 : 60
						      	var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d)*2
						      	return otherCirclesPosition
							  }

						 	leg.selectAll("text")
						    .data(array).enter().append('text')
						     .attr("x",  function(d, i){
						        return 2*radiusFlannery(max)+30
						      })
						     .attr("y",function(d,i){
						       	return yScalar(d,i)
						       })
						     .text(function (d,i){return legend[i]+": "+format(d)+" "+phase.selected})
					         .attr("class", "legendText")

					       leg.selectAll("circletitle")
						      .data(["Amount of waste exported"])
						       .enter()
						       .append("text")
						       .text(function(d){return d})
						       .attr("text-anchor", "right")
						       .attr("x", 16)
						       .attr("y", 10)
						       .attr("class", "legendTitle")


						  leg.selectAll("circlelines")
						     	.data(array)
						     	.enter()
						     	.append("line")          // attach a line
							    .style("stroke", "white")  // colour the line
							    .attr("x1", radiusFlannery(max)+20)     // x position of the first end of the line
							    .attr("y1",  function(d,i){
							      	//y position should be function of largest radius
							      	return yScalar(d,i)
						      	})    // y position of the first end of the line
							    .attr("x2", radiusFlannery(max)*2+30)     // x position of the second end of the line
							    .attr("y2", function(d,i){
							      	return yScalar(d,i)
						      	}) //y position of the second end of the line



					  });//end work with data
					})
					/*  svg.append('g').selectAll("rect").data("Click me").enter().append("rect")
					    .attr({"fill": "blue", "width": 20, "height": 20, "x": width100/3, "y": height100/2})
					    .on('click', filter)*/
					NProgress.done()
					};

					function filter() {
					/*   svg.selectAll('circle')
					    .filter(function (d){return d.namer.indexOf("CLEAN HARBOR") == -1}) // >-1
					    .style("fill", "blue")
					    //.remove()
					*/
					}

					function zoomer() {
					  u.attr("transform", "translate(" +  zoom.translate() + ")scale(" + zoom.scale() + ")")
					      .selectAll("path").style("stroke-width", 1 / zoom.scale() + "px" );
					  b.attr("transform", "translate(" +  zoom.translate() + ")scale(" + zoom.scale() + ")")
					      .selectAll("path").style("stroke-width", 1 / zoom.scale() + "px" );
					  svg.selectAll("circle").attr("transform", "translate(" +  zoom.translate() + ")scale(" + zoom.scale() + ")")
					      .attr("r", function (d){
					      var flanMax = calcFlanneryRadius(max)
					      flanneryScale = d3.scale.linear().domain([0, flanMax]).range([10, 35]);
					      return radiusFlannery(d.values.total_waste)/(zoom.scale())
					      })
					      .style("stroke-width", 1 / zoom.scale() + "px" )
					 }

					//various helper functions here: calculating flannery's compensation, and svg z-indexing.
					//flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
					var calcFlanneryRadius = function(x, max) {
					  // Flannery Compensation formula as described here:
					  //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
					  // log x * 0.57
					  // anti log
					  var flannery = 0.57;
					  var log = Math.log(x);
					  var r = log * flannery;
					  r = Math.exp(r);
					  return (r);
					};

					var radiusFlannery = function(x) {
					  return flanneryScale(calcFlanneryRadius(x));
					};


					function highlight(data){
					  svg.selectAll(".circle")
					    .transition().duration(500)
					    .style({"opacity": ".2"})
					  svg.selectAll("#"+data.key)
					    .transition().duration(500)
					    .style({"opacity": "1"})
					}

					function dehighlight(data){
					  svg.selectAll(".circle")
					    .transition().duration(500)
					    .style({"opacity": "1"})
					};

					function redraw (base){
					  svg.selectAll(".circle").sort(function (a, b) {
					    if (a != base) return 0;               // a is not the hovered element, send "a" to the back
					    else return 1;                             // a is the hovered element, bring "a" to the front
					  });
					}

				</script>
        <br><br><br><br>
        <div class="container">
        	<div class="row">
        		<div class="col-md-4">
              <h4>Continue to next story:</h4>
        				<div class="thumbnail portfolio-thumbnail center-block" id = "image">
        						<a href = "imports-exports.html"><img src="img/importsandexports2.png"
        						alt="Imports and Exports"/>
        						 <p class="imgDescription-col4">Which facilities both import and export hazardous waste?</p>
        						</a>
        				</div>
        		</div>
            <div class="col-md-4">
          		<h4>Back to Story selection:</h4>
          			<div class="thumbnail portfolio-thumbnail center-block" id = "image">
          					<a href = "stories.html"><img src="img/storiesLanding.png"
          					alt="Alberta Tar Sands"/>
          					 <p class="imgDescription-col4">Story selection</p>
          					</a>
          			</div>
          	</div>
          	<div class="col-md-4">
          		<h4>Further exploration:</h4>
          			<div class="thumbnail portfolio-thumbnail center-block" id = "image">
          					<a href = "hmm/index.html" target = "blank"><img src="img/hmmLanding.png"
          					alt="Alberta Tar Sands"/>
          					 <p class="imgDescription-col4">HazMatMapper</p>
          					</a>
          			</div>
          			</div>
          	</div>
          	</div>
      	<br><br>
        <footer class="footer">
            <div w3-include-html="footer.html"></div>
        </footer>
	</body>


</html>
