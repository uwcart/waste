<!DOCTYPE HTML>
<html lang="en">

	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->

	<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>HazMatMapper</title>

			<!--put Bootstrap stylesheet links above style.css-->
      <link rel="stylesheet" href="css/bootstrap.min.css">
      <link rel="stylesheet" href="css/style.css">
      <script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
      <script type="text/javascript" src="lib/bootstrap.min.js"></script>
      <script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
      <script type="text/javascript" src="lib/queue.js"></script>
      <script type="text/javascript" src="lib/topojson.v1.min.js"></script>
      <script type="text/javascript" src="lib/tip.js"></script>
      <script type="text/javascript" src="lib/turf.min.js"></script>


	</head>
  <style>
	  .col-md-12, .col-md-8, .col-md-4, .col-md-6, .col-md-2{
	    padding: 2px;
	  }
	  .nav-pills>li>a{
	    padding: 2px;
	  }
	  body{
	    overflow-x: hidden;
	    overflow-y:hidden;
		font-family: 'Roboto Slab', serif;
	    background-color: white;
	  }
	  .line {
		  fill: none;
		  stroke-width: 2px;
	  }

  </style>
	<body>

		<nav class="navbar navbar-default navbar-fixed-top main-navbar"> <!--creates navbar-->

						<div class="navbar-header"> <!--creates the navbar header-->
								<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
										<span class="sr-only">Toggle navigation</span><!--used for screen readers for accessibility-->
										<span class="glyphicon glyphicon-menu-hamburger"></span>
										<span class="menu">Menu</span>
								</button> <!--hamburger button for smaller devices-->
								<a class="navbar-brand" href="../index.html">HazMatMapping</a><!--our website brand name-->
								<h4 class="navbar-text"><font color="#b3a580">U.S. Imports of Hazardous Waste from Canada and Mexico:&nbsp;2007-2012</font></h4>
						</div>

											<!-- Collect the nav links, forms, and other content for toggling -->
					    <div class="collapse navbar-collapse" id="nav1">
					<!--       <form class="navbar-form navbar-right" role="search">
					        <div class="form-group">
					          <input type="text" class="form-control" placeholder="Enter Keyword">
					        </div>
					        <button type="submit" class="btn btn-default">Submit</button>
					      </form> -->
					      <ul class="nav navbar-nav navbar-right">
					        <li><a href="../AboutUs.html">About Us</a></li>
					        <li class="dropdown">
					          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Tools<span class="caret"></span></a>
					          <ul class="dropdown-menu">
					            <li><a href="index.html">HazMatMapper</a></li>
					          </ul>
					        </li>
					        <li class="dropdown">
					          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Content<span class="caret"></span></a>
					          <ul class="dropdown-menu">
					            <li><a href="../Stories.html" class = "dropdownStories">Stories</a></li>
					            <li><a href="../Visuals.html" class = "dropdownVisuals">Visuals</a></li>
					          </ul>
					        </li>

					      </ul>
					    </div><!-- /.navbar-collapse -->

		</nav><!--end navigation bar-->


		<div class="container-fluid main">
		</div>	
	</body>
<script>
//global variables

var svg, sum, zoomer, projection, facilitySum,exporterSum, typeByFacility, typeSum;
var importersReset
var Isvg;
var width100, height100;
var colorKey;
var stringwork1, results//["other sites"];
var liquidChecker = false; //checks to see whether we've just switched to liquids
var povSVG, displaySVG;
var zoomed = false;
var firstTime = true, otherTimes = false, currentYears, siteCount=[], showoptions = [];
var filterDomain = "Site"
var margin = {top: 10, right: 10, bottom: 25, left: 10};
var phase = "Solids";
var view = "Sites";
var viewToggle = "Weight (kg)"
var unit
var chemical = undefined;
var smallCircle = 8, bigCircle=32
var defaultColor = "#D1D3D4", exDefaultColor = "#4D4D4F"
var tooltip, stateTool;
var zoom = d3.behavior.zoom()
	.scaleExtent([1,5])
    .on("zoom",zoomer)
   // .on("dblclick.zoom", null)
var defaultStroke = {"stroke": "#262626", "opacity": 1} //{"stroke": "red", "stroke-width": ".5px"}
var highlighted = {"opacity": .2}
var descriptors = {};
var globalMax, globalMin, exGlobalMax, exGlobalMin
var UNtypeKey = {}, mgmtTypeKey = {}, siteKey = {};
var flanneryScale;
var lineStroke
var u, c, m, border, tsdf, tsdfDisposal, imp, exp, arcGroup;
var filterTypesYear, filterTypesSignal;
var format = d3.format(",.0f")	;
var phaseformat = {"Weight (kg)": "kg", "Volume (l)": "liters", "# of Shipments": "shipments"}
var explanation = {"downloader": "Download our curated data.", "linker": "Share a link to this page", "2008": "We have not yet received data for 2008 from the EPA", "# of Shipments": "Number of separate shipments made. Each shipment may contain several different kinds of waste", "EPA Regions": "There are ten EPA regional offices that work closely with states to manage hazardous waste", "All TSDFs": "TSDFs are facilities which transport, store, or otherwise process waste defined as hazardous", "TSDFs for this Disposal Method": "Show TSDFs that use the same disposal method"}
var ECHOdata
/*var descriptionsStyle = {"bottom": lambdaNOPX/1+"px", "height": (lambdaNOPX/1.15)-(lambdaNOPX/2)+"px"} //descriptions positioning
*/var importerManifests, exporterManifests, globalManifests, globalExManifests, mansbyDestination, mansbyExporter

//begin script when window loads
window.onload = setData();



function setData(phase, years, view){
phase = "Solids"
viewToggle = "Weight (kg)"
unit = "total_waste"

d3.csv("data/us-exporters-geocoding.csv", function(ExporterData) {
							    ExporterData.forEach(function(d){
							      d.namer = d.USExporterSiteName
							      d.id = d.id
							      d.latitude = +d.latitude
							      d.longitude = +d.longitude
							      d.export = +d.export
							      d.import = +d.import
							    });


							    //do math to filter
							    d3.csv("data/data.csv", function(AllData){
							      AllData.forEach(function(d){
							        d.totalQuantityinShipment = +d.totalQuantityinShipment // convert the quantity of waste from string to number
								    d.exporterLAT = +d.exporterLAT
								    d.exporterLONG = +d.exporterLONG
								    d.receivingLat = +d.latitude
								    d.receivingLong = +d.longitude
								    d.receivingFacilityZipCode = +d.receivingfacilityzipcode
							      })

							      d3.csv("data/us-exporters-data-test.csv", function(exData){
							      exData.forEach(function(d){
							        d.exporterID = d.exporterID
							        d.quantity = +d.quantity
							      })

							       
  if (phase == "Solids"){
    var data = AllData.filter(function(row){
      return row["fullDescription"].toLowerCase().includes("solid") || row["hazWasteDesc"].toLowerCase().includes("solid") || (row["units_final"] == "kg" && row["hazWasteDesc"].toLowerCase().indexOf("liquid") == -1)
    })
    exData = exData.filter(function(row){
      return row["hazWasteDesc"].toLowerCase().includes("solid") || (row["units_final"] == "kg" && row["hazWasteDesc"].toLowerCase().indexOf("liquid") == -1)
    })
  } else {
    var data = AllData.filter(function(row){
      return row["fullDescription"].toLowerCase().includes("liquid") || row["hazWasteDesc"].toLowerCase().includes("liquid") || (row["units_final"] == "l" && row["hazWasteDesc"].toLowerCase().indexOf("solid") == -1)
    })
  }


  if (viewToggle == "Weight (kg)"){
    data = data.filter(function(row){
      return row["units_final"] == "kg"
    })
    exData = exData.filter(function(row){
      return row["units_final"] == "kg"
    })
  } else if (viewToggle == "Volume (l)"){
    data = data.filter(function(row){
      return row["units_final"] == "l"
    })
  }
  console.log(exData)
  //if (otherTimes){
  	years = ["2007", "2009", "2010", "2011", "2012"]
    data = data.filter(function(row){
      return row["Year"] == years[0] || row["Year"] == years[1] || row["Year"] == years[2] || row["Year"] == years[3] || row["Year"] == years[4] 
    })
    exData = exData.filter(function(row){
      return row["Report Year"] == years[0] || row["Report Year"] == years[1] || row["Report Year"] == years[2] || row["Report Year"] == years[3] || row["Report Year"] == years[4] 
    })
 //}

  if (chemical){
    data = data.filter(function(row){
      return row["fullDescription"].toLowerCase().includes(chemical.toLowerCase())
    })
  }


  siteKey={}
  data.forEach(function(d) {
    siteKey[d.ReceivingFacilityEPAIDNumber] = d.importer_name;
    siteKey[d.exporter_key] = d.exporter_name;
  });


  var facilitySum = d3.nest()
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .rollup(function(leaves) { return {"total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
  .map(data); //.entries(data)

  var key = d3.keys(facilitySum)
  var importers = facilitySum

  siteCount = d3.nest()
  .key(function(d) { return d.importer_state }) // switch
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber})
  .rollup(function(leaves) { return  d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}) }) //
  .map(data);

  var typeByFacility = d3.nest() //could cut for fly filter calc of types per facility
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // switch
  .key(function(d) { return d.hazWasteDesc; })
  .rollup(function(leaves) { return  d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}) }) //
  .map(data);

  var typeOverall = d3.nest()
  .key(function(d) { return d.hazWasteDesc; })
  .rollup(function(leaves) {
    var x = d3.nest()
    .key(function(e){return e.ReceivingFacilityEPAIDNumber })
    .key(function(e){return e.mgmt })
    .rollup(function(leaves){return d3.sum(leaves, function(d){return d.totalQuantityinShipment})})
    .map(leaves)//leaves.map(function(d){ return d.ReceivingFacilityEPAIDNumber});
    //console.log(x);
    return {"name": leaves[0].hazWasteDesc, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}), "sites":  d3.keys(x), "sitesTotals": x } }) //
  .map(data);

  var quantByExporter =d3.nest() //calculate for each importer, how much each exporter ships
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .key(function(d) { return d.exporter_key})
  .rollup(function(leaves) {return {"name": leaves[0].exporter_key, "lat": leaves[0].exporterLAT, "long": leaves[0].exporterLONG, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;})} }) //
  .map(data);

  var quantByExporterMans =d3.nest() //calculate for each importer, how much each exporter ships
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .key(function(d) { return d.exporter_key})
  .rollup(function(leaves) {
    var x = d3.nest()
    .key(function(e){return e.rcra })
    .map(leaves)
    return {"name": leaves[0].exporter_key, "lat": leaves[0].exporterLAT, "long": leaves[0].exporterLONG, "total_waste": leaves.length}
  }) //
  .map(data);

  var importByYear =d3.nest() //calculate for each importer, how much they get per year
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .key(function(d) { return d.Year})
  .rollup(function(leaves) { return d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}) }) //
  .map(data);

  var importByYearMans =d3.nest() //calculate for each importer, how much they get per year
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .key(function(d) { return d.Year})
  .rollup(function(leaves) {
    var x = d3.nest()
    .key(function(e){return e.rcra })
    .map(leaves)//leaves.map(function(d){ return d.ReceivingFacilityEPAIDNumber});
    //console.log(x);
    return leaves.length }) //
  .map(data);

 // if (firstTime) {flowByYearGlobal.importer.Solids = importByYear}
  //if (liquidChecker) {flowByYearGlobal.importer.Liquids = importByYear}

/*  var methByFacility = d3.nest() //could cut if can filter by meth....
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  //.key(function(d) { return d.hazWasteDesc; })
  .key(function(d) { return d.mgmt; })
  .rollup(function(leaves) { return d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}) }) //
  .map(data);*/

  var meth = d3.nest() //organize methods -> sites and total
  .key(function(d) { return d.mgmt; })
  .rollup(function(leaves) {
    var x = d3.nest()
    .key(function(e){return e.ReceivingFacilityEPAIDNumber })
    .rollup(function(leaves){return d3.sum(leaves, function(d){return d.totalQuantityinShipment})})
    .map(leaves)//leaves.map(function(d){ return d.ReceivingFacilityEPAIDNumber});
    //console.log(x);
    return {"name": leaves[0].mgmt, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}), "sites":  d3.keys(x), "sitesTotals": x } }) //
  .map(data);


    /*var typeOverall = d3.nest()
  .key(function(d) { return d.hazWasteDesc; })
  .rollup(function(leaves) {
    var x = d3.nest()
    .key(function(e){return e.ReceivingFacilityEPAIDNumber })
    .key(function(e){return e.mgmt })
    .rollup(function(leaves){return d3.sum(leaves, function(d){return d.totalQuantityinShipment})})
    .map(leaves)//leaves.map(function(d){ return d.ReceivingFacilityEPAIDNumber});
    //console.log(x);
    return {"name": leaves[0].hazWasteDesc, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}), "sites":  d3.keys(x), "sitesTotals": x } }) //
  .map(data);
*/


  var company = d3.nest() //could cut
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .key(function(d) { return d.company;})
  .rollup(function(leaves) { return d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}) }) //
  .map(data);

  var companies = d3.nest() //organize methods -> sites and total
  .key(function(d) { return d.company; })
  .rollup(function(leaves) {
    var x = d3.nest()
    .key(function(e){return e.ReceivingFacilityEPAIDNumber })
    .map(leaves)//leaves.map(function(d){ return d.ReceivingFacilityEPAIDNumber});
    //console.log(x);
    return {"name": leaves[0].company, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}), "sites":  d3.keys(x) } }) //
  .map(data);

  var importerManifests = d3.nest()
  .key(function(d) {return d.ReceivingFacilityEPAIDNumber;})
  .key(function(d) {return d.rcra})
  .map(data);

  var u = d3.keys(importerManifests), v=[]
  for (w=0; w<u.length; w++) {v[u[w]]=d3.values(importerManifests[u[w]]).length}
  //sum = d3.sum(t), globalSum = sum
  globalManifests = v

  var mansbyDestination= d3.nest()
  .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
  .key(function(d) {return d.exporter_key;})
  .key(function(d) {return d.rcra})
   .map(data);


  var facilityDetails = d3.nest()
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  //.rollup(function(leaves) { return {"total_waste": d3.count(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
  .map(data); //.entries(data)

  var details = ["importer_address","importer_city","importer_name","importer_state","latitude","longitude", "ReceivingFacilityEPAIDNumber"]



        //append type by facility to main object
        key.forEach(function(d){
          importers[d]["name"] = facilityDetails[d][0]["ReceivingFacilityEPAIDNumber"] //additional naming variable for compatibility in icicle
         // importers[d]["types"] = typeByFacility[d]
         // importers[d]["exporters"]  = unit == "total_shipments" ? quantByExporterMans[d]:quantByExporter[d]
          importers[d]["years"] = unit == "total_shipments" ? importByYearMans[d]:importByYear[d]
         // importers[d]["methods"] = methByFacility[d]
         // importers[d]["company"] = company[d]
         // importers[d]["total_shipments"] = globalManifests[d]
        //  importers[d]["shipments"] = mansbyDestination[d]
          //importers[d]["meth"] = d3.values(meth)
         // importers[d]["typeOverall"] = d3.values(typeOverall)
         // importers[d]["companies"] = d3.values(companies)
       //   importers[d]["units"] = phaseformat[viewToggle]
          details.forEach(function(e){
            importers[d][e] = facilityDetails[d][0][e]
          })
/*          var obj = addMap[importers[d]["importer_address"]] ? Object.assign(addMap[importers[d]["importer_address"]],zipMap[importers[d]["receivingFacilityZipCode"]]) : "No data"
          importers[d]["EJ"]=obj*/
        })



        importers = d3.values(importers) //no longer need to be able to easily pop to importers
        importers.sort(function(a,b){return b[unit]-a[unit]})
        importers.forEach(function(d,i){
            d.rank = (i+1)+"/"+importers.length
        })
        importersReset = importers
        console.log(importers)
       
        importByState=d3.nest() //could be duplicative of siteCount
        .key(function(d) { return d.importer_state; }) // EPA ID number
        .rollup(function(leaves) { return d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}) }) //
        .entries(data);


        //exporters object constructor
        var exporterSum = d3.nest()
        .key(function(d) {return d.exporter_key;})
        .rollup(function(leaves) { return {"total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by state code
        .map(exData);

        var detailz = ["latitude","longitude","USExporterSiteName", "id"]
        var exportByYear =d3.nest() //calculate for each importer, how much they get per year
		  .key(function(d) { return d.exporter_key }) // EPA ID number
		  .key(function(d) { return d["Report Year"]})
		  .rollup(function(leaves) { return d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}) }) //
		  .map(exData);
		  console.log(exportByYear)
        var keyz = d3.keys(exporterSum)
        var exporters = exporterSum
        
        keyz.forEach(function(d){
         /* exporters[d]["types"] = typeByExporter[d]
          exporters[d]["importers"] = quantByDesination[d]*/
          exporters[d]["years"] = exportByYear[d]
         /* exporters[d]["total_shipments"] = globalExManifests[d]
          exporters[d]["shipments"] = mansbyExporter[d]
          exporters[d]["units"] = phaseformat[viewToggle]*/

          detailz.forEach(function(e){
          	var filter = ExporterData.filter(function(f){return d == f.id})
           exporters[d][e] = filter[0][e]
          })

        })

        exporters = d3.values(exporters) //no longer need to be able to easily pop to importers
        exporters.sort(function(a,b){return b.total_waste-a.total_waste})
        exporters.forEach(function(d,i){
            d.rank = (i+1)+"/"+exporters.length
        })

       	y = JSON.stringify(exporters)
        //$(".container-fluid").text(y)
        console.log(exporters)
        print(y)

        p =   JSON.stringify(importers)
        //$(".container-fluid").text(y)
        console.log(importers)
        print(p)


      })

	 })

});
}

function print(thing){
  //console.log(thing)
  var data = "text/json;charset=utf-8," + encodeURIComponent(thing);

$('<a href="data:' + data + '" download="allSites.json">download JSON</a>').appendTo('.container-fluid');
}



</script>

</html>
