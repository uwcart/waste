<!DOCTYPE HTML>
<html lang="en">

	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
			<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>All Shipments</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css">
			  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  			<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  			 <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script type="text/javascript" src="lib/d3-save-svg.min.js"></script>
			<script type="text/javascript" src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
			<script src='lib/nprogress.js'></script>
			<link rel='stylesheet' href='CSS/nprogress.css'/>
			<script src="lib/w3HTMLinclude.js"></script>
  <style>
  #custom-handle {
    width: 3em;
    height: 1.6em;
    top: 50%;
    margin-top: -.8em;
    text-align: center;
    line-height: 1.6em;
  }
  .CAN, .MEX, .USA {
  fill: #b2b4b6;
  stroke:#f6f6f6;
  stroke-width: .5px;
}
  </style>
	</head>

	<body>

		<div class="container-fluid">
			<div class="col-md-8 map"></div>
			<div class="col-md-4 leg">
				<p><input id="dl"
			      name="downloadButton"
			      type="button"
			      value="Download Map SVG" />
			    <p>
			    <p><input id="dl2"
			      name="downloadButton"
			      type="button"
			      value="Download Legend SVG" />
			   
				<!-- <p>Line width:
				<div class="row" id="sliderW">
				  <div id="custom-handleW" class="ui-slider-handle"></div>
				</div> -->
				<p>		
			</div>
		</div>
		
	<script>
	
						//global variables
						var svg, zoomer, path, projection, width100, height100, globalMin, globalMax, arcGroup, exGlobalMin, exGlobalMax, siteKey, passwordExporter, password, flowMax, flowMin, pathArcs, leg, fac, sq, cerritos, minorityBuffs, majWhiteBuffs
						var defaultColor = "#dee0e0", exDefaultColor = "#5a5a5c"
						var defaultStroke = {"stroke": "#262626", "stroke-width": .3, "opacity": 1}
						var u, b, imp, exp;
						  var tooltip = d3.tip()
						  .attr('class', 'd3-tip')
						  .offset([-5, 0])
						  .html(function(d) {
						    return "<span style='color:white'>" + siteKey[d] + "</span>";
						  })

						var flanneryScale;
						var format = d3.format(",.0f")  ;
						//scale stuff
						var smallCircle = window.innerWidth < 500 ? 4 : 16
						var bigCircle = window.innerWidth < 500 ? 16 : 64
						var mapScalar = window.innerWidth < 500 ? .9 : 1.3

						//begin script when window loads
						initialize();

						//the first function called once the html is loaded
						function initialize(){

						  height100 =  window.innerHeight
						  $(".map").height(height100)
						  width100 = $(".map").width()

						  svg = d3.select(".map").append("svg")
						   .attr("id", "mapSVG")
						   .style({"height": height100, "width": width100, "position": "absolute"})

						  //create map projection
						  projection = d3.geo.mercator()
						 //.center([-220,25])

						  .translate([(width100/2), (height100/2)]);


						  u = svg.append("g")
						c=svg.append('g')
						minorityBuffs = svg.append("g")
						majWhiteBuffs = svg.append("g")
						  fac = svg.append("g")
						    sq = svg.append("g")
						     b = svg.append("g")
						  queue()
						    .defer(d3.json, "data/LACounties.json")
						    .defer(d3.json, "data/places.json")
						    .await(callback);

						    function callback(error, LACounties, comms){
						      var features = topojson.feature(LACounties, LACounties.objects.LACounties).features
							  var centroids = features.map(function (feature){
							  	//if (d3.geo.centroid(feature)){}
							    return d3.geo.centroid(feature);
							  });
							  //console.log(centroids)
							  var center = centroids[0]
							 // console.log(center)
							  projection.center([-118.20, 34.04]).scale(62000)
  								path = d3.geo.path()
						    	.projection(projection);

						     


						      u.selectAll("path")
						        .data(topojson.feature(LACounties, LACounties.objects.LACounties).features)
						        .enter().append("path")
						          .attr("d", path)
						          .attr("class", function (d){
						            return "MEX"
						          })
						       c.selectAll("path")
						        .data(topojson.feature(comms, comms.objects.places).features)
						        .enter().append("path")
						          .attr("d", path)
						          .attr("class", function (d){
						            return "MEX"
						          })
						        b.selectAll("text")
						        .data(topojson.feature(comms, comms.objects.places).features)
						        .enter().append("text")
						           .attr('x', function(d){
						           	var c = d3.geo.centroid(d)
						           	return projection(c)[0]
						           })
						           .attr('y', function(d){
						           	var c = d3.geo.centroid(d)
						           	return projection(c)[1]
						           })
						          .text(function(d){if (d.properties.CENSUSAREA > 7){return d.properties.NAME}})
						          .attr("font-size", function(d){
						          	if (d.properties.CENSUSAREA >7 && d.properties.CENSUSAREA <30){return "8"}
						          	if (d.properties.CENSUSAREA >30 && d.properties.CENSUSAREA <60){return "12"}
						          	if (d.properties.CENSUSAREA >60){return "14"}
						          })

						        cerritos = topojson.feature(comms, comms.objects.places).features.filter(function(d){return d.properties.NAME == "Cerritos"})

						    };
						  setData();
						}

						function setData(){
						  NProgress.start();
						  svg.call(tooltip)

						  d3.csv("data/LQG.csv", function(data) {
						   //color facilities by RCRAQtrsInNC and make ours bigger...
						   var importers = ["CAD008302903","CAD060398229","CAD066233966"]
						    var totalFacilities = data.length
/*
						    d3.csv("data/lookup.csv", function(info) { 
							  	password = d3.nest()
								  .key(function(d) { return d["ReceivingFacilityEPAIDNumber"] }) // EPA ID number
								  //.rollup(function(leaves) { return {"total_waste": d3.count(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
								  .map(info);
								passwordExporter = d3.nest()
								  .key(function(d) { return d["exporter_key"] }) // EPA ID number
								  //.rollup(function(leaves) { return {"total_waste": d3.count(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
								  .map(info);*/
							

						    /*data = data.filter(function(row){
						      return row["exporter_key"].includes("E53A2583") && row["company"].includes("CLEAN HARBOR") 
						      || row["exporter_key"].includes("E42A0195") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E53A2583") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E43A6647") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E49A4033") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E49A6974") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E42A1378") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E43A0001") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E43A7517") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E45A2109") && row["company"].includes("CLEAN HARBOR")
						      || row["exporter_key"].includes("E45A0884") && row["company"].includes("CLEAN HARBOR")
						    })*/

/*						    var CHShipments = [data.length, (data.length/totalShipments)*100]

						    var exporters = d3.nest() //rollup unique exportlatlongs
						    .key(function(d) {return d.exporter_key;})
						    .rollup(function(leaves) { return {"shipments": leaves.length}})
						    .map(data);
						   
						    var importers = d3.nest() //rollup unique receivinglatlongs
						    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
						    .rollup(function(leaves) { return {"shipments": leaves.length}})
						    .map(data);
						 
						    var nest = d3.nest()
						    .key(function(d) {return d.ReceivingFacilityEPAIDNumber})
						    .key(function(d) {return d.exporter_key;})
						    .rollup(function(leaves) { return {"shipments": leaves.length}})
						    .map(data);
						   
						    //find largest value in nest
						    var dumper = []
						    var nester = d3.values(nest)
						    for (var x=0; x<nester.length; x++){
						    	var tempy =d3.values(nester[x]) 
						    	for (y=0; y<tempy.length; y++){
						    		dumper.push(tempy[y].shipments)
						    	}
						    }
						    flowMax = d3.max(dumper)
						    flowMin = d3.min(dumper)
						    console.log(flowMin, flowMax)

						    siteKey={}
							data.forEach(function(d) {
							    siteKey[d.ReceivingFacilityEPAIDNumber] = password[d.ReceivingFacilityEPAIDNumber][0].importer_name+" - "+password[d.ReceivingFacilityEPAIDNumber][0].importer_city+", "+password[d.ReceivingFacilityEPAIDNumber][0].importer_state;
							    siteKey[d.exporter_key] = passwordExporter[d.exporter_key][0].exporter_name+" - "+passwordExporter[d.exporter_key][0].exporter_city+", "+passwordExporter[d.exporter_key][0].exporter_state;
							});
							

							

						  var map =d3.values(exporters).map(function(d){return d.shipments})
						  var max = d3.max(map),
						  min = d3.min(map), mean = d3.mean(map)

						  var items = d3.keys(exporters).map(function(key) {
							    return [key, exporters[key].shipments];
							});
							// Sort the array based on the second element
							items.sort(function(first, second) {
							    return second[1] - first[1];
							});
						  var exps = items.map(function(d){return d[0]})

						  exGlobalMax = max
						  exGlobalMin = min
						  exGlobalMean=mean

						  var flanMax = calcFlanneryRadius(max);
						  flanneryScale = d3.scale.linear().domain([0, flanMax]).range([smallCircle, bigCircle]);*/

						  	var feature = turf.feature(cerritos[0].geometry);
						    feature = turf.featureCollection(feature)
						  	
						  	var feats = []
						  	data.forEach(function(d){
						  		feats.push(turf.point([Number(d.FacLong), Number(d.FacLat)], d))
						  	})
						  	feats = feats.filter(function(d){return d.properties.FacLong == -118.049551})
						  	
						  	feats = turf.featureCollection(feats);
						  	//console.log(feats)
						        //console.log(cerritos)
						        //var cfeat = [turf.point(cerritos[0].geometry, {name: 'Location A'})]

						    var thePoint = [-118.049551, 3.066965]
						    var test = {
							  "type": "FeatureCollection",
							  "features": [
							    {
							      "type": "Feature",
							      "properties": {},
							      "geometry": {
							        "type": "Point",
							        "coordinates": thePoint
							      }
							    }, {
							      "type": "Feature",
							      "properties": {},
							      "geometry": {
							        "type": "Point",
							        "coordinates": thePoint
							      }
							    }
							  ]
							};

							var cerrito = { "type": "Feature", "properties": { "GEO_ID": "1600000US0612552", "STATE": "06", "PLACE": "12552", "NAME": "Cerritos", "LSAD": "city", "CENSUSAREA": 8.725, "Shape_STAr": 246572616.215, "Shape_STLe": 118080.76087 }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ -118.028887999836968, 33.882629000032836 ], [ -118.028681155924062, 33.873316057140322 ], [ -118.028772420533898, 33.873315497179512 ], [ -118.028772240680681, 33.873285861714471 ], [ -118.028761755934283, 33.872110544548683 ], [ -118.028717388339928, 33.866241889545748 ], [ -118.028792999919617, 33.866240999737094 ], [ -118.035119980483032, 33.866020314132811 ], [ -118.035591866241305, 33.866016576824734 ], [ -118.035818357122793, 33.866015383719059 ], [ -118.035983055259194, 33.866014509762415 ], [ -118.036147752309518, 33.8660136310734 ], [ -118.036148847050185, 33.866013630744973 ], [ -118.037598000415159, 33.866012999764315 ], [ -118.037597881676277, 33.866006075268416 ], [ -118.037624048408333, 33.866005950805395 ], [ -118.037575372135976, 33.86388909386703 ], [ -118.037562273006358, 33.863314044528884 ], [ -118.037540454019165, 33.86236905889217 ], [ -118.037606327718564, 33.862368507358319 ], [ -118.037979218998117, 33.862365367620129 ], [ -118.039225723817765, 33.862354938919154 ], [ -118.039350888987059, 33.862353881198253 ], [ -118.039574899257346, 33.862352021930512 ], [ -118.039782079613744, 33.862350277788913 ], [ -118.039963633664883, 33.86234876086143 ], [ -118.040128290807047, 33.862347360175178 ], [ -118.040309482829713, 33.862345842847105 ], [ -118.040474501989308, 33.862344468612086 ], [ -118.040655693999881, 33.862342951664914 ], [ -118.040820383551591, 33.862341577067333 ], [ -118.041001575536058, 33.862340031653119 ], [ -118.041166594672802, 33.862338656470193 ], [ -118.041522357556943, 33.86233567659459 ], [ -118.041555328956449, 33.86233539026582 ], [ -118.04158826686961, 33.86233513188656 ], [ -118.041667975939376, 33.862334444439369 ], [ -118.041884905794092, 33.862332720355347 ], [ -118.041879045435579, 33.861679208477895 ], [ -118.041878661410877, 33.861635133586446 ], [ -118.041877779312557, 33.861530668241585 ], [ -118.041877117333357, 33.861453668349675 ], [ -118.041875622573116, 33.86128871703405 ], [ -118.041874434390664, 33.861151243763409 ], [ -118.04187324622599, 33.86101379844164 ], [ -118.041872056970632, 33.860876325175354 ], [ -118.041870868813831, 33.86073887985755 ], [ -118.041869613384449, 33.860598713795902 ], [ -118.041868145114535, 33.860428321848957 ], [ -118.04186653720933, 33.860242294996745 ], [ -118.041865207827939, 33.860088170827417 ], [ -118.041854341147129, 33.858838905318855 ], [ -118.041854202456747, 33.8588251662961 ], [ -118.041853336146318, 33.858724067229424 ], [ -118.046188000416265, 33.858768000030139 ], [ -118.046186748924541, 33.858687270846296 ], [ -118.046200389259099, 33.858687186283355 ], [ -118.046186014574644, 33.857785576122218 ], [ -118.046163305133547, 33.856407842019244 ], [ -118.046152668322023, 33.855664249739483 ], [ -118.046110568906883, 33.853648342941831 ], [ -118.04611084525645, 33.853610518941778 ], [ -118.047386006877716, 33.853589266798537 ], [ -118.048728911992114, 33.853575817845297 ], [ -118.049101279351319, 33.853572084045524 ], [ -118.049609117085879, 33.853568105873244 ], [ -118.05041069369274, 33.85356182224956 ], [ -118.050410420346836, 33.853533108261765 ], [ -118.050405543181043, 33.853033914419463 ], [ -118.050399505365675, 33.852413871433946 ], [ -118.050398863336483, 33.852345210650313 ], [ -118.050398171596498, 33.852276536365281 ], [ -118.050395364025476, 33.851988181322085 ], [ -118.050394029188837, 33.851850845358634 ], [ -118.0503926949755, 33.851712741307736 ], [ -118.050392161744654, 33.85165789437027 ], [ -118.050391361261092, 33.851575460340229 ], [ -118.050390027518588, 33.85143812528397 ], [ -118.050388692733023, 33.851300845222546 ], [ -118.050387326600486, 33.851163537229304 ], [ -118.050386025351628, 33.851026311248653 ], [ -118.050383464434944, 33.850765297230296 ], [ -118.050382854871259, 33.850696677914939 ], [ -118.050382130718276, 33.850627962186074 ], [ -118.050379462200738, 33.850353264157327 ], [ -118.050375711015633, 33.849966976406435 ], [ -118.053892316950595, 33.849848893473471 ], [ -118.054516818610182, 33.849844709837626 ], [ -118.054590588300428, 33.849844214857512 ], [ -118.054722683312946, 33.849843325535495 ], [ -118.054722478592268, 33.849821017688754 ], [ -118.054723000454345, 33.849821000322997 ], [ -118.054716601109988, 33.84918063060708 ], [ -118.054705566290011, 33.84797815444341 ], [ -118.054700499743277, 33.847440996646093 ], [ -118.054689180780002, 33.846217950124199 ], [ -118.054776697011036, 33.846215943261306 ], [ -118.056046115878445, 33.846208952311493 ], [ -118.057043290604042, 33.846203779261714 ], [ -118.058278859805654, 33.846196339066665 ], [ -118.059040364775043, 33.846192198135391 ], [ -118.059040016006662, 33.846124967096777 ], [ -118.060671000051059, 33.846177999563118 ], [ -118.06338900026266, 33.84615300022368 ], [ -118.065990999985502, 33.846131999565429 ], [ -118.072090999789609, 33.846084000390604 ], [ -118.081980999696881, 33.84600600023699 ], [ -118.08202099972182, 33.849640999592488 ], [ -118.086370999820048, 33.84963300020425 ], [ -118.086368999500323, 33.845970999859297 ], [ -118.086803999550057, 33.845968999565606 ], [ -118.092398000044483, 33.845925000070416 ], [ -118.098939000208091, 33.845875000320532 ], [ -118.09921100033479, 33.845875999972094 ], [ -118.100211999558695, 33.848065999601282 ], [ -118.101733000020189, 33.853478000147867 ], [ -118.103054999461108, 33.858318000193101 ], [ -118.108316999981298, 33.858371000240467 ], [ -118.108428999611235, 33.865586999998889 ], [ -118.108536000018645, 33.872715000058548 ], [ -118.106910000099688, 33.872711000330419 ], [ -118.106974000434647, 33.872942999957047 ], [ -118.108003999515034, 33.876790000315744 ], [ -118.108546999473432, 33.87984299979373 ], [ -118.108563999545112, 33.886942999906346 ], [ -118.108417999623612, 33.886938999677412 ], [ -118.108160000123547, 33.886939999577628 ], [ -118.104370000310539, 33.886968000366373 ], [ -118.10425600018489, 33.887381999848436 ], [ -118.100572999781591, 33.887395000134291 ], [ -118.100547000184832, 33.886982999787215 ], [ -118.09988300024132, 33.886990000446659 ], [ -118.09988699995877, 33.88740200023738 ], [ -118.095532999746752, 33.887425999876328 ], [ -118.095537999774862, 33.88211299995568 ], [ -118.095466999498029, 33.880314000301986 ], [ -118.09541300051032, 33.87852799995575 ], [ -118.09380399970361, 33.87855300002056 ], [ -118.091064999993833, 33.878859999883623 ], [ -118.091085999524168, 33.88032599969636 ], [ -118.087806000080136, 33.880338000092316 ], [ -118.087776999582886, 33.876750000365199 ], [ -118.091033999660468, 33.876416000198674 ], [ -118.090991999619234, 33.8729809995612 ], [ -118.090990999805427, 33.865683999854205 ], [ -118.090901000460704, 33.861313000431181 ], [ -118.089982999574389, 33.861319000332337 ], [ -118.089973999821112, 33.860224999604107 ], [ -118.086482999908952, 33.860250000054762 ], [ -118.086474999522395, 33.85842399971353 ], [ -118.086450000287186, 33.856003999941251 ], [ -118.082092000279232, 33.856040000312333 ], [ -118.082110999618877, 33.860495000048402 ], [ -118.078810999737044, 33.85847399969186 ], [ -118.075151000444947, 33.856228000446528 ], [ -118.072288000163809, 33.856968999864691 ], [ -118.072240999730425, 33.854512000252328 ], [ -118.070459000360898, 33.853411000398474 ], [ -118.068915000458702, 33.853423000135727 ], [ -118.069006999624165, 33.858557000390903 ], [ -118.071223999523767, 33.858534999730935 ], [ -118.070178000376117, 33.860339000416801 ], [ -118.070294000094378, 33.865815999626136 ], [ -118.070313999561719, 33.869456999865655 ], [ -118.0724970001271, 33.869453999697591 ], [ -118.070334999534126, 33.869835999844774 ], [ -118.070384000066582, 33.873111000077408 ], [ -118.08004299960642, 33.873053999696083 ], [ -118.07964899968843, 33.876462000326832 ], [ -118.07927399950583, 33.87674000007636 ], [ -118.075086999544695, 33.8767670000233 ], [ -118.074840999957502, 33.876769000254562 ], [ -118.074895000371953, 33.880383000438925 ], [ -118.072708000101883, 33.880391999903772 ], [ -118.072825000397017, 33.885832999950722 ], [ -118.068447000489812, 33.885887999807679 ], [ -118.06846999965768, 33.887112000073593 ], [ -118.068475999850449, 33.887559000148578 ], [ -118.066323999719302, 33.887571000149549 ], [ -118.06528799964515, 33.887577000140304 ], [ -118.064333000067364, 33.887581999621858 ], [ -118.06408499971505, 33.887165000021376 ], [ -118.055376000176864, 33.887216000217663 ], [ -118.055382999695453, 33.887649999683752 ], [ -118.046538999840678, 33.887713000322073 ], [ -118.038572000150765, 33.88777300012908 ], [ -118.028887999836968, 33.882629000032836 ] ] ] ] } }

							var cerritoPolygon = turf.polygon(cerrito.geometry.coordinates[0]) //turn cerrito multipolygon into polygon

							var cerritoFeatureCollection = turf.featureCollection(cerritoPolygon) //create a feature collection

						  	var ptsWithin = turf.within(test, cerritoFeatureCollection); //see if test points are within the cerrito featureCollection

						  	var pt = turf.point(thePoint);

						  	var isInside = turf.inside(pt, cerritoPolygon);

						    //console.log(ptsWithin)//returns a feature with an empty features array
						    //console.log(isInside)//returns true - thePoint is in cerrito


						    //console.log(data)

						    var dump2 = data.map(function(d){return Number(d.FacPercentMinority)})
						    
						    var colorMin = d3.scale.threshold()
						    .domain([50, 80])
						    .range(["#3182bd", "#ffeda0", "#f03b20"])

						    var dump = data.map(function(d){return Number(d.FacPercentMinority)})
						    var med = d3.median(dump)
						    var aboveMedianMinoritySites = data.filter(function(d){return Number(d.FacPercentMinority) > 72.5})  //72.5 is %minority across entire county based on total pop numbers from census
						    var aboveMedianMinoritySites12SNC = aboveMedianMinoritySites.filter(function(d){return Number(d.RCRAQtrsInSNC) > 0})
						    
						    var feats = [], buffs = []
						  	aboveMedianMinoritySites12SNC.forEach(function(d){
						  		feats.push(turf.point([Number(d.FacLong), Number(d.FacLat)], d))
						  	})
						    feats.forEach(function(d){
						    	var x = turf.circle(d, 3, 64, "miles")
						    	x.properties = d.properties
						    	x.properties.dissolve = "yes" 
						    	buffs.push(x)
						    })
						    var featsMin = feats
						    var FC = turf.featureCollection(buffs)
						    var dissolved = turf.dissolve(FC, 'combine');
						    minorityBuffs.selectAll("path")
						        .data(buffs)
						        .enter().append("path")
						          .attr("d", path)
						          .style("fill", function(d){
						          	return "#f8b864" //colorMin(Number(d.properties.FacPercentMinority))
						          })
						          //.style({"stroke": "black", "stroke-width": ".5px"})
						    

						    var majWhiteSites = data.filter(function(d){return Number(d.FacPercentMinority) < 50})
						    //console.log(majWhiteSites)
						    var majWhite12SNC = majWhiteSites.filter(function(d){return Number(d.RCRAQtrsInSNC) > 0})
						    console.log(aboveMedianMinoritySites12SNC, majWhite12SNC)
						    var feats = [], buffs = []
						  	majWhite12SNC.forEach(function(d){
						  		feats.push(turf.point([Number(d.FacLong), Number(d.FacLat)], d))
						  	})
						    feats.forEach(function(d){
						    	var x = turf.circle(d, 3, 64, "miles")
						    	x.properties = d.properties
						    	x.properties.dissolve = "yes" 
						    	buffs.push(x)
						    })
						    var FC = turf.featureCollection(buffs)
						    var dissolved = turf.dissolve(FC, 'combine');
						    majWhiteBuffs.selectAll("path")
						        .data(buffs)
						        .enter().append("path")
						          .attr("d", path)
						          .style("fill", function(d){
						          	return colorMin(Number(d.properties.FacPercentMinority))
						          })
						          //.style({"stroke": "black", "stroke-width": ".5px"})



						    dump = data.map(function(d){return Number(d.RCRAQtrsInNC)})
						    
						    var max = d3.max(dump)
						    var min = d3.min(dump)
						    med = d3.median(dump)

						    var color = d3.scale.threshold()
						    .domain([.1, 3])
						    .range(["#3182bd", "#ffeda0", "#f03b20"])


						    var dump2 = data.map(function(d){return Number(d.FacPercentMinority)})
						    
						    var fmax = d3.max(dump2)
						    var fmin = d3.min(dump2)
						    var fmed = d3.median(dump2)
						    flanneryScale = d3.scale.sqrt()
						    .domain([0, calcFlanneryRadius(fmax)])
						    .range([1,12])

						 	var squares = data.filter(function(d){return d.SourceID == "CAD008302903" || d.SourceID == "CAD060398229" || d.SourceID == "CAD066233966"})
						    data = data.filter(function(d){return d.SourceID != "CAD008302903" && d.SourceID != "CAD060398229" && d.SourceID != "CAD066233966"})
						    data.sort(function(a,b){return a.RCRAQtrsInNC - b.RCRAQtrsInNC})

						    fac.selectAll("circle")
						      .data(featsMin)
						      .enter().append("circle").attr("class", "circle")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d.properties.SourceID})
						      //.style("fill", function(d){return color(d.properties.RCRAQtrsInNC)})
						      .style("fill-opacity",1)/* function (d){
						      	if (d.RCRAQtrsInNC > 0 && d.SourceID != "CAD008302903" && d.SourceID != "CAD060398229" && d.SourceID != "CAD066233966"){return .2}
						      	else if (importers.includes(d.SourceID)){return 1}
						      		else{return .1}
						     	
						      })*/
						      .style(defaultStroke)
						      .attr("r", 2)//function(d){return radiusFlannery(d.FacPercentMinority)})
						      .attr("cx", function(d) {return projection([d.properties.FacLong, d.properties.FacLat])[0]; })
						      .attr("cy", function(d) { return projection([d.properties.FacLong, d.properties.FacLat])[1]; })
						    //  .on("mouseover", function(d){console.log(d)})
						    whiteDot = svg.append('g')
						    whiteDot.selectAll("circle")
						      .data(feats)
						      .enter().append("circle").attr("class", "circle")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d.properties.SourceID})
						      //.style("fill", function(d){return color(d.properties.RCRAQtrsInNC)})
						      .style("fill-opacity",1)/* function (d){
						      	if (d.RCRAQtrsInNC > 0 && d.SourceID != "CAD008302903" && d.SourceID != "CAD060398229" && d.SourceID != "CAD066233966"){return .2}
						      	else if (importers.includes(d.SourceID)){return 1}
						      		else{return .1}
						     	
						      })*/
						      .style(defaultStroke)
						      .attr("r", 2)//function(d){return radiusFlannery(d.FacPercentMinority)})
						      .attr("cx", function(d) {return projection([d.properties.FacLong, d.properties.FacLat])[0]; })
						      .attr("cy", function(d) { return projection([d.properties.FacLong, d.properties.FacLat])[1]; })

						     
						     sq.selectAll("rect")
						      .data(squares)
						      .enter().append("rect").attr("class", "rect")
						      //.attr("class", function(d) {return d.id+" "+d.state+d.years+" "+d.name})
						      .attr("id", function(d){return d.SourceID})
						      .style("fill", function(d){return "red"})//color(d.RCRAQtrsInNC)})
						      .style("fill-opacity", 1)
						      .style(defaultStroke)
						      .attr("width", 12)
						      .attr("height", 12)
						      .attr("x", function(d) {return projection([d.FacLong, d.FacLat])[0] - 6}) //need to center
						      .attr("y", function(d) { return projection([d.FacLong, d.FacLat])[1] - 6 })
						      //.on("mouseover", function(d){console.log(d)})
						      
						
						  var stringwork2 = ["3 mile buffer around 'Large quantity generators' that have been in significant non-compliance within past 3 years"]
						  var circleData = [["In majority white areas - 1", "#3182bd"], ["In areas with minority population greater than county-wide rate (72.5%) - 30", "#f8b864"]]
						  //var circleSpot = [34, 53, 58, 34, 54, 57]

						 // var legendKey = ["Max Imports", "Mean Imports", "Min Imports","Max Exports", "Mean Exports", "Min Exports"]

							width100 = $(".leg").width()
							//height100=$(".map").height()
							var scalar = window.innerWidth < 500 ? 3 : 2 //scale based on screen size
							$(".leg").height(height100/scalar)
							d3.select(".leg").append("div")
								.attr("class", "legDiv")
								.style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
							leg = d3.selectAll(".legDiv").append("svg")
								.attr("id", "legSVG")
								.style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})

							 leg.selectAll("circle")
						      .data(circleData)
						      .enter()
						      .append("circle")
						      .style(defaultStroke)
						      //.attr("class", function(d) {return data.parent.name})
						      .style("fill", function(d){return d[1]})
						      .style("fill-opacity", 1)
						      .attr("r", 5)//function(d){return radiusFlannery(d[0])})
						      .attr("cy", function(d,i){
						      	return i*20+30
						      })
						      .attr("cx", 5+20)

						      
						     leg.selectAll("circletitle")
						      .data(["Large quantity generators in significant non-compliance over the past 3 years"])
						       .enter()
						       .append("text")
						       .text("3 mile buffer around 'Large quantity generators' that have been in significant non-compliance within past 3 years")
						       .attr("text-anchor", "right")
						       .attr("x", 16)
						       .attr("y", 15) // + height100/1.5
						       .attr("class", "legendTitle")


						     //here, replace circleData with biggest individual shipment
						     leg.selectAll("circletext")
						      .data(circleData)
						       .enter()
						       .append("text")
						       .text(function(d, i){return d[0]})
						       .attr("text-anchor", "right")
						       .attr("x", 15+20)
						       .attr("y",function(d,i){
						       	return i*20+34
						       })
						       .attr("class", "legendText")
						     
						     leg.selectAll('recto')
						     	.data([0]).enter().append("rect")
						     	.attr("width", 20)
						     	.attr("height", 20)
						     	.attr("x", 20)
						     	.attr('y', 115)
						     	.attr("fill", "red")
						     	.style(defaultStroke)
						    leg.selectAll('rectoText')
						     	.data([0]).enter().append("text")
						     	.text("Hazardous waste importers")
						     	.attr("x", 20)
						     	.attr('y', 105)
						     	.attr("text-anchor", "right")
						     	.attr("class", "legendTitle")

/*
						     leg.selectAll("circlelines")
						     	.data(circleData)
						     	.enter()
						     	.append("line")          // attach a line
							    .style("stroke", "black")  // colour the line
							    .attr("x1", radiusFlannery(globalMax)+20)     // x position of the first end of the line
							    .attr("y1",  function(d,i){
							      	//y position should be function of largest radius
							      	return yScalar(d,i)
						      	})    // y position of the first end of the line
							    .attr("x2", radiusFlannery(globalMax)*2+20)     // x position of the second end of the line
							    .attr("y2", function(d,i){
							      	return yScalar(d,i)
						      	})*/ //y position of the second end of the line*/

						  
						})

						NProgress.done()
						};



						//various helper functions here: calculating flannery's compensation, and svg z-indexing.

						d3.select('#dl').on('click', function() {
					      var config = {
					        filename: 'mapSVG',
					      }
					      d3_save_svg.save(d3.select('svg').node(), config);
					    });
					    d3.select('#dl2').on('click', function() {
					      var config2 = {
					        filename: 'legSVG',
					      }
					      d3_save_svg.save(d3.select('#legSVG').node(), config2);
					    });

						//flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
						var calcFlanneryRadius = function(x, max) {
						  // Flannery Compensation formula as described here:
						  //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
						  // log x * 0.57
						  // anti log
						  var flannery = 0.57;
						  var log = Math.log(x);
						  var r = log * flannery;
						  r = Math.exp(r);
						  return (r);
						};

						var radiusFlannery = function(x) {
						  return flanneryScale(calcFlanneryRadius(x));
						};

						
						var handle = $( "#custom-handle" );
					    $( "#slider" ).slider({
					   		min: 0,
					      max: 100,
					      value: 100,
					      create: function() {
					        handle.text( $( this ).slider( "value" ) );
					      },
					      slide: function( event, ui ) {
					        handle.text( ui.value );
					        console.log(pathArcs)
					       // svg.selectAll(".arc").style("stroke-opacity", ui.value/100)
					        //change other things here
					      }
					    });
					    /*var handleW = $( "#custom-handleW" );
					    $( "#sliderW" ).slider({
					   		min: 1,
					      max: 12,
					      value: 6,
					      create: function() {
					        handleW.text( $( this ).slider( "value" ) );
					      },
					      slide: function( event, ui ) {
					        handleW.text( ui.value );
					        svg.selectAll(".arc").style("stroke-width", ui.value)
					        //change other things here
					      }
					    });*/

					</script>

	</body>


</html>
