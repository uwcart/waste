<!DOCTYPE html>
<meta charset="utf-8">
<style>

circle.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

line.link {
	stroke:grey;
  stroke-opacity: .6;
}

.nodetext {pointer-events: none;}

</style>
<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
      	<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Doppio+One" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Who Trades with Whom?</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
			<script type="text/javascript" src="lib/d3-save-svg.min.js"></script>


</head>
<body>
	<p><input id="dl"
			      name="downloadButton"
			      type="button"
			      value="Download SVG" />

		<div class="container"  id="trades-image">
				<script>
					var graph;
					var vis;
					var tooltip = d3.tip()
					  .attr('class', 'd3-tip')
					  .offset([-5, 0])
					  .html(function(d) {
					    return "<span style='color:white'>" + d.source.name + " sent "+ d.value + " shipments to "+ d.target.name +"</span>";
					  })

					var h = window.innerHeight,
						w = window.innerWidth,
					    fill = d3.scale.category20();

					vis = d3.select(".container")
					  .append("svg:svg")
					    .attr("width", w)
					    .attr("id","old")
					    .attr("height", h)
					    .attr("pointer-events", "all")
					  .append('svg:g')
					    .call(d3.behavior.zoom().on("zoom", redraw))
					  .append('svg:g');

					  vis.append('svg:rect')
					    .attr('width', w)
					    .attr('height', h)
					    .attr('fill', 'white');

					vis.call(tooltip)

					function redraw() {
					  //console.log("here", d3.event.translate, d3.event.scale);
					  vis.attr("transform",
					      "translate(" + d3.event.translate + ")"
					      + " scale(" + d3.event.scale + ")");
					}
					//here: load raw data. count each time a node is in either export or import column

					var file="data/trades11-12.json";


					d3.json(file, function(json) {

					  var force = d3.layout.force()
					      .charge(-300)
					      .linkDistance(150)
					      .nodes(json.nodes)
					      .links(json.links)
					      .size([w, h])
					      .start();

					  var link = vis.selectAll("line.link")
					      .data(json.links)
					    .enter().append("svg:line")
					      .attr("class", "link")
					      .style("stroke-width", 1)
					      .attr("x1", function(d) { return d.source.x; })
					      .attr("y1", function(d) { return d.source.y; })
					      .attr("x2", function(d) { return d.target.x; })
					      .attr("y2", function(d) { return d.target.y; })
					      .on("mouseover", function(d){tooltip.show(d)})
					      .on('mouseout', function(d){tooltip.hide(d)})

					   var key = {}, dump=[], counter = 0

					   d3.csv("data/2011-2012 trades.csv", function(allData){


				    	json.nodes.forEach(function(d){
				    		var nom = d.name
				    		counter = 0
				    		allData.forEach(function(shipment){
							  	if (nom == shipment.exporter || nom == shipment.importer){
							  		counter += 1
							  	}
				  			})
				  			dump.push(counter)
				  			key[nom] = counter
					    })
					 	var sum = allData.length
					  var max = d3.max(dump)
					  var min = d3.min(dump)
					  var median = d3.median(dump)
					  var mean = d3.mean(dump)
					  var scale = d3.scale.sqrt().range([1,30]).domain([min, max])
					  
					  var node = vis.selectAll("g.node")
					      .data(json.nodes)
					    .enter().append("svg:g")
					      .attr("class", "node")
					  	node.append("svg:circle")
					      .attr("r", function(d) {
					      	var nom = d.name
					      	var total = key[nom]
					      	console.log(nom, total, scale(total))
					      	return scale(total)
					      	//Math.sqrt(d.weight)
					      })
					      .style("fill", function(d) {return fill(d.group); })
					      .call(force.drag)

					  node.append("svg:text")
					    .attr("class", "nodetext")
					    .attr("dx", 0)
						.attr("dy", 0)
						.style("font-size", function(d){
							var size = Math.sqrt(key[d.name])*2
							if (size > 50){console.log(d.name); return size*2+"%"} else {return 0}
						 	}) //(75/d.weight)
						.text(function(d) { return prettify(d.name); })


					  /* var tri = vis.selectAll("line.tri")
					      .data(json.links)
					    .enter().append("svg:rect")
					      .attr("class", "tri")
					      .style("fill", "black")
					      .attr("x", function(d) { return d.target.x; })
					      .attr("y", function(d) { return d.target.y; })
					      .attr("width", 3)
					      .attr("height", 3)*/

					  force.on("tick", function() {
					    link.attr("x1", function(d) { return d.source.x; })
					        .attr("y1", function(d) { return d.source.y; })
					        .attr("x2", function(d) { return d.target.x; })
					        .attr("y2", function(d) { return d.target.y; });

					    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

					   // tri.attr("x", function(d) { return d.target.x; })
					   // tri.attr("y", function(d) { return d.target.y; });
					  graph = json;
					  });
					});
					});
					function prettify (d){
					  d  = d.length > 50 ? d.slice(0,47)+"..." : d
					  return d
					}
					d3.select('#dl').on('click', function() {
					      var config = {
					        filename: 'SVG',
					      }
					      d3_save_svg.save(d3.select('#old').node(), config);
					    });

				</script>
			</div>
		</div>


	</body>


</html>
