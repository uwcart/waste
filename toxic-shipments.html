<!DOCTYPE HTML>
<html lang="en">

	<head>
			<!-- <link href='https://fonts.googleapis.com/css?family=Ruda:400,700|Cantarell:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
			<!-- <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'> -->
				<link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">
				<link href="https://fonts.googleapis.com/css?family=Doppio+One" rel="stylesheet">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1"/>
			<meta name="keywords" content="maps,cartography, hazardous waste trade"/>
			<title>Toxic Shipments</title>

			<!--put Bootstrap stylesheet links above style.css-->
			<link rel="stylesheet" href="CSS/bootstrap.min.css">
			<link rel="stylesheet" href="CSS/bootstrap-theme.min.css">
			<link rel="stylesheet" href="CSS/style.css">
			<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
			<script type="text/javascript" src="lib/bootstrap.min.js"></script>
			<script type="text/javascript" src="lib/d3.js" charset="utf-8"></script>
			<script type="text/javascript" src="lib/queue.js"></script>
			<script type="text/javascript" src="lib/topojson.v1.min.js"></script>
			<script type="text/javascript" src="lib/tip.js"></script>
      <script src='lib/nprogress.js'></script>
      <link rel='stylesheet' href='CSS/nprogress.css'/>
      <script src="lib/w3HTMLinclude.js"></script>

  </head>

  <body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87476640-1', 'auto');
  ga('send', 'pageview');

</script>
  <div w3-include-html="nav.html"></div>
  <script>
  w3IncludeHTML();
  </script>

	<div class="center">
		<div class="jumbotron">
				<div class="container">
						<h1>What Portion of the Hazardous Waste Trade<br>is in Toxic and Dangerous Material?</h1>
				</div>
		</div>
	</div>

		<div class="container">
			<div class="text">
				<div class="col-md-12" id = "bodyText"><h4>What percent of materials are toxic?</h4>
			<h5>The data for this map comes from EPA's <a href="https://www.epa.gov/toxics-release-inventory-tri-program/tri-chemical-hazard-information-profiles" target="_blank">Chemical Hazard Information Profiles (CHIP)</a>. A material is considered <div class="definition" style="cursor:help">cancer-causing<span class="tooltiptext">A substance that can cause cancer by distruping cellular processes</span></div>, environmentally degrading, or a workplace hazard if it has been listed on the <div class="definition" style="cursor:help">Toxic Release Inventory<span class="tooltiptext">"A resource for learning about toxic chemical releases and pollution prevention activities reported by industrial and federal facilities. TRI data support informed decision-making by communities, government agencies, companies, and others."-EPA</span></div> list as such. For carcinogens, we also consider placement on the National Toxicology Program list as a known or "reasonably anticipated" <div class="definition" style="cursor:help">carcinogen<span class="tooltiptext">Cancer-causing substances</span></div>. Percentages are calculated as proportion of import shipments that contained a toxic. Note: this map only shows solid hazardous waste. <a href="mercury-flow-map.html">Waste mercury</a> also accounts for some of these shipments. Please note that other wastes from our dataset may belong to these categories, but we were only able to classify them based on the descriptions provided on the manifest. For example, spelling errors on the manifest, translated over to our data, affect the results. <br><br><br>
			</h5></div>
		</div><br><br>
			<div class="col-md-8"></div>
      <div class="col-md-4"></div>
		</div>
		<div class="container"><br>
<div class="col-md-12" id = "bodyText">
          <div class="btn-group" data-toggle="buttons" id="selector">
            <label class="btn btn-primary active" onClick="setData('calcCancer')"  value="calcCancer" >
            <input type="radio" checked> Cancer-causing
          </label>
          <label class="btn btn-primary" onClick="setData('calcEnv')" value="calcEnv">
            <input type="radio" > Environmentally toxic
          </label>
          <label class="btn btn-primary" onClick="setData('calcOSHA')" value="calcOSHA">
            <input type="radio"  > Workplace hazards
          </label>
				  </div>
          <script>
        </script>

</div>
		<br><br><br><br>

		</div>
<script>
            //global variables
            var svg, zoomer, path, projection, width100, height100, globalMin, globalMax, arcGroup, exGlobalMin, exGlobalMax, circleMax
            var defaultColor = "#D1D3D4", exDefaultColor = "#4D4D4F"
              var defaultStroke = {"stroke": "#262626", "opacity": 1}
            var u, b, imp, exp;
            var tooltip = d3.tip()
              .attr('class', 'd3-tip')
              .offset([-5, 0])
              .html(function(d) {
                return "<span style='color:white'>" + d.namer + "</span>";
              })
            var flanneryScale;
            var importers
            var format = d3.format(".4r")
            //scale stuff
            var smallCircle = window.innerWidth < 500 ? 4 : 8
            var bigCircle = window.innerWidth < 500 ? 16 : 32
            var mapScalar = window.innerWidth < 500 ? .9 : 1.4
            var circleData = [[globalMax, defaultColor], [globalMin, defaultColor], [exGlobalMax, exDefaultColor], [exGlobalMin, exDefaultColor]]
            // var stringwork2 = ["Shipments"]

            //begin script when window loads
            initialize();

            //the first function called once the html is loaded
            function initialize(){

              height100 =  window.innerHeight/1.5
              $(".col-md-8").height(height100)
              width100 = $(".col-md-8").width()

              svg = d3.select(".col-md-8").append("svg")
                .attr("id", "mapSVG")
                .attr("height", height100)
              .attr("width", width100)
              .attr("position", "absolute")
              //.style({"height": height100, "width": width100, "position": "absolute"})

              //create map projection
              projection = d3.geo.albers()
              .center([2,38])
              .scale(height100*mapScalar)
              .translate([(width100)/2, (height100)/2]);

              function updateWindow(){
                y = window.innerHeight/2
                x = $(".col-md-8").width()
                svg.style({"width": x, "height": y});
              }
              window.onresize = updateWindow;

              path = d3.geo.path()
                .projection(projection);

              u = svg.append("g")
              b = svg.append("g")

              queue()
                .defer(d3.json, "data/na.json")
                .defer(d3.json, "data/borders.json")
                .await(callback);

                function callback(error, na, borders){
                  b.selectAll('path')
                    .data(topojson.feature(borders, borders.objects.borders).features)
                    .enter().append("path")
                      .attr("d", path)
                      .attr("class", "borders")


                  u.selectAll("path")
                    .data(topojson.feature(na, na.objects.na).features)
                    .enter().append("path")
                      .attr("d", path)
                      .attr("class", function (d){
                        return d.properties.gu_a3
                      })
                      .attr("id", function (d){
                        return d.properties.postal
                      })
                };
              setData('calcCancer');
            }

            function setData(view){
              NProgress.start()
              d3.selectAll("circle, text, line").remove()
d3.csv("data/us-importers-data.csv", function(data) {
  data.forEach(function(d){
    d.totalQuantityinShipment = +d.totalQuantityinShipment // convert the quantity of waste from string to number
    d.exporterLAT = +d.exporterLAT
    d.exporterLONG = +d.exporterLONG
    d.receivingLat = +d.latitude
    d.receivingLong = +d.longitude
    d.receivingFacilityZipCode = +d.receivingfacilityzipcode
  });



    data = data.filter(function(row){
      return row["fullDescription"].toLowerCase().includes("solid") || row["hazWasteDesc"].toLowerCase().includes("solid") || (row["units_final"] == "kg" && row["hazWasteDesc"].toLowerCase().indexOf("liquid") == -1)
    })


  UNtypeKey={}
  data.forEach(function(d) {
    UNtypeKey[d.un] = d.hazWasteDesc;
  });

  mgmtTypeKey={}
  data.forEach(function(d) {
    mgmtTypeKey[d.mgmt] = d.ExpectedManagementMethod;
  });

  siteKey={}
  data.forEach(function(d) {
    siteKey[d.ReceivingFacilityEPAIDNumber] = d.importer_name;
    siteKey[d.exporter_key] = d.exporter_name;
  });


  var facilitySum = d3.nest()
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .rollup(function(leaves) { return {"total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
  .map(data); //.entries(data)

  var key = d3.keys(facilitySum)
  var importers = facilitySum

  siteCount = d3.nest()
  .key(function(d) { return d.importer_state }) // switch
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber})
  .rollup(function(leaves) { return  d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}) }) //
  .map(data);

  var typeByFacility = d3.nest() //could cut for fly filter calc of types per facility
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // switch
  .key(function(d) { return d.fullDescription; })
  .rollup(function(leaves) { return  d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}) }) //
  .map(data);

  var typeOverall = d3.nest()
  .key(function(d) { return d.hazWasteDesc; })
  .rollup(function(leaves) {
    var x = d3.nest()
    .key(function(e){return e.ReceivingFacilityEPAIDNumber })
    .key(function(e){return e.mgmt })
    .rollup(function(leaves){return d3.sum(leaves, function(d){return d.totalQuantityinShipment})})
    .map(leaves)//leaves.map(function(d){ return d.ReceivingFacilityEPAIDNumber});
    //console.log(x);
    return {"name": leaves[0].hazWasteDesc, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}), "sites":  d3.keys(x), "sitesTotals": x } }) //
  .map(data);

  var quantByExporter =d3.nest() //calculate for each importer, how much each exporter ships
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .key(function(d) { return d.exporter_key})
  .rollup(function(leaves) {return {"name": leaves[0].exporter_key, "lat": leaves[0].exporterLAT, "long": leaves[0].exporterLONG, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;})} }) //
  .map(data);

  var quantByExporterMans =d3.nest() //calculate for each importer, how much each exporter ships
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .key(function(d) { return d.exporter_key})
  .rollup(function(leaves) {
    var x = d3.nest()
    .key(function(e){return e.rcra })
    .map(leaves)
    return {"name": leaves[0].exporter_key, "lat": leaves[0].exporterLAT, "long": leaves[0].exporterLONG, "total_waste": leaves.length}
  }) //
  .map(data);


  var importByYearMans =d3.nest() //calculate for each importer, how much they get per year
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  .key(function(d) { return d.fullDescription})
  .rollup(function(leaves) {return leaves.length})
  .map(data);
 // if (firstTime) {flowByYearGlobal.importer.Solids = importByYear}
  //if (liquidChecker) {flowByYearGlobal.importer.Liquids = importByYear}

/*  var methByFacility = d3.nest() //could cut if can filter by meth....
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  //.key(function(d) { return d.hazWasteDesc; })
  .key(function(d) { return d.mgmt; })
  .rollup(function(leaves) { return d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}) }) //
  .map(data);*/

  var meth = d3.nest() //organize methods -> sites and total
  .key(function(d) { return d.mgmt; })
  .rollup(function(leaves) {
    var x = d3.nest()
    .key(function(e){return e.ReceivingFacilityEPAIDNumber })
    .rollup(function(leaves){return d3.sum(leaves, function(d){return d.totalQuantityinShipment})})
    .map(leaves)//leaves.map(function(d){ return d.ReceivingFacilityEPAIDNumber});
    //console.log(x);
    return {"name": leaves[0].mgmt, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}), "sites":  d3.keys(x), "sitesTotals": x } }) //
  .map(data);


    /*var typeOverall = d3.nest()
  .key(function(d) { return d.hazWasteDesc; })
  .rollup(function(leaves) {
    var x = d3.nest()
    .key(function(e){return e.ReceivingFacilityEPAIDNumber })
    .key(function(e){return e.mgmt })
    .rollup(function(leaves){return d3.sum(leaves, function(d){return d.totalQuantityinShipment})})
    .map(leaves)//leaves.map(function(d){ return d.ReceivingFacilityEPAIDNumber});
    //console.log(x);
    return {"name": leaves[0].hazWasteDesc, "total_waste": d3.sum(leaves, function(d) {return d.totalQuantityinShipment;}), "sites":  d3.keys(x), "sitesTotals": x } }) //
  .map(data);
*/


  var facilityDetails = d3.nest()
  .key(function(d) { return d.ReceivingFacilityEPAIDNumber; }) // EPA ID number
  //.rollup(function(leaves) { return {"total_waste": d3.count(leaves, function(d) {return d.totalQuantityinShipment;})} }) // sum by receiving facility code
  .map(data); //.entries(data)




    d3.json("data/chip.json", function(d){
      var agents = d.filter(function(e){if (view == "calcCancer"){return e[view] || e['calcNTPCancer']}else{return e[view]}})
      agents = agents.map(function(p){return p.ChemnameMod})
      var details = ["importer_address","importer_city","importer_name","importer_state","latitude","longitude", "ReceivingFacilityEPAIDNumber"]

          //append type by facility to main object
          key.forEach(function(d){
            importers[d]["name"] = facilityDetails[d][0]["ReceivingFacilityEPAIDNumber"] //additional naming variable for compatibility in icicle
            //importers[d]["types"] = typeByFacility[d]
            importers[d]["total_shipments"] = d3.sum(d3.values(importByYearMans[d]))
            importers[d]["shipments"] = importByYearMans[d]
            details.forEach(function(e){
              importers[d][e] = facilityDetails[d][0][e]
            })
            var types = d3.keys(importers[d]["shipments"])
            importers[d][view] = {}
            types.forEach(function(t){ //for each type imported...
              agents.forEach(function(c){ //check each cancer causing agent
                //console.log(c,t)
                if (t.includes(c)){ //if the full description includes the cancer agent
                  importers[d][view][t] = importers[d]["shipments"][t]
                }
              })
            })
            importers[d][view] = (d3.sum(d3.values(importers[d][view]))/importers[d]["total_shipments"]) * 100
          })

          //for each importer look at descriptions. is in chem database as chron on cancer, cancer, env, etc. if yes, add percent

          importers = d3.values(importers) //no longer need to be able to easily pop to importers
          importers.sort(function(a,b){return b[view]-a[view]})
          console.log(importers)

      var totals = importers.map(function(d){return d[view]})
      totals = totals.filter(function(d){return d > 0})
      importers = importers.filter(function(d){return d[view] >0}) //show only those greater than 0

            //set importers
        max = d3.max(totals), min = d3.min(totals), mean = d3.mean(totals)
       console.log(totals)
       shipsArray = [max, mean, min]
        var flanMax = calcFlanneryRadius(max);
        var flanMin = calcFlanneryRadius(min);

        flanneryScale = d3.scale.linear().domain([flanMin, flanMax]).range([smallCircle, bigCircle]);

        var explanation={"calcCancer": "cancer-causing material", "calcEnv": "environmentally toxic substances", "calcOSHA": "workplace hazards"}
        tooltip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-5, 0])
        .html(function(d) {
          return "<span style='color:white'>" + siteKey[d.name] + ": "+format(d[view])+"% of shipments contained "+explanation[view]+"</span>";
        })

        svg.call(tooltip)

        imp = svg.append("g")
        imp.selectAll("circle")
          .data(importers)
          .enter().append("circle")
          .attr("class", function(d) {return d.ReceivingFacilityEPAIDNumber+" "+d.state+d.years+" "+d.importer_name+" circleOnMap circle"})
          .attr("id", "importer")
          .style("fill", defaultColor)
          .style(defaultStroke)
          .attr("cx", function(d) {return projection([d.longitude, d.latitude])[0]; })
          .attr("cy", function(d) { return projection([d.longitude, d.latitude])[1]; })
          //.attr("id", function(d){return data.state})
          .on("mouseover", function(d){
            tooltip.show(d);
            highlight(d);
          })
          .on("mouseout", function(d){
            tooltip.hide(d);
            dehighlight(d);
            //drawLinesOut(d);
          })
        imp.selectAll("circle")
          .transition()
          .duration(1000)
          .attr("r", function(d) {
           return radiusFlannery(d[view])
          })


          width100 = $(".col-md-4").width()
          //height100=$(".map").height()
          var scalar = window.innerWidth < 500 ? 3 : 2 //scale based on screen size
          $(".col-md-4").height(height100/scalar)
          d3.select(".col-md-4").append("div")
            .attr("class", "legDiv")
            .style({"width": width100, "height": (height100/scalar)+"px", "position": "absolute"})
          var leg = d3.selectAll(".legDiv").append("svg")
          .attr("id", "legSVG")
          .style({"width": width100, "height": (height100/scalar)+"px","position": "absolute"})



         leg.selectAll("legcircle")
            .data(shipsArray)
            .enter()
            .append("circle")
            .style(defaultStroke)
            //.attr("class", function(d) {return data.parent.name})
            .style("fill", 'none')
            .attr("r", function(d){return radiusFlannery(d)})
            .attr("cy", function(d,i){
              //y position should be function of largest radius
              var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
              var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d)
              var position = i == 0 ? def : otherCirclesPosition
              return position
            })
            .attr("cx", radiusFlannery(shipsArray[0])+16)
            function yScalar (d,i){
              var def = window.innerWidth < 500 ? 35 : 60 //scale based on screen size
              var otherCirclesPosition = def + radiusFlannery(max) - radiusFlannery(d)*2
              return otherCirclesPosition
            }
           leg.selectAll("circletitle")
            .data(["Percent of shipments"])
             .enter()
             .append("text")
             .text(function(d){return d})
             .attr("text-anchor", "right")
             .attr("x", 16)
             .attr("y", 10)
             .attr("class", "legendTitle")
           var legTitles = ["Max", "Mean", "Min"]
           leg.selectAll("circletext")
            .data(shipsArray)
             .enter()
             .append("text")
             .text(function(d, i){return legTitles[i]+": "+format(d)+" %"})
             .attr("text-anchor", "right")
             .attr("x", radiusFlannery(max)*2+20)
             .attr("y",function(d,i){return yScalar(d,i)})
             .attr("class", "legendText")
           leg.selectAll("circlelines")
            .data(shipsArray)
            .enter()
            .append("line")          // attach a line
            .style("stroke", "black")  // colour the line
            .attr("x1", radiusFlannery(max)+16)     // x position of the first end of the line
            .attr("y1",  function(d,i){
                //y position should be function of largest radius
                return yScalar(d,i)
              })    // y position of the first end of the line
            .attr("x2", radiusFlannery(max) * 2 +18)     // x position of the second end of the line
            .attr("y2", function(d,i){
                return yScalar(d,i)
              }) //y position of the second end of the line


    })

  });
NProgress.done()
}


            function highlight(data){
              svg.selectAll(".circle")
                .transition().duration(500)
                .style({"opacity": ".2"})
              svg.selectAll("."+data.ReceivingFacilityEPAIDNumber)
                .transition().duration(500)
                .style({"opacity": "1"})
            }

            function dehighlight(data){
              svg.selectAll(".circle")
                .transition().duration(500)
                .style({"opacity": "1"})
            };


            //various helper functions here: calculating flannery's compensation, and svg z-indexing.
            //flannery compensation for circles. modified from here: http://codepen.io/mxfh/pen/pggXoW
            var calcFlanneryRadius = function(x, max) {
              // Flannery Compensation formula as described here:
              //http://www.scribd.com/doc/33408233/SUG243-Cartography-Proportional-Symbol#scribd
              // log x * 0.57
              // anti log
              var flannery = 0.57;
              var log = Math.log(x);
              var r = log * flannery;
              r = Math.exp(r);
              return (r);
            };

            var radiusFlannery = function(x) {
              return flanneryScale(calcFlanneryRadius(x));
            };
          </script>

					<!-- start dangerous materials section -->
					<div class="container">
						<div class="col-md-12" id = "bodyText"><h4>What percent of materials are dangerous?</h4>

							<div class="text">
							<h5>Hazardous waste shipments are given a "packing group" number to identify the hazard level of the materials being transported. Packing group values are either I, II, or III, with I being the most dangerous. This map shows the hazard level for United States imports in our dataset. Some sites had materials with no packing group value specified or the packing group value was illegible. These are indicated with an 'x' on the map. You can learn more about packing group assignments <a href="https://www.law.cornell.edu/cfr/text/49/part-173/subpart-D" target="blank">here</a>. Please note that Class 1 does not mean packing group I.
							</h5><br>
							</div>
						</div>
					</div>
					<div class="col-md-12"><img src="img/pg.png" id="mercuryMap" alt="Mercury Waste Flow Map"/></div>
					<div class="">
						<h4>&nbsp;</h4>
					</div>

					<div class="container">
						<h4>Continue to next story:</h4>
						<div class="row">
							<div class="col-md-3">
									<div class="thumbnail portfolio-thumbnail center-block" id = "image">
											<a href = "mercury-flow-map.html"><img src="img/mercury-01.png"
											alt="Toxic Shipments"/>
											<p class = "imgDescription">What does the mercury waste trade look like?</p>
											</a>
									</div>
							</div>
					</div>
					</div>

					<footer class="footer">
						<!-- <div class="container"> -->
							<div class="logos">
							<a href = "http://geography.wisc.edu" target="blank"><img src="img/uwgeog-01.png" alt="UW Geography Logo" hspace="10"></a>
							<a href = "https://www.nsf.gov/" target="blank"><img src="img/nsf-01-01.png" alt="NSF Logo" hspace="10"></a>
							<a href = "http://www.geography.wisc.edu/cartography/" target="blank"><img src="img/uwcart-01-01.png" alt="uwcart Logo" hspace="10"></a>
							</div>
						<!-- </div> -->
					</footer>
	</body>


</html>
